<!-- review-queue: Standalone flashcard review UI with SM-2 algorithm -->
<div id="review-queue" class="review-queue">
  <div class="review-auth" id="review-auth" style="display: none;">
    <div class="review-auth-card">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
      </svg>
      <h3>Sign in to review flashcards</h3>
      <p>Your flashcards and review progress are stored securely and require authentication.</p>
      <button type="button" class="review-signin-btn" id="review-signin">
        <svg width="18" height="18" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
        Sign in with Google
      </button>
    </div>
  </div>

  <div class="review-loading" id="review-loading" style="display: none;">
    <div class="review-spinner"></div>
    <p>Loading flashcards...</p>
  </div>

  <div class="review-empty" id="review-empty" style="display: none;">
    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 18V5"></path>
      <path d="M15 13a4.17 4.17 0 0 1-3-4 4.17 4.17 0 0 1-3 4"></path>
      <path d="M17.598 6.5A3 3 0 1 0 12 5a3 3 0 1 0-5.598 1.5"></path>
      <path d="M17.997 5.125a4 4 0 0 1 2.526 5.77"></path>
      <path d="M18 18a4 4 0 0 0 2-7.464"></path>
      <path d="M19.967 17.483A4 4 0 1 1 12 18a4 4 0 1 1-7.967-.517"></path>
      <path d="M6 18a4 4 0 0 1-2-7.464"></path>
      <path d="M6.003 5.125a4 4 0 0 0-2.526 5.77"></path>
    </svg>
    <h3 id="review-empty-title">No flashcards yet</h3>
    <p id="review-empty-msg">Create your first flashcard using the button below.</p>
  </div>

  <!-- Stats bar -->
  <div class="review-stats" id="review-stats" style="display: none;">
    <div class="review-stats-inner">
      <span class="review-stat">
        <span class="review-stat-value" id="review-due-count">0</span>
        <span class="review-stat-label">due now</span>
      </span>
      <span class="review-stat">
        <span class="review-stat-value" id="review-total-count">0</span>
        <span class="review-stat-label">total cards</span>
      </span>
      <span class="review-stat">
        <span class="review-stat-value" id="review-reviewed-count">0</span>
        <span class="review-stat-label">reviewed today</span>
      </span>
    </div>
  </div>

  <!-- Flashcard -->
  <div class="review-card-container" id="review-card-container" style="display: none;">
    <div class="review-progress">
      <div class="review-progress-bar" id="review-progress-bar"></div>
    </div>
    <div class="review-card" id="review-card">
      <div class="review-card-front" id="review-card-front">
        <div class="review-card-meta" id="review-card-meta"></div>
        <div class="review-card-front-content markdown" id="review-card-front-content"></div>
        <div class="review-card-tags" id="review-card-tags"></div>
        <button type="button" class="review-reveal-btn" id="review-reveal-btn">
          Show Answer
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
        </button>
      </div>
      <div class="review-card-back" id="review-card-back" style="display: none;">
        <div class="review-card-back-content markdown" id="review-card-back-content"></div>
      </div>
    </div>

    <!-- Rating buttons -->
    <div class="review-rating" id="review-rating" style="display: none;">
      <p class="review-rating-prompt">How well did you know this?</p>
      <div class="review-rating-buttons">
        <button type="button" class="review-rate-btn review-rate-0" data-quality="0" title="Complete blackout">
          <span class="review-rate-num">0</span>
          <span class="review-rate-label">Blackout</span>
        </button>
        <button type="button" class="review-rate-btn review-rate-1" data-quality="1" title="Incorrect, but recognized on reveal">
          <span class="review-rate-num">1</span>
          <span class="review-rate-label">Wrong</span>
        </button>
        <button type="button" class="review-rate-btn review-rate-2" data-quality="2" title="Incorrect, but easy to recall on reveal">
          <span class="review-rate-num">2</span>
          <span class="review-rate-label">Hard</span>
        </button>
        <button type="button" class="review-rate-btn review-rate-3" data-quality="3" title="Correct with serious difficulty">
          <span class="review-rate-num">3</span>
          <span class="review-rate-label">Difficult</span>
        </button>
        <button type="button" class="review-rate-btn review-rate-4" data-quality="4" title="Correct with some hesitation">
          <span class="review-rate-num">4</span>
          <span class="review-rate-label">Good</span>
        </button>
        <button type="button" class="review-rate-btn review-rate-5" data-quality="5" title="Perfect recall">
          <span class="review-rate-num">5</span>
          <span class="review-rate-label">Perfect</span>
        </button>
      </div>
    </div>

    <!-- Next review info (shown after rating) -->
    <div class="review-result" id="review-result" style="display: none;">
      <p class="review-result-text" id="review-result-text"></p>
      <button type="button" class="review-next-btn" id="review-next-btn">Next Card</button>
    </div>
  </div>

  <!-- New card form -->
  <div class="review-form-section" id="review-form-section">
    <button type="button" class="review-new-btn" id="review-new-btn" style="display: none;">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
      New Flashcard
    </button>
    <div class="review-form" id="review-form" style="display: none;">
      <div class="review-form-field">
        <label for="review-form-front">Front (question/prompt)</label>
        <textarea id="review-form-front" rows="3" placeholder="What is the question or prompt?"></textarea>
      </div>
      <div class="review-form-field">
        <label for="review-form-back">Back (answer)</label>
        <textarea id="review-form-back" rows="4" placeholder="What is the answer?"></textarea>
      </div>
      <div class="review-form-field">
        <label for="review-form-tags">Tags (comma-separated, optional)</label>
        <input type="text" id="review-form-tags" placeholder="e.g. javascript, algorithms">
      </div>
      <div class="review-form-actions">
        <button type="button" class="review-form-save" id="review-form-save">Save Card</button>
        <button type="button" class="review-form-cancel" id="review-form-cancel">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Tag filter -->
  <div class="review-tag-filter" id="review-tag-filter" style="display: none;">
    <span class="review-tag-filter-label">Filter:</span>
    <div class="review-tag-filter-chips" id="review-tag-filter-chips"></div>
  </div>

  <!-- All cards list (schedule) -->
  <div class="review-schedule" id="review-schedule" style="display: none;">
    <div class="review-schedule-header">
      <h3 class="review-schedule-title">All Flashcards</h3>
      <button type="button" class="review-export-btn" id="review-export-btn" title="Export flashcards">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
      </button>
    </div>
    <div class="review-schedule-list" id="review-schedule-list"></div>
  </div>
</div>

<style>
.review-queue { max-width: 700px; margin: 0 auto; }

.review-auth, .review-loading, .review-empty {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 300px;
  text-align: center;
  color: var(--body-font-color);
}
.review-auth-card {
  padding: 2rem;
  border-radius: 12px;
  background: var(--body-background);
  border: 1px solid var(--gray-200);
  max-width: 400px;
}
.review-auth-card h3 { margin: 1rem 0 0.5rem; }
.review-auth-card p { color: var(--gray-500); margin-bottom: 1.5rem; }
.review-signin-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 24px;
  border: 1px solid var(--gray-300);
  border-radius: 8px;
  background: var(--body-background);
  color: var(--body-font-color);
  font-size: 14px;
  cursor: pointer;
  transition: background 0.2s, box-shadow 0.2s;
}
.review-signin-btn:hover { background: var(--gray-100); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

.review-loading { gap: 12px; color: var(--gray-500); }
.review-spinner {
  width: 24px; height: 24px;
  border: 2px solid var(--gray-200);
  border-top-color: var(--color-link);
  border-radius: 50%;
  animation: review-spin 0.8s linear infinite;
}
@keyframes review-spin { to { transform: rotate(360deg); } }

.review-empty svg { color: var(--gray-400); margin-bottom: 0.5rem; }
.review-empty h3 { margin: 0.5rem 0; }
.review-empty p { color: var(--gray-500); font-size: 0.9rem; max-width: 400px; }

/* Stats bar */
.review-stats {
  margin-bottom: 1.5rem;
  padding: 0.75rem 1rem;
  background: var(--gray-100);
  border-radius: 8px;
}
.review-stats-inner {
  display: flex;
  gap: 1.5rem;
  justify-content: center;
}
.review-stat {
  display: flex;
  align-items: baseline;
  gap: 0.35rem;
}
.review-stat-value {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--color-link);
}
.review-stat-label {
  font-size: 0.8rem;
  color: var(--gray-500);
}

/* Progress bar */
.review-progress {
  height: 4px;
  background: var(--gray-200);
  border-radius: 2px;
  margin-bottom: 1rem;
  overflow: hidden;
}
.review-progress-bar {
  height: 100%;
  background: var(--color-link);
  border-radius: 2px;
  transition: width 0.3s ease;
  width: 0%;
}

/* Flashcard */
.review-card {
  border: 1px solid var(--gray-200);
  border-radius: 12px;
  background: var(--body-background);
  overflow: hidden;
}
.review-card-front {
  padding: 2rem;
  text-align: center;
}
.review-card-meta {
  font-size: 0.75rem;
  color: var(--gray-500);
  margin-bottom: 0.5rem;
}
.review-card-front-content {
  font-size: 1.15rem;
  line-height: 1.6;
  margin: 0.5rem 0 1rem;
  color: var(--body-font-color);
}
.review-card-front-content p { margin: 0.5em 0; }
.review-card-front-content p:first-child { margin-top: 0; }
.review-card-front-content p:last-child { margin-bottom: 0; }
.review-card-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 0.35rem;
  justify-content: center;
  margin-bottom: 1.25rem;
}
.review-card-tag {
  background: var(--gray-100);
  color: var(--gray-600);
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 0.7rem;
}
.review-reveal-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 20px;
  border: 1px solid var(--color-link);
  border-radius: 6px;
  background: transparent;
  color: var(--color-link);
  font-size: 0.875rem;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.15s, color 0.15s;
}
.review-reveal-btn:hover {
  background: var(--color-link);
  color: #fff;
}

.review-card-back {
  border-top: 1px solid var(--gray-200);
  padding: 1.5rem 2rem;
  max-height: 500px;
  overflow-y: auto;
}
.review-card-back-content {
  font-size: 0.95rem;
  line-height: 1.6;
}

/* Rating buttons */
.review-rating {
  margin-top: 1.25rem;
  text-align: center;
}
.review-rating-prompt {
  font-size: 0.875rem;
  color: var(--gray-500);
  margin-bottom: 0.75rem;
}
.review-rating-buttons {
  display: flex;
  gap: 0.5rem;
  justify-content: center;
  flex-wrap: wrap;
}
.review-rate-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
  padding: 0.5rem 0.75rem;
  border: 1px solid var(--gray-300);
  border-radius: 8px;
  background: var(--body-background);
  cursor: pointer;
  transition: border-color 0.15s, background 0.15s, transform 0.1s;
  min-width: 62px;
}
.review-rate-btn:hover { transform: translateY(-2px); }
.review-rate-btn:active { transform: translateY(0); }
.review-rate-num {
  font-size: 1.1rem;
  font-weight: 700;
}
.review-rate-label {
  font-size: 0.65rem;
  color: var(--gray-500);
  text-transform: uppercase;
  letter-spacing: 0.03em;
}

/* Rating button colors */
.review-rate-0 { border-color: #dc2626; }
.review-rate-0:hover { background: rgba(220,38,38,0.08); }
.review-rate-0 .review-rate-num { color: #dc2626; }
.review-rate-1 { border-color: #ea580c; }
.review-rate-1:hover { background: rgba(234,88,12,0.08); }
.review-rate-1 .review-rate-num { color: #ea580c; }
.review-rate-2 { border-color: #d97706; }
.review-rate-2:hover { background: rgba(217,119,6,0.08); }
.review-rate-2 .review-rate-num { color: #d97706; }
.review-rate-3 { border-color: #ca8a04; }
.review-rate-3:hover { background: rgba(202,138,4,0.08); }
.review-rate-3 .review-rate-num { color: #ca8a04; }
.review-rate-4 { border-color: #16a34a; }
.review-rate-4:hover { background: rgba(22,163,74,0.08); }
.review-rate-4 .review-rate-num { color: #16a34a; }
.review-rate-5 { border-color: #2563eb; }
.review-rate-5:hover { background: rgba(37,99,235,0.08); }
.review-rate-5 .review-rate-num { color: #2563eb; }

/* Result after rating */
.review-result {
  margin-top: 1rem;
  text-align: center;
}
.review-result-text {
  font-size: 0.875rem;
  color: var(--gray-600);
  margin-bottom: 0.75rem;
}
.review-next-btn {
  padding: 8px 24px;
  border: none;
  border-radius: 6px;
  background: var(--color-link);
  color: #fff;
  font-size: 0.875rem;
  font-weight: 500;
  cursor: pointer;
  transition: opacity 0.15s;
}
.review-next-btn:hover { opacity: 0.85; }

/* New card form */
.review-form-section {
  margin-top: 1.5rem;
}
.review-new-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  border: 1px dashed var(--gray-300);
  border-radius: 8px;
  background: transparent;
  color: var(--color-link);
  font-size: 0.875rem;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.15s, border-color 0.15s;
  width: 100%;
  justify-content: center;
}
.review-new-btn:hover {
  background: var(--gray-100);
  border-color: var(--color-link);
}
.review-form {
  border: 1px solid var(--gray-200);
  border-radius: 10px;
  padding: 1.25rem;
  background: var(--body-background);
}
.review-form-field {
  margin-bottom: 1rem;
}
.review-form-field label {
  display: block;
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--gray-600);
  margin-bottom: 0.35rem;
}
.review-form-field textarea,
.review-form-field input {
  width: 100%;
  padding: 0.5rem 0.65rem;
  border: 1px solid var(--gray-300);
  border-radius: 6px;
  background: var(--body-background);
  color: var(--body-font-color);
  font-size: 0.875rem;
  font-family: inherit;
  resize: vertical;
  transition: border-color 0.15s;
  box-sizing: border-box;
}
.review-form-field textarea:focus,
.review-form-field input:focus {
  border-color: var(--color-link);
  outline: none;
}
.review-form-actions {
  display: flex;
  gap: 0.5rem;
  justify-content: flex-end;
}
.review-form-save {
  padding: 6px 18px;
  border: none;
  border-radius: 6px;
  background: var(--color-link);
  color: #fff;
  font-size: 0.85rem;
  font-weight: 500;
  cursor: pointer;
  transition: opacity 0.15s;
}
.review-form-save:hover { opacity: 0.85; }
.review-form-save:disabled { opacity: 0.5; cursor: not-allowed; }
.review-form-cancel {
  padding: 6px 18px;
  border: 1px solid var(--gray-300);
  border-radius: 6px;
  background: transparent;
  color: var(--body-font-color);
  font-size: 0.85rem;
  cursor: pointer;
  transition: background 0.15s;
}
.review-form-cancel:hover { background: var(--gray-100); }

/* Tag filter */
.review-tag-filter {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 1rem;
  flex-wrap: wrap;
}
.review-tag-filter-label {
  font-size: 0.8rem;
  color: var(--gray-500);
  font-weight: 500;
}
.review-tag-filter-chip {
  padding: 3px 10px;
  border-radius: 12px;
  font-size: 0.75rem;
  border: 1px solid var(--gray-300);
  background: transparent;
  color: var(--body-font-color);
  cursor: pointer;
  transition: background 0.15s, border-color 0.15s, color 0.15s;
}
.review-tag-filter-chip:hover { background: var(--gray-100); }
.review-tag-filter-chip.active {
  background: var(--color-link);
  border-color: var(--color-link);
  color: #fff;
}

/* Schedule list */
.review-schedule {
  margin-top: 1.5rem;
  border-top: 1px solid var(--gray-200);
  padding-top: 1.5rem;
}
.review-schedule-title {
  font-size: 1rem;
  font-weight: 600;
  margin: 0;
}
.review-schedule-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 1rem;
}
.review-export-btn {
  background: none;
  border: none;
  cursor: pointer;
  color: var(--gray-400);
  padding: 4px;
  border-radius: 6px;
  display: flex;
  align-items: center;
}
.review-export-btn:hover {
  color: var(--color-link);
  background: var(--gray-100);
}
.review-schedule-list {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}
.review-schedule-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.6rem 0.75rem;
  border: 1px solid var(--gray-200);
  border-radius: 8px;
  font-size: 0.85rem;
  color: var(--body-font-color);
  transition: background 0.15s;
}
.review-schedule-item:hover { background: var(--gray-100); }
.review-schedule-item-front {
  flex: 1;
  min-width: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-weight: 500;
}
.review-schedule-item-due {
  font-size: 0.75rem;
  color: var(--gray-500);
  white-space: nowrap;
}
.review-schedule-item-due.review-due-now {
  color: var(--color-link);
  font-weight: 600;
}
.review-schedule-item-ef {
  font-size: 0.7rem;
  color: var(--gray-400);
  white-space: nowrap;
}
.review-schedule-item-actions {
  display: flex;
  gap: 2px;
  opacity: 0;
  transition: opacity 0.15s;
}
.review-schedule-item:hover .review-schedule-item-actions { opacity: 1; }
.review-schedule-item-btn {
  background: none;
  border: none;
  color: var(--gray-400);
  cursor: pointer;
  padding: 2px;
  display: flex;
  transition: color 0.15s;
}
.review-schedule-item-btn:hover { color: var(--body-font-color); }
.review-schedule-item-btn.review-item-delete:hover { color: var(--color-danger, #ea4335); }

/* Inline edit form in schedule item */
.review-edit-form {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  min-width: 0;
}
.review-edit-form textarea {
  width: 100%;
  padding: 0.4rem 0.5rem;
  border: 1px solid var(--gray-300);
  border-radius: 4px;
  background: var(--body-background);
  color: var(--body-font-color);
  font-size: 0.82rem;
  font-family: inherit;
  resize: vertical;
  box-sizing: border-box;
}
.review-edit-form textarea:focus {
  border-color: var(--color-link);
  outline: none;
}
.review-edit-form-actions {
  display: flex;
  gap: 0.35rem;
  justify-content: flex-end;
}
.review-edit-form-actions button {
  padding: 3px 10px;
  border-radius: 4px;
  font-size: 0.75rem;
  cursor: pointer;
  transition: opacity 0.15s;
}
.review-edit-save {
  border: none;
  background: var(--color-link);
  color: #fff;
}
.review-edit-cancel {
  border: 1px solid var(--gray-300);
  background: transparent;
  color: var(--body-font-color);
}

@media (max-width: 600px) {
  .review-card-front { padding: 1.5rem 1rem; }
  .review-card-back { padding: 1rem; }
  .review-card-front-content { font-size: 1rem; }
  .review-rate-btn { min-width: 48px; padding: 0.4rem 0.5rem; }
  .review-stats-inner { gap: 1rem; }
}
</style>

<script>
(function() {
  'use strict';

  var authEl = document.getElementById('review-auth');
  var loadingEl = document.getElementById('review-loading');
  var emptyEl = document.getElementById('review-empty');
  var emptyTitleEl = document.getElementById('review-empty-title');
  var emptyMsgEl = document.getElementById('review-empty-msg');
  var statsEl = document.getElementById('review-stats');
  var dueCountEl = document.getElementById('review-due-count');
  var totalCountEl = document.getElementById('review-total-count');
  var reviewedCountEl = document.getElementById('review-reviewed-count');
  var cardContainerEl = document.getElementById('review-card-container');
  var cardFrontEl = document.getElementById('review-card-front');
  var cardBackEl = document.getElementById('review-card-back');
  var cardFrontContentEl = document.getElementById('review-card-front-content');
  var cardBackContentEl = document.getElementById('review-card-back-content');
  var cardMetaEl = document.getElementById('review-card-meta');
  var cardTagsEl = document.getElementById('review-card-tags');
  var revealBtn = document.getElementById('review-reveal-btn');
  var ratingEl = document.getElementById('review-rating');
  var resultEl = document.getElementById('review-result');
  var resultTextEl = document.getElementById('review-result-text');
  var nextBtn = document.getElementById('review-next-btn');
  var progressBar = document.getElementById('review-progress-bar');
  var scheduleEl = document.getElementById('review-schedule');
  var scheduleListEl = document.getElementById('review-schedule-list');
  var signinBtn = document.getElementById('review-signin');
  var newBtn = document.getElementById('review-new-btn');
  var formEl = document.getElementById('review-form');
  var formFrontEl = document.getElementById('review-form-front');
  var formBackEl = document.getElementById('review-form-back');
  var formTagsEl = document.getElementById('review-form-tags');
  var formSaveBtn = document.getElementById('review-form-save');
  var formCancelBtn = document.getElementById('review-form-cancel');
  var tagFilterEl = document.getElementById('review-tag-filter');
  var tagFilterChipsEl = document.getElementById('review-tag-filter-chips');

  if (!document.getElementById('review-queue')) return;

  var dueCards = [];
  var currentIndex = 0;
  var reviewedToday = 0;
  var allCards = [];
  var activeTagFilter = null;

  function showState(state) {
    authEl.style.display = state === 'auth' ? '' : 'none';
    loadingEl.style.display = state === 'loading' ? '' : 'none';
    emptyEl.style.display = state === 'empty' ? '' : 'none';
    statsEl.style.display = (state === 'review' || state === 'done') ? '' : 'none';
    cardContainerEl.style.display = state === 'review' ? '' : 'none';
    newBtn.style.display = (state !== 'auth' && state !== 'loading') ? '' : 'none';
  }

  function escapeHtml(str) {
    if (!str) return '';
    var div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function renderMarkdown(text) {
    if (typeof marked !== 'undefined') {
      return marked.parse(text || '');
    }
    return escapeHtml(text || '').replace(/\n/g, '<br>');
  }

  function formatRelativeDate(ms) {
    if (!ms) return 'never';
    var now = Date.now();
    var diff = ms - now;
    var days = Math.round(diff / 86400000);

    if (days < 0) {
      var absDays = Math.abs(days);
      if (absDays === 1) return '1 day overdue';
      return absDays + ' days overdue';
    }
    if (days === 0) return 'due now';
    if (days === 1) return 'tomorrow';
    if (days < 7) return 'in ' + days + ' days';
    if (days < 30) {
      var weeks = Math.round(days / 7);
      return 'in ' + weeks + ' week' + (weeks > 1 ? 's' : '');
    }
    var months = Math.round(days / 30);
    return 'in ' + months + ' month' + (months > 1 ? 's' : '');
  }

  function parseTags(str) {
    if (!str) return [];
    return str.split(',').map(function(t) { return t.trim(); }).filter(function(t) { return t.length > 0; });
  }

  function getFirstLine(text) {
    if (!text) return '';
    var line = text.split('\n')[0];
    // Strip markdown heading prefix
    line = line.replace(/^#+\s+/, '');
    return line.length > 80 ? line.substring(0, 80) + '...' : line;
  }

  function loadQueue() {
    if (!window.dmSync) {
      setTimeout(loadQueue, 100);
      return;
    }

    showState('loading');

    Promise.all([
      window.dmSync.getReviewCards(false), // all cards
      window.dmSync.getReviewCards(true)   // due cards only
    ]).then(function(results) {
      allCards = results[0];
      dueCards = results[1];

      // Count reviewed today
      var todayStart = new Date();
      todayStart.setHours(0, 0, 0, 0);
      reviewedToday = 0;
      allCards.forEach(function(c) {
        if (c.lastReviewedAt && c.lastReviewedAt >= todayStart.getTime()) {
          reviewedToday++;
        }
      });

      // Update stats
      dueCountEl.textContent = dueCards.length;
      totalCountEl.textContent = allCards.length;
      reviewedCountEl.textContent = reviewedToday;

      if (allCards.length === 0) {
        emptyTitleEl.textContent = 'No flashcards yet';
        emptyMsgEl.textContent = 'Create your first flashcard using the button below.';
        showState('empty');
        renderSchedule();
        renderTagFilter();
        return;
      }

      if (dueCards.length === 0) {
        emptyTitleEl.textContent = 'All caught up!';
        emptyMsgEl.textContent = 'No reviews due right now. Check back later.';
        showState('empty');
        renderSchedule();
        renderTagFilter();
        return;
      }

      currentIndex = 0;
      showState('review');
      showCard(dueCards[currentIndex]);
      renderSchedule();
      renderTagFilter();
    }).catch(function(err) {
      console.error('Error loading review queue:', err);
      showState('empty');
    });
  }

  function showCard(card) {
    if (!card) return;

    // Update progress
    var total = dueCards.length;
    var pct = total > 0 ? Math.round((currentIndex / total) * 100) : 0;
    progressBar.style.width = pct + '%';

    // Meta
    var metaParts = [];
    if (card.repetitions > 0) metaParts.push('Review #' + (card.repetitions + 1));
    metaParts.push('EF: ' + card.easeFactor.toFixed(2));
    cardMetaEl.textContent = metaParts.join(' \u00B7 ');

    // Front content (rendered as markdown)
    cardFrontContentEl.innerHTML = renderMarkdown(card.front);

    // Syntax highlighting on front
    cardFrontContentEl.querySelectorAll('pre code').forEach(function(block) {
      if (typeof hljs !== 'undefined') hljs.highlightElement(block);
    });

    // Tags
    cardTagsEl.innerHTML = '';
    if (card.tags && card.tags.length) {
      card.tags.forEach(function(tag) {
        var span = document.createElement('span');
        span.className = 'review-card-tag';
        span.textContent = tag;
        cardTagsEl.appendChild(span);
      });
    }

    // Reset state
    cardBackEl.style.display = 'none';
    ratingEl.style.display = 'none';
    resultEl.style.display = 'none';
    revealBtn.style.display = '';
    cardBackContentEl.innerHTML = '';
  }

  // Reveal answer
  revealBtn.addEventListener('click', function() {
    var card = dueCards[currentIndex];
    if (!card) return;

    cardBackContentEl.innerHTML = renderMarkdown(card.back);

    // Syntax highlighting
    cardBackContentEl.querySelectorAll('pre code').forEach(function(block) {
      if (typeof hljs !== 'undefined') hljs.highlightElement(block);
    });

    // Diagrams
    if (window.dmRenderDiagrams) window.dmRenderDiagrams(cardBackContentEl);

    cardBackEl.style.display = '';
    revealBtn.style.display = 'none';
    ratingEl.style.display = '';
  });

  // Rating buttons
  var rateButtons = document.querySelectorAll('.review-rate-btn');
  rateButtons.forEach(function(btn) {
    btn.addEventListener('click', function() {
      var quality = parseInt(btn.getAttribute('data-quality'), 10);
      var card = dueCards[currentIndex];
      if (!card) return;

      rateButtons.forEach(function(b) { b.disabled = true; });

      window.dmSync.reviewCard(card.id, quality).then(function(updatedCard) {
        ratingEl.style.display = 'none';

        var nextLabel = formatRelativeDate(updatedCard.nextReviewAt);
        resultTextEl.textContent = 'Next review: ' + nextLabel + ' (interval: ' + updatedCard.interval + ' day' + (updatedCard.interval !== 1 ? 's' : '') + ')';
        resultEl.style.display = '';

        reviewedToday++;
        reviewedCountEl.textContent = reviewedToday;
        dueCountEl.textContent = Math.max(0, dueCards.length - currentIndex - 1);

        rateButtons.forEach(function(b) { b.disabled = false; });

        if (currentIndex >= dueCards.length - 1) {
          nextBtn.textContent = 'Done';
        }
      }).catch(function(err) {
        console.error('Error submitting review:', err);
        rateButtons.forEach(function(b) { b.disabled = false; });
      });
    });
  });

  // Next card button
  nextBtn.addEventListener('click', function() {
    currentIndex++;
    if (currentIndex >= dueCards.length) {
      loadQueue();
    } else {
      showCard(dueCards[currentIndex]);
      var pct = Math.round((currentIndex / dueCards.length) * 100);
      progressBar.style.width = pct + '%';
    }
  });

  // Keyboard shortcuts
  document.addEventListener('keydown', function(e) {
    if (cardContainerEl.style.display === 'none') return;
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) return;

    if (e.key === ' ' && revealBtn.style.display !== 'none') {
      e.preventDefault();
      revealBtn.click();
      return;
    }

    if (ratingEl.style.display !== 'none' && e.key >= '0' && e.key <= '5') {
      var q = parseInt(e.key, 10);
      var matchBtn = document.querySelector('.review-rate-btn[data-quality="' + q + '"]');
      if (matchBtn && !matchBtn.disabled) matchBtn.click();
      return;
    }

    if (resultEl.style.display !== 'none' && (e.key === 'Enter' || e.key === ' ')) {
      e.preventDefault();
      nextBtn.click();
    }
  });

  // ---- New Card Form ----

  newBtn.addEventListener('click', function() {
    formEl.style.display = '';
    newBtn.style.display = 'none';
    formFrontEl.value = '';
    formBackEl.value = '';
    formTagsEl.value = '';
    formFrontEl.focus();
  });

  formCancelBtn.addEventListener('click', function() {
    formEl.style.display = 'none';
    newBtn.style.display = '';
  });

  formSaveBtn.addEventListener('click', function() {
    var front = formFrontEl.value.trim();
    var back = formBackEl.value.trim();
    if (!front || !back) return;

    var tags = parseTags(formTagsEl.value);
    formSaveBtn.disabled = true;

    window.dmSync.createReviewCard(front, back, tags).then(function() {
      formEl.style.display = 'none';
      newBtn.style.display = '';
      formSaveBtn.disabled = false;
      loadQueue();
    }).catch(function(err) {
      console.error('Error creating card:', err);
      formSaveBtn.disabled = false;
    });
  });

  // Ctrl+Enter to save from either textarea
  formFrontEl.addEventListener('keydown', handleFormKeydown);
  formBackEl.addEventListener('keydown', handleFormKeydown);
  function handleFormKeydown(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      e.preventDefault();
      formSaveBtn.click();
    }
    if (e.key === 'Escape') {
      formCancelBtn.click();
    }
  }

  // ---- Tag Filter ----

  function renderTagFilter() {
    var tagSet = {};
    allCards.forEach(function(c) {
      (c.tags || []).forEach(function(t) { tagSet[t] = true; });
    });
    var tags = Object.keys(tagSet).sort();

    if (tags.length === 0) {
      tagFilterEl.style.display = 'none';
      return;
    }

    tagFilterEl.style.display = '';
    var html = '<button type="button" class="review-tag-filter-chip' + (!activeTagFilter ? ' active' : '') + '" data-tag="">All</button>';
    tags.forEach(function(tag) {
      html += '<button type="button" class="review-tag-filter-chip' + (activeTagFilter === tag ? ' active' : '') + '" data-tag="' + escapeHtml(tag) + '">' + escapeHtml(tag) + '</button>';
    });
    tagFilterChipsEl.innerHTML = html;

    tagFilterChipsEl.querySelectorAll('.review-tag-filter-chip').forEach(function(chip) {
      chip.addEventListener('click', function() {
        var tag = chip.getAttribute('data-tag');
        activeTagFilter = tag || null;
        renderTagFilter();
        renderSchedule();
      });
    });
  }

  // ---- Schedule / Card List ----

  function renderSchedule() {
    if (!allCards.length) {
      scheduleEl.style.display = 'none';
      return;
    }

    var now = Date.now();
    var filtered = allCards;
    if (activeTagFilter) {
      filtered = allCards.filter(function(c) {
        return (c.tags || []).indexOf(activeTagFilter) !== -1;
      });
    }

    var sorted = filtered.slice().sort(function(a, b) {
      var aDue = a.nextReviewAt <= now ? 0 : 1;
      var bDue = b.nextReviewAt <= now ? 0 : 1;
      if (aDue !== bDue) return aDue - bDue;
      return (a.nextReviewAt || 0) - (b.nextReviewAt || 0);
    });

    var html = '';
    sorted.forEach(function(card) {
      var isDue = card.nextReviewAt <= now;
      var dueText = isDue ? 'Due now' : formatRelativeDate(card.nextReviewAt);
      var frontPreview = getFirstLine(card.front);

      html += '<div class="review-schedule-item" data-card-id="' + card.id + '">'
        + '<span class="review-schedule-item-front">' + escapeHtml(frontPreview) + '</span>'
        + '<span class="review-schedule-item-ef">EF ' + card.easeFactor.toFixed(1) + '</span>'
        + '<span class="review-schedule-item-due' + (isDue ? ' review-due-now' : '') + '">' + escapeHtml(dueText) + '</span>'
        + '<span class="review-schedule-item-actions">'
        + '<button type="button" class="review-schedule-item-btn review-item-edit" title="Edit card">'
        + '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>'
        + '</button>'
        + '<button type="button" class="review-schedule-item-btn review-item-delete" title="Delete card">'
        + '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>'
        + '</button>'
        + '</span>'
        + '</div>';
    });

    scheduleListEl.innerHTML = html;
    scheduleEl.style.display = '';

    // Attach handlers
    scheduleListEl.querySelectorAll('.review-item-delete').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        var item = btn.closest('.review-schedule-item');
        var cardId = item.getAttribute('data-card-id');
        if (!confirm('Delete this flashcard?')) return;

        btn.disabled = true;
        window.dmSync.deleteReviewCard(cardId).then(function() {
          item.style.opacity = '0';
          item.style.transform = 'translateX(20px)';
          item.style.transition = 'opacity 0.2s, transform 0.2s';
          setTimeout(function() {
            if (item.parentNode) item.parentNode.removeChild(item);
          }, 200);
          loadQueue();
        }).catch(function(err) {
          console.error('Error deleting card:', err);
          btn.disabled = false;
        });
      });
    });

    scheduleListEl.querySelectorAll('.review-item-edit').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        var item = btn.closest('.review-schedule-item');
        var cardId = item.getAttribute('data-card-id');
        var card = allCards.find(function(c) { return c.id === cardId; });
        if (!card) return;

        // Replace item content with inline edit form
        var originalHTML = item.innerHTML;
        item.innerHTML = '<div class="review-edit-form">'
          + '<textarea class="review-edit-front" rows="2" placeholder="Front">' + escapeHtml(card.front) + '</textarea>'
          + '<textarea class="review-edit-back" rows="3" placeholder="Back">' + escapeHtml(card.back) + '</textarea>'
          + '<div class="review-edit-form-actions">'
          + '<button type="button" class="review-edit-save">Save</button>'
          + '<button type="button" class="review-edit-cancel">Cancel</button>'
          + '</div>'
          + '</div>';

        item.querySelector('.review-edit-front').focus();

        item.querySelector('.review-edit-cancel').addEventListener('click', function() {
          item.innerHTML = originalHTML;
          // Re-attach handlers by re-rendering
          renderSchedule();
        });

        item.querySelector('.review-edit-save').addEventListener('click', function() {
          var newFront = item.querySelector('.review-edit-front').value.trim();
          var newBack = item.querySelector('.review-edit-back').value.trim();
          if (!newFront || !newBack) return;

          window.dmSync.updateReviewCardContent(cardId, { front: newFront, back: newBack }).then(function() {
            loadQueue();
          }).catch(function(err) {
            console.error('Error updating card:', err);
          });
        });

        // Ctrl+Enter to save from edit form
        item.querySelectorAll('.review-edit-front, .review-edit-back').forEach(function(ta) {
          ta.addEventListener('keydown', function(ev) {
            if ((ev.ctrlKey || ev.metaKey) && ev.key === 'Enter') {
              ev.preventDefault();
              item.querySelector('.review-edit-save').click();
            }
            if (ev.key === 'Escape') {
              item.querySelector('.review-edit-cancel').click();
            }
          });
        });
      });
    });
  }

  // Auth
  signinBtn.addEventListener('click', function() {
    window.dmSignIn();
  });

  // Auth state
  if (window.dmAuth) {
    function subscribeReviewAuth() {
      window.dmAuth.onAuthStateChanged(function(user) {
        if (user) {
          loadQueue();
        } else {
          showState('auth');
        }
      });
    }
    if (window.dmAuthReady) {
      window.dmAuthReady.then(subscribeReviewAuth);
    } else {
      subscribeReviewAuth();
    }
  } else {
    showState('auth');
  }

  // Listen for sync/review updates
  window.addEventListener('dm-sync-complete', function() {
    if (window.dmAuth && window.dmAuth.currentUser && document.getElementById('review-queue')) {
      loadQueue();
    }
  });
  window.addEventListener('dm-review-updated', function() {
    if (window.dmAuth && window.dmAuth.currentUser && document.getElementById('review-queue')) {
      if (cardContainerEl.style.display === 'none') {
        loadQueue();
      }
    }
  });

  // Expose createCard for external callers (e.g., note views)
  window.dmCreateFlashcard = function(front, back, tags) {
    if (!window.dmSync) return Promise.reject(new Error('Sync not ready'));
    return window.dmSync.createReviewCard(front, back, tags);
  };

  // ─── Export button ───
  var reviewExportBtn = document.getElementById('review-export-btn');
  if (reviewExportBtn) {
    reviewExportBtn.addEventListener('click', function() {
      if (window.dmExport) window.dmExport.open('cards');
    });
  }
})();
</script>
