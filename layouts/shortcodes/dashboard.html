<!-- Dashboard: Time tracking analytics for completed TODOs -->
<!-- Reads from IndexedDB todos store via window.dmSync -->

<div class="dashboard" id="dashboard">
  <div class="dashboard-auth" id="dashboard-auth" style="display: none;">
    <div class="dashboard-auth-card">
      <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
      </svg>
      <h3>Sign in to view your dashboard</h3>
      <p>Your time tracking data requires authentication.</p>
      <button type="button" class="dashboard-signin-btn" id="dashboard-signin-btn">
        <svg width="16" height="16" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
        Sign in with Google
      </button>
    </div>
  </div>

  <div class="dashboard-loading" id="dashboard-loading" style="display: none;">
    <div class="dashboard-spinner"></div>
    <span>Loading dashboard...</span>
  </div>

  <div class="dashboard-empty" id="dashboard-empty" style="display: none;">
    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--gray-400)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="1"></rect><rect x="14" y="3" width="7" height="7" rx="1"></rect><rect x="3" y="14" width="7" height="7" rx="1"></rect><rect x="14" y="14" width="7" height="7" rx="1"></rect></svg>
    <p>No completed tasks yet.</p>
    <p class="dashboard-empty-hint">Complete tasks in your <a href="{{ "docs/inbox/" | relURL }}">Inbox</a> to see time tracking insights here.</p>
  </div>

  <div class="dashboard-content" id="dashboard-content" style="display: none;">
    <!-- Panel 1: Summary stats -->
    <div class="dashboard-panel dashboard-summary" id="dashboard-summary"></div>

    <!-- Panel 2: Estimated vs Actual by category -->
    <div class="dashboard-panel">
      <h3 class="dashboard-panel-title">Estimated vs Actual</h3>
      <p class="dashboard-panel-subtitle">How accurate are your time estimates?</p>
      <div id="dashboard-est-vs-actual"></div>
    </div>

    <!-- Panel 3: Category breakdown -->
    <div class="dashboard-panel">
      <h3 class="dashboard-panel-title">Time by Category</h3>
      <p class="dashboard-panel-subtitle">Where you spend your time</p>
      <div id="dashboard-categories"></div>
    </div>

    <!-- Panel 4: Activity log -->
    <div class="dashboard-panel">
      <h3 class="dashboard-panel-title">Recent Activity</h3>
      <p class="dashboard-panel-subtitle">Tasks completed by day</p>
      <div id="dashboard-activity"></div>
    </div>
  </div>
</div>

<style>
.dashboard {
  max-width: 800px;
}

/* Auth */
.dashboard-auth {
  display: flex;
  justify-content: center;
  padding: 2rem 0;
}
.dashboard-auth-card {
  text-align: center;
  padding: 2rem;
  border-radius: 12px;
  border: 1px solid var(--gray-200);
  max-width: 380px;
}
.dashboard-auth-card h3 { margin: 1rem 0 0.5rem; }
.dashboard-auth-card p { color: var(--gray-500); margin-bottom: 1.5rem; font-size: 0.9rem; }
.dashboard-signin-btn {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  padding: 10px 20px;
  border: 1px solid var(--gray-300);
  border-radius: 8px;
  background: var(--body-background);
  color: var(--body-font-color);
  font-size: 0.9rem;
  cursor: pointer;
  transition: box-shadow 0.2s;
}
.dashboard-signin-btn:hover {
  box-shadow: 0 1px 4px var(--shadow-color);
}

/* Loading */
.dashboard-loading {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  padding: 3rem 0;
  color: var(--gray-500);
  font-size: 0.9rem;
}
.dashboard-spinner {
  width: 20px; height: 20px;
  border: 2px solid var(--gray-200);
  border-top-color: var(--color-link);
  border-radius: 50%;
  animation: dash-spin 0.7s linear infinite;
}
@keyframes dash-spin { to { transform: rotate(360deg); } }

/* Empty state */
.dashboard-empty {
  text-align: center;
  padding: 3rem 1rem;
  color: var(--gray-500);
}
.dashboard-empty p { margin: 0.5rem 0; font-size: 0.9rem; }
.dashboard-empty-hint { font-size: 0.82rem; }
.dashboard-empty-hint a { color: var(--color-link); }

/* Panels */
.dashboard-content {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}
.dashboard-panel {
  border: 1px solid var(--gray-200);
  border-radius: 12px;
  padding: 1.25rem;
  background: var(--body-background);
}
.dashboard-panel-title {
  margin: 0 0 0.15rem;
  font-size: 0.95rem;
  font-weight: 700;
  color: var(--body-font-color);
}
.dashboard-panel-subtitle {
  margin: 0 0 1rem;
  font-size: 0.78rem;
  color: var(--gray-500);
}

/* Summary stats row */
.dashboard-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 12px;
}
.dashboard-stat {
  text-align: center;
  padding: 1rem 0.75rem;
  border-radius: 10px;
  background: var(--gray-100);
}
.dashboard-stat-value {
  font-size: 1.6rem;
  font-weight: 700;
  color: var(--body-font-color);
  line-height: 1.2;
}
.dashboard-stat-label {
  font-size: 0.72rem;
  color: var(--gray-500);
  text-transform: uppercase;
  letter-spacing: 0.04em;
  margin-top: 4px;
}
.dashboard-stat-sub {
  font-size: 0.72rem;
  color: var(--gray-400);
  margin-top: 2px;
}

/* Bar chart rows */
.dashboard-bar-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}
.dashboard-bar-row:last-child { margin-bottom: 0; }
.dashboard-bar-label {
  width: 100px;
  font-size: 0.8rem;
  font-weight: 500;
  color: var(--body-font-color);
  text-align: right;
  flex-shrink: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.dashboard-bar-track {
  flex: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
  gap: 3px;
}
.dashboard-bar-pair {
  display: flex;
  align-items: center;
  gap: 6px;
}
.dashboard-bar {
  height: 14px;
  border-radius: 4px;
  min-width: 2px;
  transition: width 0.4s ease-out;
}
.dashboard-bar.estimated {
  background: var(--color-link);
  opacity: 0.35;
}
.dashboard-bar.actual {
  background: var(--color-link);
}
.dashboard-bar-value {
  font-size: 0.7rem;
  color: var(--gray-500);
  white-space: nowrap;
  flex-shrink: 0;
}
.dashboard-bar-accuracy {
  font-size: 0.7rem;
  font-weight: 600;
  white-space: nowrap;
  flex-shrink: 0;
  padding: 1px 6px;
  border-radius: 4px;
}
.dashboard-bar-accuracy.over {
  color: var(--color-danger);
  background: var(--color-danger-bg);
}
.dashboard-bar-accuracy.under {
  color: var(--color-success);
  background: var(--color-success-bg);
}
.dashboard-bar-accuracy.exact {
  color: var(--gray-500);
  background: var(--gray-100);
}
.dashboard-bar-legend {
  display: flex;
  gap: 16px;
  margin-bottom: 12px;
  font-size: 0.72rem;
  color: var(--gray-500);
}
.dashboard-bar-legend-item {
  display: flex;
  align-items: center;
  gap: 4px;
}
.dashboard-bar-legend-swatch {
  width: 12px;
  height: 10px;
  border-radius: 3px;
}

/* Category proportional bars */
.dashboard-cat-bar {
  height: 18px;
  border-radius: 4px;
  min-width: 2px;
  transition: width 0.4s ease-out;
}
.dashboard-cat-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 8px;
}
.dashboard-cat-row:last-child { margin-bottom: 0; }
.dashboard-cat-label {
  width: 100px;
  font-size: 0.8rem;
  font-weight: 500;
  color: var(--body-font-color);
  text-align: right;
  flex-shrink: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.dashboard-cat-track {
  flex: 1;
  display: flex;
  align-items: center;
  gap: 8px;
}
.dashboard-cat-value {
  font-size: 0.72rem;
  color: var(--gray-500);
  white-space: nowrap;
  flex-shrink: 0;
}

/* Activity day rows */
.dashboard-activity-day {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  margin-bottom: 10px;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--gray-100);
}
.dashboard-activity-day:last-child {
  margin-bottom: 0;
  padding-bottom: 0;
  border-bottom: none;
}
.dashboard-activity-date {
  width: 80px;
  flex-shrink: 0;
  font-size: 0.78rem;
  font-weight: 600;
  color: var(--body-font-color);
  padding-top: 2px;
}
.dashboard-activity-date-sub {
  font-weight: 400;
  color: var(--gray-500);
  font-size: 0.72rem;
}
.dashboard-activity-tasks {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.dashboard-activity-task {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.82rem;
}
.dashboard-activity-task-check {
  color: var(--color-success);
  flex-shrink: 0;
}
.dashboard-activity-task-title {
  flex: 1;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  color: var(--body-font-color);
}
.dashboard-activity-task-time {
  font-size: 0.72rem;
  color: var(--gray-500);
  flex-shrink: 0;
}
.dashboard-activity-summary {
  font-size: 0.72rem;
  color: var(--gray-500);
  margin-top: 2px;
}
.dashboard-no-data {
  text-align: center;
  padding: 1.5rem 0;
  font-size: 0.85rem;
  color: var(--gray-500);
}

/* Pom badge */
.dashboard-pom {
  font-size: 0.68rem;
  color: var(--gray-400);
}

@media screen and (max-width: 600px) {
  .dashboard-bar-label,
  .dashboard-cat-label {
    width: 70px;
    font-size: 0.72rem;
  }
  .dashboard-stats {
    grid-template-columns: repeat(2, 1fr);
  }
  .dashboard-activity-date {
    width: 60px;
  }
}
</style>

<script>
(function() {
  'use strict';

  var container = document.getElementById('dashboard');
  var authEl = document.getElementById('dashboard-auth');
  var loadingEl = document.getElementById('dashboard-loading');
  var emptyEl = document.getElementById('dashboard-empty');
  var contentEl = document.getElementById('dashboard-content');
  var signinBtn = document.getElementById('dashboard-signin-btn');

  if (!container) return;

  // Category colors (cycle through)
  var CAT_COLORS = [
    'var(--color-link)',
    'var(--color-success)',
    'var(--accent-orange)',
    'var(--accent-purple)',
    'var(--accent-blue)',
    'var(--accent-green)'
  ];

  function escapeHtml(str) {
    if (!str) return '';
    var div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function pom(minutes) {
    return (minutes / 25).toFixed(1);
  }

  function showState(state) {
    authEl.style.display = state === 'auth' ? '' : 'none';
    loadingEl.style.display = state === 'loading' ? '' : 'none';
    emptyEl.style.display = state === 'empty' ? '' : 'none';
    contentEl.style.display = state === 'content' ? '' : 'none';
  }

  function formatDate(ts) {
    var d = new Date(ts);
    var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    return months[d.getMonth()] + ' ' + d.getDate();
  }

  function formatDayOfWeek(ts) {
    var days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    return days[new Date(ts).getDay()];
  }

  function dateKey(ts) {
    var d = new Date(ts);
    return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
  }

  // ─── Render functions ───

  function renderSummary(todos) {
    var el = document.getElementById('dashboard-summary');
    if (!el) return;

    var total = todos.length;
    var done = todos.filter(function(t) { return t.status === 'archived' || t.status === 'done'; });
    var doneCount = done.length;
    var totalEst = 0, totalActual = 0;
    var estCount = 0; // tasks with both est and actual for accuracy

    todos.forEach(function(t) {
      if (t.estimatedMin) totalEst += t.estimatedMin;
    });
    done.forEach(function(t) {
      if (t.actualMin) totalActual += t.actualMin;
      if (t.estimatedMin && t.actualMin) estCount++;
    });

    // Accuracy: average (actual/estimated) ratio for tasks with both values
    var accuracy = '';
    if (estCount > 0) {
      var totalEstForAccuracy = 0, totalActualForAccuracy = 0;
      done.forEach(function(t) {
        if (t.estimatedMin && t.actualMin) {
          totalEstForAccuracy += t.estimatedMin;
          totalActualForAccuracy += t.actualMin;
        }
      });
      var ratio = totalActualForAccuracy / totalEstForAccuracy;
      if (ratio <= 1.05 && ratio >= 0.95) {
        accuracy = 'Spot on';
      } else if (ratio > 1) {
        accuracy = Math.round((ratio - 1) * 100) + '% over';
      } else {
        accuracy = Math.round((1 - ratio) * 100) + '% under';
      }
    }

    var html = '<div class="dashboard-stats">';
    html += '<div class="dashboard-stat">';
    html += '<div class="dashboard-stat-value">' + doneCount + '<span style="font-size: 0.9rem; font-weight: 400; color: var(--gray-500);">/' + total + '</span></div>';
    html += '<div class="dashboard-stat-label">Tasks Done</div>';
    html += '</div>';

    html += '<div class="dashboard-stat">';
    html += '<div class="dashboard-stat-value">' + totalActual + '<span style="font-size: 0.8rem; font-weight: 400;">min</span></div>';
    html += '<div class="dashboard-stat-label">Time Tracked</div>';
    html += '<div class="dashboard-stat-sub">' + pom(totalActual) + ' pomodoros</div>';
    html += '</div>';

    html += '<div class="dashboard-stat">';
    html += '<div class="dashboard-stat-value">' + totalEst + '<span style="font-size: 0.8rem; font-weight: 400;">min</span></div>';
    html += '<div class="dashboard-stat-label">Time Estimated</div>';
    html += '<div class="dashboard-stat-sub">' + pom(totalEst) + ' pomodoros</div>';
    html += '</div>';

    if (accuracy) {
      html += '<div class="dashboard-stat">';
      html += '<div class="dashboard-stat-value" style="font-size: 1.2rem;">' + accuracy + '</div>';
      html += '<div class="dashboard-stat-label">Estimate Accuracy</div>';
      html += '<div class="dashboard-stat-sub">across ' + estCount + ' task' + (estCount !== 1 ? 's' : '') + '</div>';
      html += '</div>';
    }

    html += '</div>';
    el.innerHTML = html;
  }

  function renderEstVsActual(todos) {
    var el = document.getElementById('dashboard-est-vs-actual');
    if (!el) return;

    // Group completed todos by category
    var done = todos.filter(function(t) { return (t.status === 'archived' || t.status === 'done') && t.actualMin; });
    if (!done.length) {
      el.innerHTML = '<div class="dashboard-no-data">Complete tasks with time tracking to see comparisons.</div>';
      return;
    }

    var cats = {};
    done.forEach(function(t) {
      var cat = t.category || 'Uncategorized';
      // Split multi-category entries
      cat.split(',').forEach(function(c) {
        c = c.trim();
        if (!c) return;
        if (!cats[c]) cats[c] = { est: 0, actual: 0, count: 0 };
        cats[c].actual += (t.actualMin || 0);
        cats[c].est += (t.estimatedMin || 0);
        cats[c].count++;
      });
    });

    var catNames = Object.keys(cats).sort(function(a, b) {
      return cats[b].actual - cats[a].actual;
    });

    // Find max value for scaling
    var maxVal = 0;
    catNames.forEach(function(c) {
      maxVal = Math.max(maxVal, cats[c].est, cats[c].actual);
    });
    if (maxVal === 0) maxVal = 1;

    var html = '<div class="dashboard-bar-legend">';
    html += '<span class="dashboard-bar-legend-item"><span class="dashboard-bar-legend-swatch" style="background: var(--color-link); opacity: 0.35;"></span> Estimated</span>';
    html += '<span class="dashboard-bar-legend-item"><span class="dashboard-bar-legend-swatch" style="background: var(--color-link);"></span> Actual</span>';
    html += '</div>';

    catNames.forEach(function(cat) {
      var data = cats[cat];
      var estPct = Math.max((data.est / maxVal) * 100, 1);
      var actPct = Math.max((data.actual / maxVal) * 100, 1);

      var accClass = 'exact';
      var accText = '=';
      if (data.est > 0) {
        var diff = data.actual - data.est;
        var pctDiff = Math.round((diff / data.est) * 100);
        if (pctDiff > 5) {
          accClass = 'over';
          accText = '+' + pctDiff + '%';
        } else if (pctDiff < -5) {
          accClass = 'under';
          accText = pctDiff + '%';
        }
      }

      html += '<div class="dashboard-bar-row">';
      html += '<div class="dashboard-bar-label" title="' + escapeHtml(cat) + '">' + escapeHtml(cat) + '</div>';
      html += '<div class="dashboard-bar-track">';
      html += '<div class="dashboard-bar-pair">';
      html += '<div class="dashboard-bar estimated" style="width: ' + estPct + '%;"></div>';
      html += '<span class="dashboard-bar-value">' + data.est + 'min <span class="dashboard-pom">(' + pom(data.est) + 'p)</span></span>';
      html += '</div>';
      html += '<div class="dashboard-bar-pair">';
      html += '<div class="dashboard-bar actual" style="width: ' + actPct + '%;"></div>';
      html += '<span class="dashboard-bar-value">' + data.actual + 'min <span class="dashboard-pom">(' + pom(data.actual) + 'p)</span></span>';
      html += '<span class="dashboard-bar-accuracy ' + accClass + '">' + accText + '</span>';
      html += '</div>';
      html += '</div>';
      html += '</div>';
    });

    el.innerHTML = html;
  }

  function renderCategories(todos) {
    var el = document.getElementById('dashboard-categories');
    if (!el) return;

    var done = todos.filter(function(t) { return (t.status === 'archived' || t.status === 'done') && t.actualMin; });
    if (!done.length) {
      el.innerHTML = '<div class="dashboard-no-data">Complete tasks to see category breakdown.</div>';
      return;
    }

    var cats = {};
    var totalMin = 0;
    done.forEach(function(t) {
      var cat = t.category || 'Uncategorized';
      cat.split(',').forEach(function(c) {
        c = c.trim();
        if (!c) return;
        if (!cats[c]) cats[c] = 0;
        cats[c] += (t.actualMin || 0);
        totalMin += (t.actualMin || 0);
      });
    });

    var catNames = Object.keys(cats).sort(function(a, b) {
      return cats[b] - cats[a];
    });

    var maxVal = cats[catNames[0]] || 1;

    var html = '';
    catNames.forEach(function(cat, idx) {
      var minutes = cats[cat];
      var pct = Math.max((minutes / maxVal) * 100, 2);
      var share = totalMin > 0 ? Math.round((minutes / totalMin) * 100) : 0;
      var color = CAT_COLORS[idx % CAT_COLORS.length];

      html += '<div class="dashboard-cat-row">';
      html += '<div class="dashboard-cat-label" title="' + escapeHtml(cat) + '">' + escapeHtml(cat) + '</div>';
      html += '<div class="dashboard-cat-track">';
      html += '<div class="dashboard-cat-bar" style="width: ' + pct + '%; background: ' + color + ';"></div>';
      html += '<span class="dashboard-cat-value">' + minutes + 'min (' + share + '%) <span class="dashboard-pom">' + pom(minutes) + 'p</span></span>';
      html += '</div>';
      html += '</div>';
    });

    el.innerHTML = html;
  }

  function renderActivity(todos) {
    var el = document.getElementById('dashboard-activity');
    if (!el) return;

    var done = todos.filter(function(t) { return (t.status === 'archived' || t.status === 'done') && t.completedAt; });
    if (!done.length) {
      el.innerHTML = '<div class="dashboard-no-data">Complete tasks to see activity log.</div>';
      return;
    }

    // Sort by completedAt desc
    done.sort(function(a, b) { return (b.completedAt || 0) - (a.completedAt || 0); });

    // Group by day
    var days = {};
    var dayOrder = [];
    done.forEach(function(t) {
      var key = dateKey(t.completedAt);
      if (!days[key]) {
        days[key] = { ts: t.completedAt, tasks: [] };
        dayOrder.push(key);
      }
      days[key].tasks.push(t);
    });

    // Show last 14 days max
    var MAX_DAYS = 14;
    var shownDays = dayOrder.slice(0, MAX_DAYS);

    var html = '';
    shownDays.forEach(function(key) {
      var day = days[key];
      var totalMin = 0;
      day.tasks.forEach(function(t) { if (t.actualMin) totalMin += t.actualMin; });

      html += '<div class="dashboard-activity-day">';
      html += '<div class="dashboard-activity-date">';
      html += formatDate(day.ts);
      html += '<div class="dashboard-activity-date-sub">' + formatDayOfWeek(day.ts) + '</div>';
      html += '</div>';
      html += '<div class="dashboard-activity-tasks">';

      day.tasks.forEach(function(t) {
        html += '<div class="dashboard-activity-task">';
        html += '<span class="dashboard-activity-task-check">&#10003;</span>';
        html += '<span class="dashboard-activity-task-title">' + escapeHtml(t.title) + '</span>';
        if (t.actualMin) {
          html += '<span class="dashboard-activity-task-time">' + t.actualMin + 'min</span>';
        }
        html += '</div>';
      });

      if (totalMin > 0) {
        html += '<div class="dashboard-activity-summary">' + day.tasks.length + ' task' + (day.tasks.length !== 1 ? 's' : '') + ' &middot; ' + totalMin + 'min &middot; ' + pom(totalMin) + ' pom</div>';
      }

      html += '</div></div>';
    });

    if (dayOrder.length > MAX_DAYS) {
      html += '<div class="dashboard-no-data" style="font-size: 0.78rem;">Showing last ' + MAX_DAYS + ' days (' + dayOrder.length + ' total)</div>';
    }

    el.innerHTML = html;
  }

  // ─── Main render ───

  function renderDashboard() {
    if (!window.dmSync) return;

    showState('loading');

    window.dmSync.getAllTodos().then(function(todos) {
      if (!todos) todos = [];

      // Migrate legacy todos: backfill status field from done boolean
      todos.forEach(function(t) {
        if (!t.status) {
          t.status = t.done ? 'done' : 'active';
        }
      });

      // Filter to only leaf tasks (no children) for accurate stats
      // But keep all for display purposes
      var hasCompleted = todos.some(function(t) { return t.status === 'archived' || t.status === 'done'; });

      if (!todos.length || !hasCompleted) {
        showState('empty');
        return;
      }

      showState('content');
      renderSummary(todos);
      renderEstVsActual(todos);
      renderCategories(todos);
      renderActivity(todos);
    }).catch(function(err) {
      console.error('[dashboard] Error loading todos:', err);
      showState('empty');
    });
  }

  // ─── Auth & events ───

  if (signinBtn) {
    signinBtn.addEventListener('click', function() {
      window.dmSignIn();
    });
  }

  window.addEventListener('dm-todos-updated', renderDashboard);
  window.addEventListener('dm-sync-complete', renderDashboard);

  if (window.dmAuth) {
    function subscribeDashboardAuth() {
      window.dmAuth.onAuthStateChanged(function(user) {
        if (user) {
          renderDashboard();
        } else {
          showState('auth');
        }
      });
    }
    if (window.dmAuthReady) {
      window.dmAuthReady.then(subscribeDashboardAuth);
    } else {
      subscribeDashboardAuth();
    }
  }
})();
</script>
