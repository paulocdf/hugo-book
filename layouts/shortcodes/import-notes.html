<!-- Import tool: initial import completed. This page now provides Firestore management utilities. -->

<div class="my-notes" id="import-tool">
  <div class="my-notes-signin" id="import-signin">
    <div class="my-notes-signin-card">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="my-notes-signin-icon">
        <path d="M9 11l3 3L22 4"></path>
        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
      </svg>
      <h3>Notes Already Imported</h3>
      <p>All notes have been imported to Firestore. Sign in to manage your notes or delete all data.</p>
      <button type="button" class="my-notes-google-btn" id="import-signin-btn">
        <svg width="18" height="18" viewBox="0 0 24 24">
          <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/>
          <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
          <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
          <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
        </svg>
        Sign in with Google
      </button>
    </div>
  </div>

  <div class="my-notes-content" id="import-content" style="display: none;">
    <div class="my-notes-header">
      <div class="my-notes-user">
        <img class="my-notes-avatar" id="import-avatar" src="" alt="" />
        <span class="my-notes-username" id="import-username"></span>
      </div>
      <div>
        <button type="button" class="my-notes-google-btn" id="delete-all-btn" style="background: #c62828; color: #fff; border-color: #c62828;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          </svg>
          Delete All Notes
        </button>
      </div>
    </div>

    <div id="import-log" style="margin-top: 1rem;">
      <div style="padding:1rem;background:#e8f5e9;border-radius:8px;color:#2e7d32;text-align:center;">
        All notes have been imported to Firestore. Use Quick Capture to add new notes.
      </div>
    </div>

    <div id="import-stats" style="margin-top: 1rem;"></div>
  </div>
</div>

<script>
(function() {
  if (typeof firebase === 'undefined' || !window.dmAuth || !window.dmDb) return;

  var signinView = document.getElementById('import-signin');
  var contentView = document.getElementById('import-content');
  var signinBtn = document.getElementById('import-signin-btn');
  var avatarEl = document.getElementById('import-avatar');
  var usernameEl = document.getElementById('import-username');
  var deleteAllBtn = document.getElementById('delete-all-btn');
  var logEl = document.getElementById('import-log');
  var statsEl = document.getElementById('import-stats');

  function subscribeImportAuth() {
    window.dmAuth.onAuthStateChanged(function(user) {
      if (user) {
        signinView.style.display = 'none';
        contentView.style.display = '';
        avatarEl.src = user.photoURL || '';
        usernameEl.textContent = user.displayName || user.email || '';
        showStats(user);
      } else {
        signinView.style.display = '';
        contentView.style.display = 'none';
      }
    });
  }
  if (window.dmAuthReady) {
    window.dmAuthReady.then(subscribeImportAuth);
  } else {
    subscribeImportAuth();
  }

  signinBtn.addEventListener('click', function() {
    window.dmSignIn();
  });

  function showStats(user) {
    window.dmDb.collection('notes')
      .where('userId', '==', user.uid)
      .get()
      .then(function(snapshot) {
        var counts = {};
        snapshot.forEach(function(doc) {
          var dest = doc.data().destination || 'unknown';
          counts[dest] = (counts[dest] || 0) + 1;
        });
        var html = '<div style="padding:1rem;background:var(--body-background);border:1px solid var(--gray-200);border-radius:8px;">'
          + '<strong>' + snapshot.size + ' notes in Firestore:</strong><br/>';
        Object.keys(counts).sort().forEach(function(dest) {
          html += '<span style="margin-right:1rem;">' + dest + ': ' + counts[dest] + '</span>';
        });
        html += '</div>';
        statsEl.innerHTML = html;
      })
      .catch(function(err) {
        console.error('Stats error:', err);
      });
  }

  deleteAllBtn.addEventListener('click', function() {
    var user = window.dmAuth.currentUser;
    if (!user) { alert('Please sign in first.'); return; }
    if (!confirm('Delete ALL notes from Firestore? This cannot be undone.')) return;

    deleteAllBtn.disabled = true;
    deleteAllBtn.textContent = 'Deleting...';
    logEl.innerHTML = '';

    window.dmDb.collection('notes')
      .where('userId', '==', user.uid)
      .get()
      .then(function(snapshot) {
        if (snapshot.empty) {
          logEl.innerHTML = '<div style="padding:1rem;background:#fff3e0;border-radius:8px;color:#e65100;font-weight:600;text-align:center;">No notes found to delete.</div>';
          deleteAllBtn.disabled = false;
          deleteAllBtn.textContent = 'Delete All Notes';
          return;
        }
        var batches = [];
        var batch = window.dmDb.batch();
        var count = 0;
        snapshot.forEach(function(doc) {
          batch.delete(doc.ref);
          count++;
          if (count % 500 === 0) {
            batches.push(batch);
            batch = window.dmDb.batch();
          }
        });
        batches.push(batch);

        return Promise.all(batches.map(function(b) { return b.commit(); }))
          .then(function() {
            logEl.innerHTML = '<div style="padding:1rem;background:#e8f5e9;border-radius:8px;color:#2e7d32;font-weight:600;text-align:center;">Deleted ' + count + ' notes.</div>';
            deleteAllBtn.textContent = 'Delete All Notes';
            deleteAllBtn.disabled = false;
            statsEl.innerHTML = '';
            if (window.dmSync) {
              window.dmSync.clearCache();
            }
          });
      })
      .catch(function(err) {
        console.error('Delete error:', err);
        logEl.innerHTML = '<div style="padding:1rem;background:#ffebee;border-radius:8px;color:#c62828;">Delete failed: ' + err.message + '</div>';
        deleteAllBtn.disabled = false;
        deleteAllBtn.textContent = 'Delete All Notes';
      });
  });
})();
</script>
