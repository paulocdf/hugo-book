{{/* Section Notes: displays notes from IndexedDB cache filtered by destination */}}
{{/* Usage: {{< section-notes destination="book-note" >}} */}}
{{/* Books: grouped by bookTitle as clickable cards */}}
{{/* Snippets: grouped by language as clickable cards */}}
{{/* Topics: flat list of clickable cards */}}
{{ $destination := .Get "destination" | default "topic" }}

<div class="section-notes" id="section-notes-{{ $destination }}" data-destination="{{ $destination }}">
  <div class="section-notes-auth" style="display: none;">
    <div class="section-notes-auth-card">
      <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
      </svg>
      <h3>Sign in to view notes</h3>
      <p>Your notes are stored securely and require authentication.</p>
      <button type="button" class="section-notes-signin-btn">
        <svg width="16" height="16" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
        Sign in with Google
      </button>
    </div>
  </div>

  <div class="section-notes-loading" style="display: none;">
    <div class="section-notes-spinner"></div>
    <span>Loading notes...</span>
  </div>

  <div class="section-notes-empty" style="display: none;">
    <p>No notes yet. Use the Quick Capture button to add some!</p>
  </div>

  <div class="section-notes-list"></div>
</div>

<style>
.section-notes-auth {
  display: flex;
  justify-content: center;
  padding: 2rem 0;
}
.section-notes-auth-card {
  text-align: center;
  padding: 2rem;
  border-radius: 12px;
  border: 1px solid var(--gray-200);
  max-width: 380px;
}
.section-notes-auth-card h3 { margin: 1rem 0 0.5rem; }
.section-notes-auth-card p { color: var(--gray-500); margin-bottom: 1.5rem; font-size: 0.9rem; }
.section-notes-signin-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 24px;
  border: 1px solid var(--gray-300);
  border-radius: 8px;
  background: var(--body-background);
  color: var(--body-font-color);
  font-size: 14px;
  cursor: pointer;
  transition: background 0.2s, box-shadow 0.2s;
}
.section-notes-signin-btn:hover { background: var(--gray-100); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.section-notes-loading {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 2rem 0;
  justify-content: center;
  color: var(--gray-500);
}
.section-notes-spinner {
  width: 20px; height: 20px;
  border: 2px solid var(--gray-200);
  border-top-color: var(--color-link);
  border-radius: 50%;
  animation: sn-spin 0.8s linear infinite;
}
@keyframes sn-spin { to { transform: rotate(360deg); } }
.section-notes-empty {
  text-align: center;
  padding: 2rem 0;
  color: var(--gray-500);
}

/* Card styles for Topics, Books, Snippets */
.section-notes-group { margin-bottom: 2rem; }
.section-notes-group-title {
  font-size: 1.1rem;
  font-weight: 600;
  margin: 0 0 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid var(--gray-200);
  color: var(--body-font-color);
}
.section-notes-card {
  display: block;
  padding: 1rem 1.25rem;
  margin-bottom: 0.75rem;
  border: 1px solid var(--gray-200);
  border-radius: 10px;
  transition: border-color 0.2s, box-shadow 0.2s;
  cursor: pointer;
  text-decoration: none;
  color: var(--body-font-color);
}
.section-notes-card:hover {
  border-color: var(--color-link);
  box-shadow: 0 2px 12px rgba(0,0,0,0.08);
}
.section-notes-card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
}
.section-notes-card-title { margin: 0 0 4px; font-size: 1rem; font-weight: 600; }
.section-notes-card-meta {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.8rem;
  color: var(--gray-500);
}
.section-notes-tag {
  display: inline-block;
  padding: 1px 8px;
  border-radius: 10px;
  background: var(--gray-100);
  font-size: 0.75rem;
}
.section-notes-date { white-space: nowrap; }
.section-notes-preview {
  margin-top: 0.5rem;
  font-size: 0.85rem;
  color: var(--gray-500);
  line-height: 1.5;
  max-height: 4.5em;
  overflow: hidden;
}
.section-notes-preview pre {
  margin: 0; padding: 0.5rem; border-radius: 6px;
  background: var(--pre-bg, #f6f8fa); font-size: 0.8rem; overflow: hidden;
}

/* Action buttons (edit + delete) */
.section-notes-card-actions {
  display: flex;
  align-items: center;
  gap: 2px;
  flex-shrink: 0;
}
.section-notes-delete,
.section-notes-edit {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 28px;
  height: 28px;
  background: none;
  border: 1px solid transparent;
  border-radius: 6px;
  cursor: pointer;
  transition: color 0.2s, background 0.2s, border-color 0.2s;
  flex-shrink: 0;
  color: var(--gray-400);
}
.section-notes-edit:hover {
  color: var(--color-link);
  background: rgba(0, 105, 255, 0.06);
  border-color: rgba(0, 105, 255, 0.2);
}
.section-notes-delete:hover {
  color: #e53e3e;
  background: rgba(229, 62, 62, 0.06);
  border-color: rgba(229, 62, 62, 0.2);
}
.section-notes-pin {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 28px;
  height: 28px;
  background: none;
  border: 1px solid transparent;
  border-radius: 6px;
  cursor: pointer;
  transition: color 0.2s, background 0.2s, border-color 0.2s;
  flex-shrink: 0;
  color: var(--gray-400);
}
.section-notes-pin:hover {
  color: var(--color-link);
  background: rgba(0, 105, 255, 0.06);
  border-color: rgba(0, 105, 255, 0.2);
}
.section-notes-pin-active {
  color: var(--color-link);
}
.section-notes-card-pinned {
  border-left: 3px solid var(--color-link);
}
.section-notes-pin-indicator {
  vertical-align: -1px;
  margin-right: 2px;
  color: var(--color-link);
}
</style>

<script>
(function() {
  'use strict';

  var containers = document.querySelectorAll('.section-notes');
  if (!containers.length) return;

  containers.forEach(function(container) {
    var destination = container.getAttribute('data-destination');
    var authEl = container.querySelector('.section-notes-auth');
    var loadingEl = container.querySelector('.section-notes-loading');
    var emptyEl = container.querySelector('.section-notes-empty');
    var listEl = container.querySelector('.section-notes-list');
    var signinBtn = container.querySelector('.section-notes-signin-btn');

    var selfTriggeredSync = false;

    function showState(state) {
      authEl.style.display = state === 'auth' ? '' : 'none';
      loadingEl.style.display = state === 'loading' ? '' : 'none';
      emptyEl.style.display = state === 'empty' ? '' : 'none';
      listEl.style.display = (state === 'content' || state === 'loading') ? '' : 'none';
    }

    function getBaseUrl() {
      var manifest = document.querySelector('link[rel="manifest"]');
      if (manifest) return manifest.getAttribute('href').replace('/manifest.json', '');
      return '';
    }

    function viewUrl(noteId) {
      return getBaseUrl() + '/docs/view/?id=' + encodeURIComponent(noteId);
    }

    function formatDate(ms) {
      if (!ms) return '';
      var d = new Date(ms);
      var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      return months[d.getMonth()] + ' ' + d.getDate() + ', ' + d.getFullYear();
    }

    function escapeHtml(str) {
      if (!str) return '';
      var div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // SVG icons
    var editIcon = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">'
      + '<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>'
      + '<path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>'
      + '</svg>';

    var deleteIcon = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">'
      + '<polyline points="3 6 5 6 21 6"></polyline>'
      + '<path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>'
      + '</svg>';

    var pinIcon = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">'
      + '<line x1="12" y1="17" x2="12" y2="22"></line>'
      + '<path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z"></path>'
      + '</svg>';

    // ---------------------------------------------------------------
    // Render a clickable card (for Topics, Books, Snippets)
    // ---------------------------------------------------------------
    function renderCard(note) {
      var tagsHtml = '';
      if (note.tags && note.tags.length) {
        note.tags.forEach(function(t) {
          tagsHtml += '<span class="section-notes-tag">' + escapeHtml(t) + '</span>';
        });
      }

      var preview = note.content || '';
      if (note.mode === 'code') {
        var codePreview = preview.length > 200 ? preview.substring(0, 200) + '...' : preview;
        preview = '<pre><code>' + escapeHtml(codePreview) + '</code></pre>';
      } else {
        var textPreview = preview.length > 250 ? preview.substring(0, 250) + '...' : preview;
        preview = escapeHtml(textPreview);
      }

      var pinnedClass = note.pinned ? ' section-notes-card-pinned' : '';
      var pinBtnClass = 'section-notes-pin' + (note.pinned ? ' section-notes-pin-active' : '');
      var pinTitle = note.pinned ? 'Unpin note' : 'Pin note';

      return '<a class="section-notes-card' + pinnedClass + '" href="' + viewUrl(note.id) + '">'
        + '<div class="section-notes-card-header">'
        + '<div>'
        + '<h4 class="section-notes-card-title">' + (note.pinned ? '<svg class="section-notes-pin-indicator" width="12" height="12" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1"><line x1="12" y1="17" x2="12" y2="22"></line><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z"></path></svg> ' : '') + escapeHtml(note.title || 'Untitled') + '</h4>'
        + '<div class="section-notes-card-meta">'
        + '<span class="section-notes-date">' + formatDate(note.createdAt) + '</span>'
        + tagsHtml
        + '</div>'
        + '</div>'
        + '<div class="section-notes-card-actions">'
        + '<button type="button" class="' + pinBtnClass + '" data-pin-id="' + note.id + '" title="' + pinTitle + '">' + pinIcon + '</button>'
        + '<button type="button" class="section-notes-edit" data-id="' + note.id + '" title="Edit note">' + editIcon + '</button>'
        + '<button type="button" class="section-notes-delete" data-id="' + note.id + '" title="Delete note">' + deleteIcon + '</button>'
        + '</div>'
        + '</div>'
        + '<div class="section-notes-preview">' + preview + '</div>'
        + '</a>';
    }

    function renderNotes(notes) {
      if (!notes.length) {
        showState('empty');
        return;
      }

      // Sort: pinned first, then by createdAt descending (newest first)
      notes.sort(function(a, b) {
        if (a.pinned && !b.pinned) return -1;
        if (!a.pinned && b.pinned) return 1;
        return (b.createdAt || 0) - (a.createdAt || 0);
      });

      var html = '';

      if (destination === 'book-note') {
        // Flat list of book cards, sorted by pinned first, then bookTitle, then createdAt
        notes.sort(function(a, b) {
          if (a.pinned && !b.pinned) return -1;
          if (!a.pinned && b.pinned) return 1;
          var at = (a.bookTitle || '').toLowerCase();
          var bt = (b.bookTitle || '').toLowerCase();
          if (at < bt) return -1;
          if (at > bt) return 1;
          return (b.createdAt || 0) - (a.createdAt || 0);
        });
        notes.forEach(function(n) { html += renderCard(n); });
      } else if (destination === 'snippets') {
        // Group by language
        var langs = {};
        notes.forEach(function(n) {
          var lang = n.language || 'other';
          if (!langs[lang]) langs[lang] = [];
          langs[lang].push(n);
        });
        Object.keys(langs).sort().forEach(function(lang) {
          var langTitle = lang.charAt(0).toUpperCase() + lang.slice(1);
          html += '<div class="section-notes-group">';
          html += '<h3 class="section-notes-group-title">' + escapeHtml(langTitle) + '</h3>';
          langs[lang].forEach(function(n) { html += renderCard(n); });
          html += '</div>';
        });
      } else {
        // Flat list of cards (topics, etc.)
        notes.forEach(function(n) { html += renderCard(n); });
      }

      listEl.innerHTML = html;
      showState('content');
      bindActionButtons();

      // Fire event so dynamic ToC can be built
      window.dispatchEvent(new CustomEvent('dm-content-rendered'));
    }

    function bindActionButtons() {
      // Delete buttons (soft-delete: move to trash)
      listEl.querySelectorAll('.section-notes-delete').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          var noteId = btn.getAttribute('data-id');
          if (!confirm('Move this note to trash?')) return;

          if (window.dmSync) {
            window.dmSync.firestoreWrite({
              collection: 'notes',
              docId: noteId,
              op: 'update',
              data: { deletedAt: firebase.firestore.FieldValue.serverTimestamp(), updatedAt: firebase.firestore.FieldValue.serverTimestamp() },
              localOp: function() { return window.dmSync.trashNote(noteId); }
            })
              .then(function() {
                loadFromCache();
                window.dispatchEvent(new CustomEvent('dm-sync-complete'));
              })
              .catch(function(err) {
                console.error('Delete error:', err);
                alert('Failed to delete note.');
              });
          }
        });
      });

      // Pin buttons
      listEl.querySelectorAll('.section-notes-pin[data-pin-id]').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          var noteId = btn.getAttribute('data-pin-id');
          if (!noteId || !window.dmSync) return;

          window.dmSync.getNote(noteId).then(function(note) {
            if (!note) return;
            var newPinned = !note.pinned;
            window.dmSync.firestoreWrite({
              collection: 'notes',
              docId: noteId,
              op: 'update',
              data: { pinned: newPinned, updatedAt: firebase.firestore.FieldValue.serverTimestamp() },
              localOp: function() { note.pinned = newPinned; note.updatedAt = Date.now(); return window.dmSync.putNote(note); }
            }).then(function() {
              loadFromCache();
              window.dispatchEvent(new CustomEvent('dm-sync-complete'));
            }).catch(function(err) {
              console.error('Pin toggle error:', err);
            });
          });
        });
      });

      // Edit buttons
      listEl.querySelectorAll('.section-notes-edit').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          var noteId = btn.getAttribute('data-id');

          if (window.dmSync && window.dmEditModal) {
            window.dmSync.getNote(noteId).then(function(note) {
              if (note) {
                window.dmEditModal.open(note, {
                  onSave: function() {
                    selfTriggeredSync = true;
                    loadFromCache();
                    setTimeout(function() { selfTriggeredSync = false; }, 200);
                  }
                });
              }
            });
          }
        });
      });
    }

    function loadFromCache() {
      if (!window.dmSync) return;
      showState('loading');

      window.dmSync.getNotesByDestination(destination).then(function(notes) {
        renderNotes(notes);
      }).catch(function(err) {
        console.error('Error loading notes from cache:', err);
        showState('empty');
      });
    }

    // Auth handling
    if (signinBtn) {
      signinBtn.addEventListener('click', function() {
        if (window.dmAuth && window.dmGoogleProvider) {
          window.dmAuth.signInWithPopup(window.dmGoogleProvider).catch(function(err) {
            console.error('Sign-in error:', err);
          });
        }
      });
    }

    // Listen for sync completion â€” reload notes (skip self-triggered events)
    window.addEventListener('dm-sync-complete', function(e) {
      if (selfTriggeredSync) return;
      if (e.detail && e.detail.source === 'edit-modal') return;
      if (window.dmAuth && window.dmAuth.currentUser) {
        loadFromCache();
      }
    });

    // Auth state
    if (window.dmAuth) {
      window.dmAuth.onAuthStateChanged(function(user) {
        if (user) {
          loadFromCache();
        } else {
          showState('auth');
        }
      });
    } else {
      showState('auth');
    }
  });
})();
</script>
