<!-- single-note: Renders a single Firestore note as a full page for a given destination -->
{{ $destination := .Get "destination" | default "inbox" }}

<div class="single-note" id="single-note-{{ $destination }}" data-destination="{{ $destination }}">
  <div class="single-note-auth" style="display: none;">
    <div class="single-note-auth-card">
      <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
      </svg>
      <h3>Sign in to view this page</h3>
      <p>Your notes are stored securely and require authentication.</p>
      <button type="button" class="single-note-signin-btn">
        <svg width="16" height="16" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
        Sign in with Google
      </button>
    </div>
  </div>

  <div class="single-note-loading" style="display: none;">
    <div class="single-note-spinner"></div>
    <span>Loading...</span>
  </div>

  <div class="single-note-empty" style="display: none;">
    <p>No content yet.</p>
    <button type="button" class="single-note-create-btn">Create Page</button>
  </div>

  <div class="single-note-content" style="display: none;">
    <div class="single-note-top-actions">
      <button type="button" class="single-note-merge-btn note-action-btn note-action-btn-edit" style="display: none;" title="Merge notes">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 6v12"></path><path d="M16 6v6"></path><path d="M16 12a4 4 0 0 1-4 4H8"></path><circle cx="8" cy="6" r="2"></circle><circle cx="16" cy="6" r="2"></circle><circle cx="8" cy="18" r="2"></circle></svg>
      </button>
      <button type="button" class="single-note-edit-btn note-action-btn note-action-btn-edit" title="Edit">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
      </button>
    </div>
    {{ if eq $destination "inbox" }}
    {{ partial "todo-list.html" . }}
    {{ end }}
    <div class="single-note-body markdown"></div>
  </div>
</div>

<style>
.single-note-auth {
  display: flex;
  justify-content: center;
  padding: 2rem 0;
}
.single-note-auth-card {
  text-align: center;
  padding: 2rem;
  border-radius: 12px;
  border: 1px solid var(--gray-200);
  max-width: 380px;
}
.single-note-auth-card h3 { margin: 1rem 0 0.5rem; }
.single-note-auth-card p { color: var(--gray-500); margin-bottom: 1.5rem; font-size: 0.9rem; }
.single-note-signin-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 24px;
  border: 1px solid var(--gray-300);
  border-radius: 8px;
  background: var(--body-background);
  color: var(--body-font-color);
  font-size: 14px;
  cursor: pointer;
  transition: background 0.2s, box-shadow 0.2s;
}
.single-note-signin-btn:hover { background: var(--gray-100); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.single-note-loading {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 2rem 0;
  justify-content: center;
  color: var(--gray-500);
}
.single-note-spinner {
  width: 20px; height: 20px;
  border: 2px solid var(--gray-200);
  border-top-color: var(--color-link);
  border-radius: 50%;
  animation: sn1-spin 0.8s linear infinite;
}
@keyframes sn1-spin { to { transform: rotate(360deg); } }
.single-note-empty {
  text-align: center;
  padding: 2rem 0;
  color: var(--gray-500);
}
.single-note-create-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 20px;
  margin-top: 0.75rem;
  border-radius: 8px;
  border: 1px solid var(--color-link);
  background: var(--body-background);
  color: var(--color-link);
  font-size: 0.85rem;
  cursor: pointer;
  transition: background 0.2s, color 0.2s;
}
.single-note-create-btn:hover { background: var(--color-link); color: #fff; }
.single-note-body {
  line-height: 1.7;
  word-wrap: break-word;
}
.single-note-body pre {
  border-radius: 8px;
  padding: 1rem;
  overflow-x: auto;
  background: var(--pre-bg, #f6f8fa);
}
.single-note-body code {
  font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
  font-size: 0.9em;
}
.single-note-body img { max-width: 100%; border-radius: 8px; }
.single-note-content {
  position: relative;
}
.single-note-top-actions {
  position: absolute;
  top: 0;
  right: 0;
  display: flex;
  gap: 4px;
  z-index: 1;
}
.note-action-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  border: 1px solid transparent;
  border-radius: 8px;
  background: none;
  color: var(--gray-400);
  cursor: pointer;
  transition: color 0.2s, background 0.2s, border-color 0.2s;
  line-height: 0;
}
.note-action-btn:hover {
  color: var(--body-font-color);
  background: var(--gray-100);
  border-color: var(--gray-200);
}
.note-action-btn-edit:hover {
  color: var(--color-link);
  background: rgba(0, 105, 255, 0.06);
  border-color: rgba(0, 105, 255, 0.2);
}
.note-action-btn-delete:hover {
  color: #e53e3e;
  background: rgba(229, 62, 62, 0.06);
  border-color: rgba(229, 62, 62, 0.2);
}
.note-action-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}
.single-note-merge-btn {
  /* inherits .note-action-btn */
}
</style>

<script>
(function() {
  'use strict';

  var containers = document.querySelectorAll('.single-note');
  if (!containers.length) return;

  containers.forEach(function(container) {
    var destination = container.getAttribute('data-destination');
    var authEl = container.querySelector('.single-note-auth');
    var loadingEl = container.querySelector('.single-note-loading');
    var emptyEl = container.querySelector('.single-note-empty');
    var contentEl = container.querySelector('.single-note-content');
    var bodyEl = container.querySelector('.single-note-body');
    var signinBtn = container.querySelector('.single-note-signin-btn');
    var createBtn = container.querySelector('.single-note-create-btn');
    var editBtn = container.querySelector('.single-note-edit-btn');
    var mergeBtn = container.querySelector('.single-note-merge-btn');

    var currentNote = null;
    var allDestNotes = [];
    var selfTriggeredSync = false;

    function showState(state) {
      authEl.style.display = state === 'auth' ? '' : 'none';
      loadingEl.style.display = state === 'loading' ? '' : 'none';
      emptyEl.style.display = state === 'empty' ? '' : 'none';
      contentEl.style.display = state === 'content' ? '' : 'none';
    }

    function renderNote(note) {
      currentNote = note;
      var content = note.content || '';

      // Strip leading top-level heading if present
      content = content.replace(/^\s*#\s+.+\n*/, '');

      // Build wikilink map if not yet populated
      var mapReady = Object.keys(window._wikilinkMap || {}).length > 0
        ? Promise.resolve()
        : (window.dmSync ? window.dmSync.getAllNotes().then(function(notes) { window.buildWikilinkMap(notes); }) : Promise.resolve());

      mapReady.then(function() {
        if (typeof marked !== 'undefined') {
          bodyEl.innerHTML = marked.parse(content);
        } else {
          bodyEl.textContent = content;
        }

        // Syntax highlighting
        bodyEl.querySelectorAll('pre code').forEach(function(block) {
          if (typeof hljs !== 'undefined') {
            hljs.highlightElement(block);
          }
        });

      // Enable interactive checkboxes
      if (window.dmEnableCheckboxes) {
        window.dmEnableCheckboxes(bodyEl, note, function(updated) {
          // Checkbox already toggled visually; no re-render needed
        });
      }

      // Render diagrams (Mermaid, PlantUML, D2, etc.)
      if (window.dmRenderDiagrams) {
        window.dmRenderDiagrams(bodyEl);
      }

      showState('content');

      // Fire event so dynamic ToC can be built
      window.dispatchEvent(new CustomEvent('dm-content-rendered'));
      });
    }

    function loadFromCache() {
      if (!window.dmSync) return;
      showState('loading');

      window.dmSync.getNotesByDestination(destination).then(function(notes) {
        if (notes && notes.length > 0) {
          // Sort by updatedAt desc to get the most recent
          notes.sort(function(a, b) { return (b.updatedAt || b.createdAt || 0) - (a.updatedAt || a.createdAt || 0); });
          allDestNotes = notes;
          renderNote(notes[0]);

          // Show merge button if multiple notes exist for this destination
          if (mergeBtn) {
            if (notes.length > 1) {
              mergeBtn.style.display = '';
              mergeBtn.title = 'Merge ' + notes.length + ' notes';
            } else {
              mergeBtn.style.display = 'none';
            }
          }
        } else {
          allDestNotes = [];
          if (mergeBtn) mergeBtn.style.display = 'none';
          showState('empty');
        }
      }).catch(function(err) {
        console.error('Error loading note from cache:', err);
        showState('empty');
      });
    }

    // Create initial note
    if (createBtn) {
      createBtn.addEventListener('click', function() {
        if (!window.dmAuth || !window.dmAuth.currentUser || !window.dmDb) return;

        createBtn.disabled = true;
        createBtn.textContent = 'Creating...';

        var user = window.dmAuth.currentUser;
        var destLabel = destination.charAt(0).toUpperCase() + destination.slice(1);

        var noteData = {
          userId: user.uid,
          userEmail: user.email,
          userName: user.displayName || '',
          title: destLabel,
          content: '',
          mode: 'note',
          language: null,
          destination: destination,
          bookTitle: null,
          tags: [destination],
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        var newDocId = window.dmDb ? window.dmDb.collection('notes').doc().id : ('local-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9));
        var localNote = Object.assign({}, noteData, {
          id: newDocId,
          createdAt: Date.now(),
          updatedAt: Date.now()
        });

        window.dmSync.firestoreWrite({
          collection: 'notes',
          docId: newDocId,
          op: 'set',
          data: noteData,
          localOp: function() { return window.dmSync.putNote(localNote); }
        })
          .then(function() {
            currentNote = localNote;
            // Open the edit modal immediately so user can start writing
            if (window.dmEditModal) {
              window.dmEditModal.open(localNote, {
                onSave: function(updatedNote) {
                  selfTriggeredSync = true;
                  renderNote(updatedNote);
                  setTimeout(function() { selfTriggeredSync = false; }, 200);
                }
              });
            }
            showState('content');
            bodyEl.innerHTML = '<p style="color: var(--gray-400); font-style: italic;">Start writing by clicking Edit below.</p>';
            window.dispatchEvent(new CustomEvent('dm-sync-complete'));
          })
          .catch(function(err) {
            console.error('Error creating note:', err);
            createBtn.disabled = false;
            createBtn.textContent = 'Create Page';
            alert('Failed to create page. Please try again.');
          });
      });
    }

    // Edit button
    if (editBtn) {
      editBtn.addEventListener('click', function() {
        if (!currentNote || !window.dmEditModal) return;
        window.dmEditModal.open(currentNote, {
          onSave: function(updatedNote) {
            selfTriggeredSync = true;
            renderNote(updatedNote);
            setTimeout(function() { selfTriggeredSync = false; }, 200);
          }
        });
      });
    }

    // Merge button â€” combines multiple notes for this destination into one
    if (mergeBtn) {
      mergeBtn.addEventListener('click', function() {
        if (allDestNotes.length < 2) return;
        if (!window.dmDb || !window.dmSync || !window.dmAuth || !window.dmAuth.currentUser) return;
        if (!confirm('Merge ' + allDestNotes.length + ' notes into one? Extra notes will be deleted. This cannot be undone.')) return;

        mergeBtn.disabled = true;
        mergeBtn.title = 'Merging...';

        // Sort by createdAt ascending (oldest = base)
        var sorted = allDestNotes.slice().sort(function(a, b) { return (a.createdAt || 0) - (b.createdAt || 0); });
        var base = sorted[0];
        var others = sorted.slice(1);

        // Build merged content
        var mergedContent = base.content || '';
        var allTags = base.tags ? base.tags.slice() : [];

        others.forEach(function(note) {
          var separator = '\n\n---\n\n';
          var heading = note.title ? ('## ' + note.title + '\n\n') : '';
          mergedContent += separator + heading + (note.content || '');
          if (note.tags) {
            note.tags.forEach(function(t) {
              if (allTags.indexOf(t) === -1) allTags.push(t);
            });
          }
        });

        var destLabel = destination.charAt(0).toUpperCase() + destination.slice(1);
        var updateData = {
          title: destLabel,
          content: mergedContent,
          tags: allTags,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        window.dmSync.firestoreWrite({
          collection: 'notes',
          docId: base.id,
          op: 'update',
          data: updateData,
          localOp: function() {
            base.title = destLabel;
            base.content = mergedContent;
            base.tags = allTags;
            base.updatedAt = Date.now();
            return window.dmSync.putNote(base);
          }
        })
          .then(function() {
            // Delete extra notes sequentially
            var chain = Promise.resolve();
            others.forEach(function(note) {
              chain = chain.then(function() {
                return window.dmSync.firestoreWrite({
                  collection: 'notes',
                  docId: note.id,
                  op: 'delete',
                  data: null,
                  localOp: function() { return window.dmSync.deleteNote(note.id); }
                });
              });
            });
            return chain;
          })
          .then(function() {
            selfTriggeredSync = true;
            allDestNotes = [base];
            renderNote(base);
            mergeBtn.style.display = 'none';
            mergeBtn.disabled = false;
            window.dispatchEvent(new CustomEvent('dm-sync-complete'));
            setTimeout(function() { selfTriggeredSync = false; }, 200);
          })
          .catch(function(err) {
            console.error('Merge error:', err);
            mergeBtn.disabled = false;
            mergeBtn.title = 'Merge Notes';
            alert('Failed to merge. Please try again.');
          });
      });
    }

    // Auth handling
    if (signinBtn) {
      signinBtn.addEventListener('click', function() {
        if (window.dmAuth && window.dmGoogleProvider) {
          window.dmAuth.signInWithPopup(window.dmGoogleProvider).catch(function(err) {
            console.error('Sign-in error:', err);
          });
        }
      });
    }

    // Listen for sync completion
    window.addEventListener('dm-sync-complete', function(e) {
      if (selfTriggeredSync) return;
      if (window._dmCheckboxSyncing) return;
      if (e.detail && e.detail.source === 'edit-modal') return;
      if (window.dmAuth && window.dmAuth.currentUser) {
        loadFromCache();
      }
    });

    // Auth state
    if (window.dmAuth) {
      window.dmAuth.onAuthStateChanged(function(user) {
        if (user) {
          loadFromCache();
        } else {
          showState('auth');
        }
      });
    } else {
      showState('auth');
    }
  });
})();
</script>
