<!-- note-viewer: Renders a single note from IndexedDB by ?id= URL parameter -->
<div id="note-viewer" class="note-viewer">
  <div id="note-viewer-auth" class="note-viewer-auth" style="display: none;">
    <div class="note-viewer-auth-card">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
      </svg>
      <h3>Sign in to view this note</h3>
      <p>Your notes are stored securely and require authentication to view.</p>
      <button type="button" class="note-viewer-signin-btn" id="note-viewer-signin">
        <svg width="18" height="18" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
        Sign in with Google
      </button>
    </div>
  </div>

  <div id="note-viewer-loading" class="note-viewer-loading" style="display: none;">
    <div class="note-viewer-spinner"></div>
    <p>Loading note...</p>
  </div>

  <div id="note-viewer-error" class="note-viewer-error" style="display: none;">
    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="10"></circle>
      <line x1="12" y1="8" x2="12" y2="12"></line>
      <line x1="12" y1="16" x2="12.01" y2="16"></line>
    </svg>
    <h3 id="note-viewer-error-title">Note not found</h3>
    <p id="note-viewer-error-msg">This note may have been deleted or you don't have access to it.</p>
    <a href="{{ "docs/" | relURL }}" class="note-viewer-back-link">Back to home</a>
  </div>

  <div id="note-viewer-content" class="note-viewer-content" style="display: none;">
    <div class="note-viewer-header">
      <div class="note-viewer-title-row">
        <h1 id="note-viewer-title" class="note-viewer-title"></h1>
        <div class="note-viewer-title-right">
          <span class="note-viewer-date" id="note-viewer-date"></span>
          <div class="note-viewer-top-actions">
            <button type="button" class="note-action-btn note-action-btn-edit" id="note-viewer-edit" title="Edit">
              <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
            </button>
            <button type="button" class="note-action-btn note-action-btn-delete" id="note-viewer-delete" title="Delete">
              <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
            </button>
          </div>
        </div>
      </div>
      <div class="note-viewer-sub">
        <span class="note-viewer-destination" id="note-viewer-destination"></span>
        <div class="note-viewer-tags" id="note-viewer-tags"></div>
      </div>
    </div>
    <div class="note-viewer-body markdown" id="note-viewer-body"></div>
    <div class="backlinks-section" id="backlinks-section" style="display: none;">
      <h3 class="backlinks-title">Linked from</h3>
      <div class="backlinks-list" id="backlinks-list"></div>
    </div>
  </div>
</div>

<style>
.note-viewer-auth, .note-viewer-loading, .note-viewer-error {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 300px;
  text-align: center;
  color: var(--body-font-color);
}
.note-viewer-auth-card {
  padding: 2rem;
  border-radius: 12px;
  background: var(--body-background);
  border: 1px solid var(--gray-200);
  max-width: 400px;
}
.note-viewer-auth-card h3 { margin: 1rem 0 0.5rem; }
.note-viewer-auth-card p { color: var(--gray-500); margin-bottom: 1.5rem; }
.note-viewer-signin-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 24px;
  border: 1px solid var(--gray-300);
  border-radius: 8px;
  background: var(--body-background);
  color: var(--body-font-color);
  font-size: 14px;
  cursor: pointer;
  transition: background 0.2s, box-shadow 0.2s;
}
.note-viewer-signin-btn:hover {
  background: var(--gray-100);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.note-viewer-spinner {
  width: 32px; height: 32px;
  border: 3px solid var(--gray-200);
  border-top-color: var(--color-link);
  border-radius: 50%;
  animation: nv-spin 0.8s linear infinite;
}
@keyframes nv-spin { to { transform: rotate(360deg); } }
.note-viewer-error svg { color: var(--gray-400); margin-bottom: 1rem; }
.note-viewer-back-link {
  display: inline-block;
  margin-top: 1rem;
  color: var(--color-link);
  text-decoration: none;
}
.note-viewer-header { margin-bottom: 1.5rem; border-bottom: 1px solid var(--gray-200); padding-bottom: 1rem; }
.note-viewer-title-row {
  display: flex;
  align-items: baseline;
  justify-content: space-between;
  gap: 16px;
}
.note-viewer-title { margin: 0; font-size: 1.75rem; flex: 1; min-width: 0; }
.note-viewer-title-right {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
}
.note-viewer-date {
  font-size: 0.8rem;
  color: var(--gray-400);
  white-space: nowrap;
}
.note-viewer-top-actions {
  display: flex;
  gap: 4px;
}
.note-action-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  border: 1px solid transparent;
  border-radius: 8px;
  background: none;
  color: var(--gray-400);
  cursor: pointer;
  transition: color 0.2s, background 0.2s, border-color 0.2s;
  line-height: 0;
}
.note-action-btn:hover {
  color: var(--body-font-color);
  background: var(--gray-100);
  border-color: var(--gray-200);
}
.note-action-btn-edit:hover {
  color: var(--color-link);
  background: rgba(0, 105, 255, 0.06);
  border-color: rgba(0, 105, 255, 0.2);
}
.note-action-btn-delete:hover {
  color: #e53e3e;
  background: rgba(229, 62, 62, 0.06);
  border-color: rgba(229, 62, 62, 0.2);
}
.note-action-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}
.note-viewer-sub {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 0.5rem;
}
.note-viewer-destination {
  display: inline-flex;
  align-items: center;
  padding: 2px 10px;
  border-radius: 12px;
  background: var(--gray-100);
  font-size: 0.75rem;
  color: var(--gray-500);
  text-transform: capitalize;
}
.note-viewer-tags { display: flex; flex-wrap: wrap; gap: 5px; }
.note-viewer-tag {
  display: inline-block;
  padding: 1px 8px;
  border-radius: 10px;
  background: var(--gray-100);
  color: var(--gray-500);
  font-size: 0.7rem;
}
.note-viewer-body {
  line-height: 1.7;
  word-wrap: break-word;
}
.note-viewer-body pre {
  border-radius: 8px;
  padding: 1rem;
  overflow-x: auto;
  background: var(--pre-bg, #f6f8fa);
}
.note-viewer-body code {
  font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
  font-size: 0.9em;
}
.note-viewer-body img { max-width: 100%; border-radius: 8px; }
</style>

<script>
(function() {
  'use strict';

  var viewerEl = document.getElementById('note-viewer');
  if (!viewerEl) return;

  var authEl = document.getElementById('note-viewer-auth');
  var loadingEl = document.getElementById('note-viewer-loading');
  var errorEl = document.getElementById('note-viewer-error');
  var contentEl = document.getElementById('note-viewer-content');
  var signinBtn = document.getElementById('note-viewer-signin');
  var titleEl = document.getElementById('note-viewer-title');
  var dateEl = document.getElementById('note-viewer-date');
  var destEl = document.getElementById('note-viewer-destination');
  var tagsEl = document.getElementById('note-viewer-tags');
  var bodyEl = document.getElementById('note-viewer-body');
  var editBtn = document.getElementById('note-viewer-edit');
  var deleteBtn = document.getElementById('note-viewer-delete');
  var errorTitleEl = document.getElementById('note-viewer-error-title');
  var errorMsgEl = document.getElementById('note-viewer-error-msg');

  var currentNote = null;
  var selfTriggeredSync = false;

  // Backlinks elements
  var backlinksSectionEl = document.getElementById('backlinks-section');
  var backlinksListEl = document.getElementById('backlinks-list');

  function getBaseUrl() {
    var manifest = document.querySelector('link[rel="manifest"]');
    return manifest ? manifest.getAttribute('href').replace('/manifest.json', '') : '';
  }

  function escapeHtml(str) {
    if (!str) return '';
    var div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function loadBacklinks(noteId) {
    if (!window.dmSync || !window.dmSync.getBacklinksForNote) return;
    window.dmSync.getBacklinksForNote(noteId).then(function(results) {
      if (!results || !results.length) {
        backlinksSectionEl.style.display = 'none';
        return;
      }
      var base = getBaseUrl();
      var html = '';
      results.forEach(function(r) {
        var badge = r.type === 'wikilink'
          ? '<span class="backlink-badge backlink-explicit">linked</span>'
          : '<span class="backlink-badge backlink-mention">mentioned</span>';
        html += '<a class="backlink-card" href="' + base + '/docs/view/?id=' + encodeURIComponent(r.note.id) + '">'
          + '<span class="backlink-card-title">' + escapeHtml(r.note.title || 'Untitled') + '</span>'
          + badge
          + '</a>';
      });
      backlinksListEl.innerHTML = html;
      backlinksSectionEl.style.display = '';
    });
  }

  // Get note ID from URL
  var params = new URLSearchParams(window.location.search);
  var noteId = params.get('id');

  function showState(state) {
    authEl.style.display = state === 'auth' ? '' : 'none';
    loadingEl.style.display = state === 'loading' ? '' : 'none';
    errorEl.style.display = state === 'error' ? '' : 'none';
    contentEl.style.display = state === 'content' ? '' : 'none';
  }

  function formatDate(ms) {
    if (!ms) return '';
    var d = new Date(ms);
    var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    return months[d.getMonth()] + ' ' + d.getDate() + ', ' + d.getFullYear();
  }

  function getDestinationLabel(note) {
    if (note.destination === 'book-note' && note.bookTitle) return note.bookTitle;
    if (note.destination === 'snippets' && note.language) return note.language + ' snippet';
    if (note.destination === 'inbox') return 'Inbox';
    if (note.destination === 'topic') return 'Topics';
    if (note.destination === 'book-note') return 'Books';
    return note.destination || '';
  }

  function renderNote(note) {
    currentNote = note;
    titleEl.textContent = note.title;
    dateEl.textContent = formatDate(note.createdAt);
    destEl.textContent = getDestinationLabel(note);

    // Tags
    tagsEl.innerHTML = '';
    if (note.tags && note.tags.length) {
      note.tags.forEach(function(tag) {
        var span = document.createElement('span');
        span.className = 'note-viewer-tag';
        span.textContent = tag;
        tagsEl.appendChild(span);
      });
    }

    // Build wikilink map if not yet populated, then render
    var mapReady = Object.keys(window._wikilinkMap || {}).length > 0
      ? Promise.resolve()
      : (window.dmSync ? window.dmSync.getAllNotes().then(function(notes) { window.buildWikilinkMap(notes); }) : Promise.resolve());

    mapReady.then(function() {
      // Render markdown content
      var content = note.content || '';

      // Strip leading top-level heading — the viewer header already shows the title
      content = content.replace(/^\s*#\s+.+\n*/, '');

      if (note.mode === 'code' && note.language) {
        // For code snippets, wrap in a code block if not already
        if (!content.trim().startsWith('```')) {
          content = '```' + note.language + '\n' + content + '\n```';
        }
      }

      bodyEl.innerHTML = marked.parse(content);

      // Apply syntax highlighting to code blocks
      bodyEl.querySelectorAll('pre code').forEach(function(block) {
        if (typeof hljs !== 'undefined') {
          hljs.highlightElement(block);
        }
      });

      // Enable interactive checkboxes
      if (window.dmEnableCheckboxes) {
        window.dmEnableCheckboxes(bodyEl, note, function(updated) {
          // Checkbox already toggled visually; no re-render needed
        });
      }

      // Render diagrams (Mermaid, PlantUML, D2, etc.)
      if (window.dmRenderDiagrams) {
        window.dmRenderDiagrams(bodyEl);
      }

      // Load backlinks
      loadBacklinks(note.id);

      // Fire event so dynamic ToC can be built
      window.dispatchEvent(new CustomEvent('dm-content-rendered'));

      // Update breadcrumbs dynamically
      updateBreadcrumbs(note);

      showState('content');
    });
  }

  function updateBreadcrumbs(note) {
    var breadcrumbs = document.querySelector('.breadcrumbs ol');
    if (!breadcrumbs) return;

    var baseUrl = document.querySelector('link[rel="manifest"]');
    var base = '';
    if (baseUrl) {
      base = baseUrl.getAttribute('href').replace('/manifest.json', '');
    }

    var items = '<li><a href="' + base + '/">Home</a></li>';

    if (note.destination === 'book-note') {
      items += '<li><a href="' + base + '/docs/books/">Books</a></li>';
      if (note.bookTitle) {
        items += '<li><span>' + note.bookTitle + '</span></li>';
      }
    } else if (note.destination === 'snippets') {
      items += '<li><a href="' + base + '/docs/snippets/">Snippets</a></li>';
      if (note.language) {
        var lang = note.language.charAt(0).toUpperCase() + note.language.slice(1);
        items += '<li><span>' + lang + '</span></li>';
      }
    } else if (note.destination === 'inbox') {
      items += '<li><a href="' + base + '/docs/inbox/">Inbox</a></li>';
    } else if (note.destination === 'topic') {
      items += '<li><a href="' + base + '/docs/topics/">Topics</a></li>';
    }

    items += '<li aria-current="page"><span>' + (note.title || 'Untitled') + '</span></li>';
    breadcrumbs.innerHTML = items;

    // Update page title
    document.title = (note.title || 'Note') + ' | Digital Memory';
  }

  function loadNote() {
    if (!noteId) {
      errorTitleEl.textContent = 'No note specified';
      errorMsgEl.textContent = 'Please select a note from the sidebar or a section page.';
      showState('error');
      return;
    }

    showState('loading');

    if (!window.dmSync) {
      setTimeout(loadNote, 100);
      return;
    }

    window.dmSync.getNote(noteId).then(function(note) {
      if (note) {
        renderNote(note);
      } else {
        // Note not in cache yet, might need sync first
        errorTitleEl.textContent = 'Note not found';
        errorMsgEl.textContent = 'This note may have been deleted, or try refreshing after sync completes.';
        showState('error');
      }
    }).catch(function(err) {
      console.error('Error loading note:', err);
      errorTitleEl.textContent = 'Error loading note';
      errorMsgEl.textContent = err.message || 'An unexpected error occurred.';
      showState('error');
    });
  }

  // Auth handling
  signinBtn.addEventListener('click', function() {
    if (window.dmAuth && window.dmGoogleProvider) {
      window.dmAuth.signInWithPopup(window.dmGoogleProvider).catch(function(err) {
        console.error('Sign-in error:', err);
      });
    }
  });

  // Edit button — opens shared edit modal
  editBtn.addEventListener('click', function() {
    if (!currentNote) return;
    if (window.dmEditModal) {
      window.dmEditModal.open(currentNote, {
        onSave: function(updatedNote) {
          selfTriggeredSync = true;
          renderNote(updatedNote);
          setTimeout(function() { selfTriggeredSync = false; }, 200);
        }
      });
    }
  });

  // Delete functionality
  deleteBtn.addEventListener('click', function() {
    if (!currentNote) return;
    if (!confirm('Are you sure you want to delete "' + (currentNote.title || 'this note') + '"? This cannot be undone.')) return;

    deleteBtn.disabled = true;

    window.dmSync.firestoreWrite({
      collection: 'notes',
      docId: currentNote.id,
      op: 'delete',
      data: null,
      localOp: function() { return window.dmSync.deleteNote(currentNote.id); }
    })
      .then(function() {
        // Navigate back to section
        var base = '';
        var baseUrl = document.querySelector('link[rel="manifest"]');
        if (baseUrl) base = baseUrl.getAttribute('href').replace('/manifest.json', '');

        var dest = currentNote.destination;
        if (dest === 'book-note') window.location.href = base + '/docs/books/';
        else if (dest === 'snippets') window.location.href = base + '/docs/snippets/';
        else if (dest === 'topic') window.location.href = base + '/docs/topics/';
        else window.location.href = base + '/docs/inbox/';
      })
      .catch(function(err) {
        console.error('Error deleting note:', err);
        deleteBtn.disabled = false;
        alert('Failed to delete note. Please try again.');
      });
  });

  // Listen for sync completion to reload note (skip self-triggered events)
  window.addEventListener('dm-sync-complete', function(e) {
    if (selfTriggeredSync) return;
    if (window._dmCheckboxSyncing) return;
    if (e.detail && e.detail.source === 'edit-modal') return;
    if (noteId && window.dmAuth && window.dmAuth.currentUser) {
      loadNote();
    }
  });

  // Auth state change
  if (window.dmAuth) {
    window.dmAuth.onAuthStateChanged(function(user) {
      if (user) {
        loadNote();
      } else {
        showState('auth');
      }
    });
  } else {
    showState('auth');
  }
})();
</script>
