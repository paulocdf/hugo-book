<!-- Garden Sections: dynamically populated from IndexedDB -->
<div class="garden-sections">

<div class="section-card card-inbox">
<h3><a href="{{ "docs/inbox/" | relURL }}">Inbox</a></h3>
<p>Quick notes and ideas waiting to be organized.</p>
<div id="garden-section-inbox"><em>Loading...</em></div>
</div>

<div class="section-card card-books">
<h3><a href="{{ "docs/books/" | relURL }}">Books</a></h3>
<p>Notes and highlights from books I've read.</p>
<ul id="garden-section-books"><li><em>Loading...</em></li></ul>
</div>

<div class="section-card card-topics">
<h3><a href="{{ "docs/topics/" | relURL }}">Topics</a></h3>
<p>Technical topics, concepts, and reference material.</p>
<ul id="garden-section-topics"><li><em>Loading...</em></li></ul>
</div>

<div class="section-card card-dashboard">
<h3><a href="{{ "docs/dashboard/" | relURL }}">Dashboard</a></h3>
<p>Time tracking insights: estimated vs actual, categories, and more.</p>
<div id="garden-section-dashboard"><em>Loading...</em></div>
</div>

</div>

<script>
(function() {
  var MAX_BOOKS = 10;
  var MAX_TOPICS = 5;

  function getBaseUrl() {
    var manifest = document.querySelector('link[rel="manifest"]');
    if (manifest) return manifest.getAttribute('href').replace('/manifest.json', '');
    return '';
  }

  function escapeHtml(str) {
    if (!str) return '';
    var div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function updateSections() {
    if (!window.dmSync) return;
    var baseUrl = getBaseUrl();

    window.dmSync.getAllNotes().then(function(notes) {
      if (!notes) return;

      var books = [], topics = [], inbox = [];
      notes.forEach(function(n) {
        if (n.destination === 'book-note') books.push(n);
        else if (n.destination === 'topic') topics.push(n);
        else if (n.destination === 'inbox') inbox.push(n);
      });

      function renderList(elId, items, max, sectionPath, emptyMsg) {
        var el = document.getElementById(elId);
        if (!el) return;
        if (!items.length) {
          el.innerHTML = '<li><em>' + emptyMsg + '</em></li>';
          return;
        }
        var shown = items.slice(0, max);
        var html = shown.map(function(n) {
          var url = baseUrl + '/docs/view/?id=' + encodeURIComponent(n.id);
          return '<li><a href="' + url + '">' + escapeHtml(n.title || 'Untitled') + '</a></li>';
        }).join('');
        if (items.length > max) {
          html += '<li class="garden-section-viewall"><a href="' + baseUrl + sectionPath + '">View all ' + items.length + '</a></li>';
        }
        el.innerHTML = html;
      }

      // Render inbox as a content preview (single-note model)
      function renderInboxPreview() {
        var el = document.getElementById('garden-section-inbox');
        if (!el) return;
        if (!inbox.length) {
          el.innerHTML = '<em>Your inbox is empty. Add some quick notes!</em>';
          return;
        }
        inbox.sort(function(a, b) { return (b.updatedAt || b.createdAt || 0) - (a.updatedAt || a.createdAt || 0); });
        var note = inbox[0];
        var content = note.content || '';
        content = content.replace(/^\s*#\s+.+\n*/, '');
        var preview = content.length > 200 ? content.substring(0, 200) + '...' : content;
        el.innerHTML = '<p style="font-size: 0.85rem; color: var(--gray-500); line-height: 1.5; margin: 0;">' + escapeHtml(preview) + '</p>';
      }

      // Sort by most recently updated
      books.sort(function(a, b) { return (b.updatedAt || b.createdAt || 0) - (a.updatedAt || a.createdAt || 0); });
      topics.sort(function(a, b) { return (b.updatedAt || b.createdAt || 0) - (a.updatedAt || a.createdAt || 0); });

      renderInboxPreview();
      renderList('garden-section-books', books, MAX_BOOKS, '/docs/books/', 'No book notes yet.');
      renderList('garden-section-topics', topics, MAX_TOPICS, '/docs/topics/', 'Start adding topics to grow your knowledge graph.');
      renderDashboardPreview();
    });
  }

  function renderDashboardPreview() {
    var el = document.getElementById('garden-section-dashboard');
    if (!el || !window.dmSync) return;

    window.dmSync.getAllTodos().then(function(todos) {
      if (!todos || !todos.length) {
        el.innerHTML = '<em style="font-size: 0.85rem; color: var(--gray-500);">No tasks yet. Add tasks in your Inbox to see insights here.</em>';
        return;
      }
      var done = 0, totalEst = 0, totalActual = 0;
      todos.forEach(function(t) {
        if (t.done) {
          done++;
          if (t.actualMin) totalActual += t.actualMin;
        }
        if (t.estimatedMin) totalEst += t.estimatedMin;
      });
      var pomActual = (totalActual / 25).toFixed(1);
      var html = '<div style="display: flex; gap: 16px; flex-wrap: wrap; font-size: 0.85rem;">';
      html += '<span style="color: var(--gray-500);"><strong style="color: var(--body-font-color);">' + done + '/' + todos.length + '</strong> done</span>';
      if (totalActual) html += '<span style="color: var(--gray-500);"><strong style="color: var(--body-font-color);">' + totalActual + 'min</strong> tracked (' + pomActual + ' pom)</span>';
      html += '</div>';
      el.innerHTML = html;
    });
  }

  window.addEventListener('dm-sync-complete', updateSections);

  if (window.dmAuth) {
    window.dmAuth.onAuthStateChanged(function(user) {
      if (user) {
        updateSections();
      } else {
        ['garden-section-books', 'garden-section-topics'].forEach(function(id) {
          var el = document.getElementById(id);
          if (el) el.innerHTML = '<li><em>Sign in to see your notes.</em></li>';
        });
        var inboxEl = document.getElementById('garden-section-inbox');
        if (inboxEl) inboxEl.innerHTML = '<em>Sign in to see your notes.</em>';
        var dashEl = document.getElementById('garden-section-dashboard');
        if (dashEl) dashEl.innerHTML = '<em>Sign in to see your data.</em>';
      }
    });
  }
})();
</script>
