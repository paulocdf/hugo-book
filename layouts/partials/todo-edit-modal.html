<!-- Todo Edit Modal — shown when user clicks the edit button on a task -->
<!-- Exposes: window.dmTodoEdit.open(todo, onSave), window.dmTodoEdit.close() -->
<div class="todo-edit-modal" id="todo-edit-modal" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="todo-edit-heading">
  <div class="todo-edit-backdrop" id="todo-edit-backdrop"></div>
  <div class="todo-edit-dialog">
    <div class="todo-edit-header">
      <h3 id="todo-edit-heading">Edit Task</h3>
      <button type="button" class="todo-edit-close" id="todo-edit-close">&times;</button>
    </div>

    <div class="todo-edit-field">
      <label for="todo-edit-title">Title</label>
      <textarea id="todo-edit-title" class="todo-edit-input todo-edit-title-area" placeholder="Task title" autocomplete="off" ></textarea>
    </div>

    <div class="todo-edit-row todo-edit-bujo-row">
      <div class="todo-edit-field todo-edit-half">
        <label>Type</label>
        <div class="todo-edit-bujo-toggle" id="todo-edit-bujo-type">
          <button type="button" class="todo-edit-bujo-btn active" data-bujo-type="task" title="Task">
            <svg width="12" height="12" viewBox="0 0 16 16"><circle cx="8" cy="8" r="4" fill="currentColor"/></svg> Task
          </button>
          <button type="button" class="todo-edit-bujo-btn" data-bujo-type="event" title="Event">
            <svg width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="8" cy="8" r="5.5"/></svg> Event
          </button>
          <button type="button" class="todo-edit-bujo-btn" data-bujo-type="note" title="Note">
            <svg width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="3" y1="8" x2="13" y2="8"/></svg> Note
          </button>
        </div>
      </div>
      <div class="todo-edit-field todo-edit-half" id="todo-edit-state-field">
        <label>State</label>
        <div class="todo-edit-bujo-toggle" id="todo-edit-bujo-state">
          <button type="button" class="todo-edit-bujo-btn active" data-bujo-state="open" title="Open">
            <svg width="10" height="10" viewBox="0 0 16 16"><circle cx="8" cy="8" r="4" fill="currentColor"/></svg> Open
          </button>
          <button type="button" class="todo-edit-bujo-btn" data-bujo-state="done" title="Done">
            <svg width="10" height="10" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3,8 7,12 13,4"/></svg> Done
          </button>
          <button type="button" class="todo-edit-bujo-btn" data-bujo-state="migrated" title="Migrated">
            <svg width="10" height="10" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6,3 13,8 6,13"/></svg> Migrated
          </button>
          <button type="button" class="todo-edit-bujo-btn" data-bujo-state="scheduled" title="Scheduled">
            <svg width="10" height="10" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polyline points="10,3 3,8 10,13"/></svg> Sched.
          </button>
        </div>
      </div>
    </div>

    <div class="todo-edit-row">
      <div class="todo-edit-field todo-edit-half">
        <label for="todo-edit-date">Scheduled date</label>
        <input type="date" id="todo-edit-date" class="todo-edit-input">
      </div>
      <div class="todo-edit-field todo-edit-half">
        <label for="todo-edit-estimate">Estimate (min)</label>
        <input type="number" id="todo-edit-estimate" class="todo-edit-input" min="1" max="480" placeholder="e.g. 30">
      </div>
    </div>

    <div class="todo-edit-field">
      <label>Category</label>
      <div class="todo-edit-category-row" style="position: relative;">
        <div class="todo-edit-category-chips" id="todo-edit-category-chips"></div>
        <input type="text" id="todo-edit-category-input" class="todo-edit-category-input" placeholder="Add category + Enter" autocomplete="off">
        <div class="todo-edit-category-dropdown" id="todo-edit-category-dropdown"></div>
      </div>
    </div>

    <!-- AI suggestions area -->
    <div class="todo-edit-ai-section" id="todo-edit-ai-section" style="display: none;">
      <div class="todo-edit-ai-header">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"></path><path d="M2 17l10 5 10-5"></path><path d="M2 12l10 5 10-5"></path></svg>
        <span>AI Suggestions</span>
      </div>
      <div class="todo-edit-ai-cards" id="todo-edit-ai-cards"></div>
    </div>

    <div class="todo-edit-actions">
      <button type="button" class="todo-edit-btn-cancel" id="todo-edit-cancel">Cancel</button>
      <button type="button" class="todo-edit-btn-save" id="todo-edit-save">Save Changes</button>
    </div>
    <div class="todo-edit-hints">
      <kbd>Esc</kbd> cancel &middot; <kbd>Cmd+Enter</kbd> save
    </div>
  </div>
</div>

<style>
.todo-edit-modal {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  z-index: 1100;
  display: flex;
  align-items: center;
  justify-content: center;
}
.todo-edit-backdrop {
  position: absolute; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5);
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
}
.todo-edit-dialog {
  position: relative;
  background: var(--body-background);
  border-radius: 14px;
  padding: 1.75rem;
  width: 94%;
  max-width: 680px;
  box-shadow: 0 24px 64px rgba(0,0,0,0.3);
  animation: todo-edit-in 0.2s ease-out;
  max-height: 90vh;
  overflow-y: auto;
}
@keyframes todo-edit-in {
  from { opacity: 0; transform: translateY(12px) scale(0.97); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}
.todo-edit-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}
.todo-edit-header h3 { margin: 0; font-size: 1.05rem; font-weight: 700; }
.todo-edit-close {
  background: none; border: none; font-size: 1.5rem;
  cursor: pointer; color: var(--body-font-color); padding: 4px 8px;
  border-radius: 6px; transition: background 0.15s;
}
.todo-edit-close:hover { background: var(--gray-100); }

.todo-edit-field {
  margin-bottom: 0.85rem;
}
.todo-edit-field label {
  display: block;
  font-size: 0.78rem;
  font-weight: 600;
  color: var(--gray-500);
  margin-bottom: 4px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.todo-edit-input {
  width: 100%;
  padding: 10px 12px;
  border: 1.5px solid var(--gray-200);
  border-radius: 8px;
  background: var(--body-background);
  font-size: 0.92rem;
  font-family: inherit;
  color: var(--body-font-color);
  transition: border-color 0.15s;
  box-sizing: border-box;
}
.todo-edit-input:focus {
  outline: none;
  border-color: var(--color-link);
}
/* Auto-growing textarea for title */
.todo-edit-title-area {
  resize: none;
  overflow: hidden;
  min-height: 42px;
  max-height: 200px;
  line-height: 1.4;
  font-size: 1rem;
  font-weight: 500;
}
.todo-edit-row {
  display: flex;
  gap: 12px;
}
.todo-edit-half {
  flex: 1;
  min-width: 0;
}

/* Category chips & dropdown — mirrors completion modal */
.todo-edit-category-row {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  align-items: center;
  padding: 6px 10px;
  border: 1.5px solid var(--gray-200);
  border-radius: 8px;
  background: var(--body-background);
  transition: border-color 0.15s;
  min-height: 36px;
}
.todo-edit-category-row:focus-within {
  border-color: var(--color-link);
}
.todo-edit-category-chips {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
}
.todo-edit-category-chip {
  display: inline-flex;
  align-items: center;
  gap: 3px;
  padding: 2px 8px;
  background: var(--gray-100);
  border-radius: 12px;
  font-size: 0.78rem;
  color: var(--body-font-color);
  white-space: nowrap;
}
.todo-edit-category-remove {
  background: none;
  border: none;
  cursor: pointer;
  color: var(--gray-400);
  font-size: 0.85rem;
  padding: 0 2px;
  line-height: 1;
}
.todo-edit-category-remove:hover {
  color: var(--color-danger);
}
.todo-edit-category-input {
  flex: 1;
  min-width: 80px;
  border: none;
  outline: none;
  background: transparent;
  font-size: 0.85rem;
  font-family: inherit;
  color: var(--body-font-color);
  padding: 2px 0;
}
.todo-edit-category-dropdown {
  display: none;
  position: absolute;
  left: 0; right: 0; top: 100%;
  margin-top: 4px;
  background: var(--body-background);
  border: 1px solid var(--gray-200);
  border-radius: 8px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.12);
  max-height: 150px;
  overflow-y: auto;
  z-index: 10;
}
.todo-edit-category-dropdown.show { display: block; }
.todo-edit-category-option {
  padding: 6px 12px;
  font-size: 0.85rem;
  cursor: pointer;
  transition: background 0.1s;
}
.todo-edit-category-option:hover,
.todo-edit-category-option.active {
  background: var(--gray-100);
}
.todo-edit-category-option .cat-highlight {
  font-weight: 700;
  text-decoration: underline;
}

/* AI suggestions */
.todo-edit-bujo-row {
  margin-bottom: 0.85rem;
}
.todo-edit-bujo-toggle {
  display: inline-flex;
  gap: 2px;
  border: 1px solid var(--gray-200);
  border-radius: 8px;
  padding: 2px;
  background: var(--body-background);
}
.todo-edit-bujo-btn {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 8px;
  border: none;
  border-radius: 6px;
  background: transparent;
  color: var(--gray-400);
  cursor: pointer;
  font-size: 0.75rem;
  font-family: inherit;
  font-weight: 500;
  transition: color 0.15s, background 0.15s;
  line-height: 1;
  white-space: nowrap;
}
.todo-edit-bujo-btn:hover {
  color: var(--body-font-color);
  background: var(--gray-100);
}
.todo-edit-bujo-btn.active {
  color: var(--body-font-color);
  background: var(--gray-200);
}
.todo-edit-bujo-btn[data-bujo-type="task"].active,
.todo-edit-bujo-btn[data-bujo-state="open"].active { color: #3d3d3d; }
.todo-edit-bujo-btn[data-bujo-type="event"].active { color: #4a7a9b; }
.todo-edit-bujo-btn[data-bujo-type="note"].active { color: #888; }
.todo-edit-bujo-btn[data-bujo-state="done"].active { color: #7a7a7a; }
.todo-edit-bujo-btn[data-bujo-state="migrated"].active { color: #8b6e4e; }
.todo-edit-bujo-btn[data-bujo-state="scheduled"].active { color: #5b7a8a; }
.todo-edit-ai-section {
  margin-bottom: 0.85rem;
  border: 1.5px solid var(--gray-200);
  border-radius: 10px;
  overflow: hidden;
}
.todo-edit-ai-header {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 12px;
  background: var(--gray-100);
  font-size: 0.78rem;
  font-weight: 600;
  color: var(--gray-500);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.todo-edit-ai-cards {
  padding: 8px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.todo-edit-ai-card {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  padding: 8px 12px;
  border-radius: 8px;
  background: var(--body-background);
  border: 1px solid var(--gray-200);
  font-size: 0.85rem;
  cursor: pointer;
  transition: background 0.15s, border-color 0.15s;
}
.todo-edit-ai-card:hover {
  background: var(--gray-100);
  border-color: var(--color-link);
}
.todo-edit-ai-card-text {
  flex: 1;
  min-width: 0;
  word-break: break-word;
}
.todo-edit-ai-card-type {
  font-size: 0.7rem;
  color: var(--gray-400);
  text-transform: uppercase;
  letter-spacing: 0.3px;
  white-space: nowrap;
}
.todo-edit-ai-card-action {
  background: none;
  border: none;
  color: var(--color-link);
  cursor: pointer;
  font-size: 0.8rem;
  font-weight: 600;
  padding: 2px 6px;
  border-radius: 4px;
  transition: background 0.15s;
  white-space: nowrap;
}
.todo-edit-ai-card-action:hover {
  background: rgba(66, 133, 244, 0.1);
}

/* Action buttons */
.todo-edit-actions {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  margin-top: 0.5rem;
}
.todo-edit-btn-cancel {
  padding: 8px 18px;
  background: var(--gray-100);
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.88rem;
  font-family: inherit;
  color: var(--body-font-color);
  transition: background 0.15s;
}
.todo-edit-btn-cancel:hover { background: var(--gray-200); }
.todo-edit-btn-save {
  padding: 8px 22px;
  background: var(--color-link);
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.88rem;
  font-family: inherit;
  color: #fff;
  font-weight: 600;
  transition: background 0.15s, opacity 0.15s;
}
.todo-edit-btn-save:hover { opacity: 0.9; }
.todo-edit-btn-save:disabled { opacity: 0.5; cursor: not-allowed; }

.todo-edit-hints {
  text-align: center;
  margin-top: 0.5rem;
  font-size: 0.72rem;
  color: var(--gray-400);
}
.todo-edit-hints kbd {
  padding: 1px 5px;
  border: 1px solid var(--gray-300);
  border-radius: 4px;
  background: var(--gray-100);
  font-size: 0.65rem;
  font-family: inherit;
  color: var(--gray-500);
}

@media screen and (max-width: 600px) {
  .todo-edit-dialog {
    width: 96%;
    padding: 1.25rem;
    border-radius: 12px;
  }
  .todo-edit-row {
    flex-direction: column;
    gap: 0;
  }
  .todo-edit-bujo-toggle {
    flex-wrap: wrap;
  }
}
</style>

<script>
(function() {
  'use strict';

  var modal = document.getElementById('todo-edit-modal');
  if (!modal) return;

  var backdrop = document.getElementById('todo-edit-backdrop');
  var closeBtn = document.getElementById('todo-edit-close');
  var cancelBtn = document.getElementById('todo-edit-cancel');
  var saveBtn = document.getElementById('todo-edit-save');
  var titleInput = document.getElementById('todo-edit-title');
  var dateInput = document.getElementById('todo-edit-date');
  var estimateInput = document.getElementById('todo-edit-estimate');
  var categoryChipsEl = document.getElementById('todo-edit-category-chips');
  var categoryInput = document.getElementById('todo-edit-category-input');
  var categoryDropdown = document.getElementById('todo-edit-category-dropdown');
  var aiSection = document.getElementById('todo-edit-ai-section');
  var aiCardsEl = document.getElementById('todo-edit-ai-cards');

  var currentTodo = null;
  var categories = [];
  var onSaveCallback = null;
  var existingCategories = [];
  var dropdownActiveIdx = -1;
  var _dropdownJustClosed = false;
  var _editBujoType = 'task';
  var _editBujoState = 'open';

  // Auto-grow textarea for title
  function autoGrowTitle() {
    if (!titleInput) return;
    titleInput.style.height = 'auto';
    titleInput.style.height = Math.min(titleInput.scrollHeight, 200) + 'px';
  }
  if (titleInput) {
    titleInput.addEventListener('input', autoGrowTitle);
  }

  // BuJo type/state elements
  var bujoTypeToggle = document.getElementById('todo-edit-bujo-type');
  var bujoStateToggle = document.getElementById('todo-edit-bujo-state');
  var bujoStateField = document.getElementById('todo-edit-state-field');
  var estimateField = estimateInput ? estimateInput.closest('.todo-edit-half') : null;

  function updateBujoTypeUI() {
    if (!bujoTypeToggle) return;
    bujoTypeToggle.querySelectorAll('.todo-edit-bujo-btn').forEach(function(b) {
      b.classList.toggle('active', b.getAttribute('data-bujo-type') === _editBujoType);
    });
    // Show state selector only for tasks
    if (bujoStateField) {
      bujoStateField.style.display = _editBujoType === 'task' ? '' : 'none';
    }
    // Show estimate field only for tasks
    if (estimateField) {
      estimateField.style.display = _editBujoType === 'task' ? '' : 'none';
    }
  }

  function updateBujoStateUI() {
    if (!bujoStateToggle) return;
    bujoStateToggle.querySelectorAll('.todo-edit-bujo-btn').forEach(function(b) {
      b.classList.toggle('active', b.getAttribute('data-bujo-state') === _editBujoState);
    });
  }

  // Wire up bujo type toggle clicks
  if (bujoTypeToggle) {
    bujoTypeToggle.querySelectorAll('.todo-edit-bujo-btn').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        _editBujoType = btn.getAttribute('data-bujo-type');
        // When switching to event/note, reset state to open
        if (_editBujoType !== 'task') {
          _editBujoState = 'open';
          updateBujoStateUI();
        }
        updateBujoTypeUI();
      });
    });
  }

  // Wire up bujo state toggle clicks
  if (bujoStateToggle) {
    bujoStateToggle.querySelectorAll('.todo-edit-bujo-btn').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        _editBujoState = btn.getAttribute('data-bujo-state');
        updateBujoStateUI();
      });
    });
  }

  // ─── Category helpers (same pattern as completion modal) ───

  function escapeHtml(text) {
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function renderCategories() {
    categoryChipsEl.innerHTML = '';
    categories.forEach(function(cat, idx) {
      var chip = document.createElement('span');
      chip.className = 'todo-edit-category-chip';
      chip.textContent = cat;
      var removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'todo-edit-category-remove';
      removeBtn.innerHTML = '&times;';
      removeBtn.title = 'Remove category';
      removeBtn.setAttribute('aria-label', 'Remove ' + cat);
      removeBtn.addEventListener('click', function() {
        categories.splice(idx, 1);
        renderCategories();
      });
      chip.appendChild(removeBtn);
      categoryChipsEl.appendChild(chip);
    });
  }

  function loadExistingCategories() {
    existingCategories = [];
    if (!window.dmSync) return Promise.resolve();
    return window.dmSync.getAllTodos().then(function(todos) {
      var catSet = {};
      todos.forEach(function(t) {
        if (t.category) {
          t.category.split(',').forEach(function(c) {
            var trimmed = c.trim().toLowerCase();
            if (trimmed) catSet[trimmed] = true;
          });
        }
      });
      existingCategories = Object.keys(catSet).sort();
    });
  }

  function getFilteredSuggestions(query) {
    var q = query.trim().toLowerCase();
    if (!q) return existingCategories.filter(function(c) { return categories.indexOf(c) === -1; });
    return existingCategories.filter(function(c) {
      return c.indexOf(q) !== -1 && categories.indexOf(c) === -1;
    });
  }

  function highlightMatch(text, query) {
    var q = query.trim().toLowerCase();
    if (!q) return escapeHtml(text);
    var idx = text.toLowerCase().indexOf(q);
    if (idx === -1) return escapeHtml(text);
    return escapeHtml(text.substring(0, idx)) +
      '<span class="cat-highlight">' + escapeHtml(text.substring(idx, idx + q.length)) + '</span>' +
      escapeHtml(text.substring(idx + q.length));
  }

  function showDropdown() {
    var query = categoryInput.value.trim().toLowerCase();
    var suggestions = getFilteredSuggestions(query);
    dropdownActiveIdx = -1;
    if (suggestions.length === 0) {
      categoryDropdown.classList.remove('show');
      categoryDropdown.innerHTML = '';
      return;
    }
    categoryDropdown.innerHTML = '';
    suggestions.forEach(function(cat, idx) {
      var opt = document.createElement('div');
      opt.className = 'todo-edit-category-option';
      opt.innerHTML = highlightMatch(cat, query);
      opt.setAttribute('data-cat', cat);
      opt.addEventListener('mousedown', function(e) {
        e.preventDefault();
        selectCategory(cat);
      });
      categoryDropdown.appendChild(opt);
    });
    categoryDropdown.classList.add('show');
  }

  function hideDropdown() {
    categoryDropdown.classList.remove('show');
    categoryDropdown.innerHTML = '';
    dropdownActiveIdx = -1;
  }

  function selectCategory(cat) {
    if (categories.indexOf(cat) === -1) {
      categories.push(cat);
      renderCategories();
    }
    categoryInput.value = '';
    hideDropdown();
    categoryInput.focus();
  }

  function navigateDropdown(direction) {
    var options = categoryDropdown.querySelectorAll('.todo-edit-category-option');
    if (options.length === 0) return;
    if (dropdownActiveIdx >= 0 && dropdownActiveIdx < options.length) {
      options[dropdownActiveIdx].classList.remove('active');
    }
    dropdownActiveIdx += direction;
    if (dropdownActiveIdx < 0) dropdownActiveIdx = options.length - 1;
    if (dropdownActiveIdx >= options.length) dropdownActiveIdx = 0;
    options[dropdownActiveIdx].classList.add('active');
    options[dropdownActiveIdx].scrollIntoView({ block: 'nearest' });
  }

  categoryInput.addEventListener('input', showDropdown);
  categoryInput.addEventListener('focus', showDropdown);
  categoryInput.addEventListener('blur', function() {
    setTimeout(hideDropdown, 150);
  });

  categoryInput.addEventListener('keydown', function(e) {
    var isDropdownVisible = categoryDropdown.classList.contains('show');
    var options = categoryDropdown.querySelectorAll('.todo-edit-category-option');

    if (e.key === 'ArrowDown' && isDropdownVisible) {
      e.preventDefault();
      navigateDropdown(1);
      return;
    }
    if (e.key === 'ArrowUp' && isDropdownVisible) {
      e.preventDefault();
      navigateDropdown(-1);
      return;
    }
    if (e.key === 'Tab' && isDropdownVisible && dropdownActiveIdx >= 0 && dropdownActiveIdx < options.length) {
      e.preventDefault();
      selectCategory(options[dropdownActiveIdx].getAttribute('data-cat'));
      return;
    }
    if (e.key === 'Enter') {
      e.preventDefault();
      if (isDropdownVisible && dropdownActiveIdx >= 0 && dropdownActiveIdx < options.length) {
        selectCategory(options[dropdownActiveIdx].getAttribute('data-cat'));
        return;
      }
      var val = categoryInput.value.trim().toLowerCase();
      if (val && categories.indexOf(val) === -1) {
        categories.push(val);
        renderCategories();
      }
      categoryInput.value = '';
      hideDropdown();
    }
    if (e.key === 'Backspace' && !categoryInput.value && categories.length > 0) {
      categories.pop();
      renderCategories();
    }
    if (e.key === 'Escape' && isDropdownVisible) {
      e.stopPropagation();
      _dropdownJustClosed = true;
      hideDropdown();
      return;
    }
  });

  // ─── AI Suggestions ───

  function generateAiSuggestions(todo) {
    aiSection.style.display = 'none';
    aiCardsEl.innerHTML = '';

    var suggestions = [];

    // 1. If task has no date, suggest scheduling
    if (!todo.scheduledDate) {
      var todayStr = new Date().getFullYear() + '-' +
        String(new Date().getMonth() + 1).padStart(2, '0') + '-' +
        String(new Date().getDate()).padStart(2, '0');
      suggestions.push({
        type: 'schedule',
        text: 'Schedule for today',
        action: function() {
          dateInput.value = todayStr;
        }
      });
      var tmr = new Date();
      tmr.setDate(tmr.getDate() + 1);
      var tmrStr = tmr.getFullYear() + '-' +
        String(tmr.getMonth() + 1).padStart(2, '0') + '-' +
        String(tmr.getDate()).padStart(2, '0');
      suggestions.push({
        type: 'schedule',
        text: 'Schedule for tomorrow',
        action: function() {
          dateInput.value = tmrStr;
        }
      });
    }

    // 2. If no estimate, suggest common ones
    if (!todo.estimatedMin) {
      suggestions.push({
        type: 'estimate',
        text: 'Quick task (15 min)',
        action: function() {
          estimateInput.value = '15';
        }
      });
      suggestions.push({
        type: 'estimate',
        text: 'Medium task (30 min)',
        action: function() {
          estimateInput.value = '30';
        }
      });
      suggestions.push({
        type: 'estimate',
        text: 'Deep work (60 min)',
        action: function() {
          estimateInput.value = '60';
        }
      });
    }

    // 3. If title is vague/short, suggest subtask breakdown
    var title = (todo.title || '').trim();
    var wordCount = title.split(/\s+/).length;
    if (wordCount <= 3 && title.length < 30) {
      suggestions.push({
        type: 'breakdown',
        text: 'Break into subtasks (task seems broad)',
        action: function() {
          // Create subtask prompt — use AI to suggest breakdown
          if (window.dmAI && window.dmAI._getEngine) {
            var card = aiCardsEl.querySelector('[data-type="breakdown"]');
            if (card) {
              var actionBtn = card.querySelector('.todo-edit-ai-card-action');
              if (actionBtn) { actionBtn.textContent = 'Thinking...'; actionBtn.disabled = true; }
            }
            window.dmAI._loadEngine().then(function() {
              return window.dmAI._getEngine();
            }).then(function(engine) {
              return engine.chat.completions.create({
                messages: [
                  { role: 'system', content: 'You are a productivity assistant. Given a task title, suggest 2-4 concrete subtasks. Reply with just the subtask titles, one per line, no numbering or bullets.' },
                  { role: 'user', content: 'Break down this task: ' + title }
                ],
                temperature: 0.7,
                max_tokens: 200
              });
            }).then(function(result) {
              var text = result.choices[0].message.content || '';
              var subtasks = text.split('\n').map(function(s) { return s.trim(); }).filter(function(s) { return s.length > 2; });
              if (subtasks.length > 0) {
                showSubtaskSuggestions(subtasks);
              }
            }).catch(function() {
              if (card) {
                var actionBtn = card.querySelector('.todo-edit-ai-card-action');
                if (actionBtn) { actionBtn.textContent = 'Apply'; actionBtn.disabled = false; }
              }
            });
          }
        }
      });
    }

    // 4. Context-based follow-up suggestions
    var lowerTitle = title.toLowerCase();
    var followUps = [];
    if (/\b(pr|pull request|merge)\b/.test(lowerTitle)) {
      followUps.push('Update documentation');
      followUps.push('Notify stakeholders');
    }
    if (/\b(deploy|release|ship)\b/.test(lowerTitle)) {
      followUps.push('Monitor for errors post-deploy');
      followUps.push('Update changelog');
    }
    if (/\b(meeting|call|sync)\b/.test(lowerTitle)) {
      followUps.push('Write meeting notes');
      followUps.push('Send follow-up action items');
    }
    if (/\b(design|mockup|wireframe)\b/.test(lowerTitle)) {
      followUps.push('Get design feedback');
      followUps.push('Create implementation ticket');
    }
    if (/\b(write|draft|blog)\b/.test(lowerTitle)) {
      followUps.push('Review and proofread');
      followUps.push('Schedule publication');
    }
    if (/\b(test|testing)\b/.test(lowerTitle)) {
      followUps.push('Fix failing tests');
      followUps.push('Update test documentation');
    }

    followUps.forEach(function(followUp) {
      suggestions.push({
        type: 'follow-up',
        text: followUp,
        action: function() {
          // Create as a new task via dm-ai-create-task
          if (window.dmDb && window.dmAuth && window.dmAuth.currentUser) {
            var detail = { title: followUp, source: 'ai' };
            if (window.dmAI && window.dmAI._parseTaskDetails) {
              var det = window.dmAI._parseTaskDetails(followUp);
              detail.title = det.title;
              detail.scheduledDate = det.scheduledDate;
              detail.estimatedMin = det.estimatedMin;
              detail.category = det.category;
            }
            window.dispatchEvent(new CustomEvent('dm-ai-create-task', { detail: detail }));
            // Mark as added
            var cards = aiCardsEl.querySelectorAll('.todo-edit-ai-card');
            cards.forEach(function(c) {
              if (c.querySelector('.todo-edit-ai-card-text') &&
                  c.querySelector('.todo-edit-ai-card-text').textContent === followUp) {
                var btn = c.querySelector('.todo-edit-ai-card-action');
                if (btn) { btn.textContent = 'Added'; btn.disabled = true; }
              }
            });
          }
        }
      });
    });

    if (suggestions.length === 0) return;

    suggestions.forEach(function(sug) {
      var card = document.createElement('div');
      card.className = 'todo-edit-ai-card';
      card.setAttribute('data-type', sug.type);

      var textSpan = document.createElement('span');
      textSpan.className = 'todo-edit-ai-card-text';
      textSpan.textContent = sug.text;

      var typeSpan = document.createElement('span');
      typeSpan.className = 'todo-edit-ai-card-type';
      typeSpan.textContent = sug.type;

      var actionBtn = document.createElement('button');
      actionBtn.type = 'button';
      actionBtn.className = 'todo-edit-ai-card-action';
      actionBtn.textContent = sug.type === 'follow-up' ? 'Add' : 'Apply';
      actionBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        sug.action();
      });

      card.addEventListener('click', function() {
        sug.action();
      });

      card.appendChild(textSpan);
      card.appendChild(typeSpan);
      card.appendChild(actionBtn);
      aiCardsEl.appendChild(card);
    });

    aiSection.style.display = '';
  }

  function showSubtaskSuggestions(subtasks) {
    // Replace breakdown card with subtask suggestions
    var breakdownCard = aiCardsEl.querySelector('[data-type="breakdown"]');
    if (breakdownCard) breakdownCard.remove();

    subtasks.forEach(function(subtaskTitle) {
      var card = document.createElement('div');
      card.className = 'todo-edit-ai-card';
      card.setAttribute('data-type', 'subtask');

      var textSpan = document.createElement('span');
      textSpan.className = 'todo-edit-ai-card-text';
      textSpan.textContent = subtaskTitle;

      var typeSpan = document.createElement('span');
      typeSpan.className = 'todo-edit-ai-card-type';
      typeSpan.textContent = 'subtask';

      var actionBtn = document.createElement('button');
      actionBtn.type = 'button';
      actionBtn.className = 'todo-edit-ai-card-action';
      actionBtn.textContent = 'Add';
      actionBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        if (currentTodo && window.dmDb && window.dmAuth && window.dmAuth.currentUser) {
          // Create subtask under the current task
          window.dispatchEvent(new CustomEvent('dm-ai-create-subtask', {
            detail: {
              title: subtaskTitle,
              parentId: currentTodo.id,
              scheduledDate: dateInput.value || currentTodo.scheduledDate || null,
              source: 'ai'
            }
          }));
          actionBtn.textContent = 'Added';
          actionBtn.disabled = true;
        }
      });

      card.addEventListener('click', function() {
        actionBtn.click();
      });

      card.appendChild(textSpan);
      card.appendChild(typeSpan);
      card.appendChild(actionBtn);
      aiCardsEl.appendChild(card);
    });
  }

  // ─── Open / Close ───

  function openModal(todo, onSave) {
    currentTodo = todo;
    onSaveCallback = onSave || null;

    // Populate fields
    titleInput.value = todo.title || '';
    dateInput.value = todo.scheduledDate || '';
    estimateInput.value = todo.estimatedMin || '';

    // BuJo type/state
    _editBujoType = todo.bujoType || 'task';
    _editBujoState = todo.bujoState || 'open';
    updateBujoTypeUI();
    updateBujoStateUI();

    // Parse category
    categories = [];
    if (todo.category) {
      todo.category.split(',').forEach(function(c) {
        var trimmed = c.trim();
        if (trimmed) categories.push(trimmed.toLowerCase());
      });
    }
    renderCategories();
    categoryInput.value = '';
    hideDropdown();

    saveBtn.disabled = false;
    saveBtn.textContent = 'Save Changes';

    // Generate AI suggestions
    generateAiSuggestions(todo);

    // Load existing categories for autocomplete, then show
    loadExistingCategories().then(function() {
      modal.style.display = '';
      autoGrowTitle();
      setTimeout(function() { titleInput.focus(); titleInput.select(); }, 50);
    }).catch(function() {
      modal.style.display = '';
      autoGrowTitle();
      setTimeout(function() { titleInput.focus(); titleInput.select(); }, 50);
    });
  }

  function closeModal() {
    modal.style.display = 'none';
    hideDropdown();
    aiSection.style.display = 'none';
    aiCardsEl.innerHTML = '';
    currentTodo = null;
    onSaveCallback = null;
    categories = [];
  }

  function saveAndClose() {
    if (!currentTodo) return;

    var newTitle = titleInput.value.trim();
    if (!newTitle) {
      titleInput.focus();
      return;
    }

    saveBtn.disabled = true;
    saveBtn.textContent = 'Saving...';

    var newDate = dateInput.value || null;
    var newEstimate = parseInt(estimateInput.value, 10) || null;
    var newCategory = categories.length > 0 ? categories.join(', ') : null;

    var result = {
      title: newTitle,
      scheduledDate: newDate,
      estimatedMin: newEstimate,
      category: newCategory,
      bujoType: _editBujoType,
      bujoState: _editBujoState
    };

    if (onSaveCallback) {
      onSaveCallback(result);
    }

    modal.style.display = 'none';
    aiSection.style.display = 'none';
    aiCardsEl.innerHTML = '';
    currentTodo = null;
    onSaveCallback = null;
    categories = [];
  }

  // ─── Event bindings ───
  saveBtn.addEventListener('click', saveAndClose);
  backdrop.addEventListener('click', closeModal);
  closeBtn.addEventListener('click', closeModal);
  cancelBtn.addEventListener('click', closeModal);

  document.addEventListener('keydown', function(e) {
    if (modal.style.display === 'none') return;
    if (e.key === 'Escape') {
      if (_dropdownJustClosed) {
        _dropdownJustClosed = false;
        return;
      }
      if (categoryDropdown.classList.contains('show')) return;
      e.preventDefault();
      closeModal();
    }
    if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
      e.preventDefault();
      saveAndClose();
    }
  });

  // ─── NLP auto-parse on title blur ───
  // Prevent Enter from adding newlines in title textarea — Enter saves
  titleInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      saveAndClose();
    }
  });

  titleInput.addEventListener('blur', function() {
    if (!window.dmAI || !window.dmAI._parseTaskDetails) return;
    var text = titleInput.value.trim();
    if (!text) return;

    var details = window.dmAI._parseTaskDetails(text);

    // Only auto-fill empty fields (don't overwrite user's explicit values)
    if (details.scheduledDate && !dateInput.value) {
      dateInput.value = details.scheduledDate;
    }
    if (details.estimatedMin && !estimateInput.value) {
      estimateInput.value = details.estimatedMin;
    }
    if (details.category && categories.length === 0) {
      categories.push(details.category.toLowerCase());
      renderCategories();
    }
    // Update title to cleaned version
    if (details.title && details.title !== text) {
      titleInput.value = details.title;
      autoGrowTitle();
    }
  });

  // ─── Public API ───
  window.dmTodoEdit = {
    open: openModal,
    close: closeModal
  };
})();
</script>
