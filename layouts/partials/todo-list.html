<!-- todo-list: Time-tracked TODO list for Inbox page -->
<!-- Renders above inbox note content. Requires dm-sync and dm-todo-complete-modal. -->
<div class="todo-list" id="todo-list" style="display: none;">
  <div class="todo-list-header">
    <h3 class="todo-list-title">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
      Tasks
    </h3>
    <button type="button" class="todo-list-toggle-btn" id="todo-list-toggle" title="Toggle task list" aria-expanded="true">
      <svg class="todo-toggle-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
    </button>
  </div>

  <div class="todo-list-body" id="todo-list-body">
    <!-- Add todo form — two rows -->
    <div class="todo-add-form" id="todo-add-form">
      <div class="todo-add-row-main">
        <input type="text" id="todo-add-title" class="todo-add-title" placeholder="New task...">
        <input type="number" id="todo-add-estimate" class="todo-add-estimate" min="1" placeholder="25">
        <button type="button" id="todo-add-btn" class="todo-add-btn" title="Add task">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        </button>
      </div>
      <div class="todo-add-row-date">
        <span class="todo-add-date-label">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
        </span>
        <button type="button" class="todo-date-shortcut" data-offset="0" title="Today">Today</button>
        <button type="button" class="todo-date-shortcut" data-offset="1" title="Tomorrow">Tmrw</button>
        <input type="date" id="todo-add-date" class="todo-add-date" title="Pick a date">
      </div>
    </div>

    <!-- Todo items rendered here -->
    <div class="todo-items" id="todo-items"></div>

    <!-- Summary -->
    <div class="todo-summary" id="todo-summary" style="display: none;"></div>
  </div>
</div>

<style>
.todo-list {
  position: relative;
  margin-bottom: 1.5rem;
  border: 1px solid var(--gray-200);
  border-radius: 12px;
  overflow: hidden;
}
.todo-list-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.75rem 1rem;
  background: var(--gray-100);
  border-bottom: 1px solid var(--gray-200);
  cursor: pointer;
  user-select: none;
}
.todo-list-title {
  margin: 0;
  font-size: 0.9rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--body-font-color);
}
.todo-list-title svg {
  color: var(--color-link);
}
.todo-list-toggle-btn {
  background: none;
  border: none;
  padding: 4px;
  cursor: pointer;
  color: var(--gray-500);
  border-radius: 4px;
  transition: background 0.15s;
  line-height: 0;
}
.todo-list-toggle-btn:hover {
  background: var(--gray-200);
}
.todo-toggle-chevron {
  transition: transform 0.2s;
}
.todo-list.collapsed .todo-toggle-chevron {
  transform: rotate(-90deg);
}
.todo-list.collapsed .todo-list-body {
  display: none;
}

.todo-list-body {
  padding: 0.75rem 1rem;
}

/* Add form — two-row layout */
.todo-add-form {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-bottom: 0.75rem;
}
.todo-add-row-main {
  display: flex;
  gap: 8px;
  align-items: center;
}
.todo-add-row-date {
  display: flex;
  align-items: center;
  gap: 6px;
  padding-left: 2px;
}
.todo-add-date-label {
  display: inline-flex;
  align-items: center;
  color: var(--gray-400);
}
.todo-add-title {
  flex: 1;
  padding: 8px 12px;
  border: 1px solid var(--gray-300);
  border-radius: 8px;
  font-size: 0.88rem;
  background: var(--body-background);
  color: var(--body-font-color);
  transition: border-color 0.2s;
}
.todo-add-title:focus {
  outline: none;
  border-color: var(--color-link);
}
.todo-add-estimate {
  width: 70px;
  padding: 8px 10px;
  border: 1px solid var(--gray-300);
  border-radius: 8px;
  font-size: 0.88rem;
  background: var(--body-background);
  color: var(--body-font-color);
  text-align: center;
  transition: border-color 0.2s;
}
.todo-add-estimate:focus {
  outline: none;
  border-color: var(--color-link);
}
.todo-add-estimate::placeholder {
  color: var(--gray-400);
  font-size: 0.8rem;
}
/* Date picker — inline in second row */
.todo-add-date {
  width: 120px;
  padding: 4px 6px;
  border: 1px solid var(--gray-200);
  border-radius: 6px;
  font-size: 0.75rem;
  background: var(--body-background);
  color: var(--body-font-color);
  transition: border-color 0.2s;
}
.todo-add-date:focus {
  outline: none;
  border-color: var(--color-link);
}
.todo-date-shortcut {
  padding: 2px 8px;
  border: 1px solid var(--gray-200);
  border-radius: 4px;
  background: var(--body-background);
  color: var(--gray-500);
  font-size: 0.68rem;
  cursor: pointer;
  transition: background 0.15s, color 0.15s, border-color 0.15s;
  white-space: nowrap;
}
.todo-date-shortcut:hover {
  border-color: var(--color-link);
  color: var(--color-link);
}
.todo-date-shortcut.active {
  background: var(--color-link);
  color: #fff;
  border-color: var(--color-link);
}
/* Day group headers */
.todo-day-group {
  margin-bottom: 4px;
}
.todo-day-group:not(:first-child) {
  margin-top: 12px;
}
.todo-day-header {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 10px;
  border-radius: 8px;
  font-size: 0.78rem;
  font-weight: 600;
  color: var(--gray-500);
  border-left: 3px solid var(--gray-300);
  margin-bottom: 4px;
  cursor: pointer;
  user-select: none;
  transition: background 0.15s;
}
.todo-day-header:hover {
  background: var(--gray-100);
}
.todo-day-header.today {
  color: var(--color-link);
  border-left-color: var(--color-link);
  background: rgba(0, 105, 255, 0.04);
}
.todo-day-header.today:hover {
  background: rgba(0, 105, 255, 0.08);
}
.todo-day-header.overdue {
  color: var(--color-danger);
  border-left-color: var(--color-danger);
  background: var(--color-danger-bg);
}
.todo-day-header.tomorrow {
  color: var(--color-success);
  border-left-color: var(--color-success);
}
.todo-day-chevron {
  display: inline-flex;
  align-items: center;
  transition: transform 0.2s;
  flex-shrink: 0;
}
.todo-day-group.collapsed .todo-day-chevron {
  transform: rotate(-90deg);
}
.todo-day-group.collapsed .todo-day-group-items {
  display: none;
}
.todo-day-badge {
  font-size: 0.68rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.04em;
}
.todo-day-label {
  font-weight: 500;
  flex: 1;
}
.todo-day-progress {
  font-size: 0.68rem;
  font-weight: 500;
  color: var(--gray-400);
  margin-left: auto;
}
.todo-add-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 36px;
  height: 36px;
  border: 1px solid var(--color-link);
  border-radius: 8px;
  background: var(--body-background);
  color: var(--color-link);
  cursor: pointer;
  transition: background 0.2s, color 0.2s;
  flex-shrink: 0;
  line-height: 0;
}
.todo-add-btn:hover {
  background: var(--color-link);
  color: #fff;
}
.todo-add-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Todo items */
.todo-items {
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.todo-empty {
  text-align: center;
  padding: 1.25rem 1rem;
  color: var(--gray-500);
  font-size: 0.85rem;
}
.todo-item {
  display: flex;
  align-items: flex-start;
  gap: 8px;
  padding: 8px 10px;
  border-radius: 8px;
  transition: background 0.15s;
}
.todo-item:hover {
  background: var(--gray-100);
}
.todo-item.done {
  opacity: 0.6;
}
.todo-item-checkbox {
  margin-top: 3px;
  width: 17px;
  height: 17px;
  cursor: pointer;
  accent-color: var(--color-link);
  flex-shrink: 0;
}
.todo-item-content {
  flex: 1;
  min-width: 0;
}
.todo-item-title {
  font-size: 0.88rem;
  line-height: 1.4;
  word-break: break-word;
}
.todo-item.done .todo-item-title {
  text-decoration: line-through;
  color: var(--gray-500);
}
.todo-item-meta {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 2px;
  flex-wrap: wrap;
}
.todo-item-estimate,
.todo-item-actual,
.todo-item-category {
  font-size: 0.72rem;
  color: var(--gray-500);
}
.todo-item-estimate {
  background: var(--gray-100);
  padding: 1px 6px;
  border-radius: 4px;
}
.todo-item-actual {
  padding: 1px 6px;
  border-radius: 4px;
}
.todo-item-actual.over {
  background: var(--color-danger-bg);
  color: var(--color-danger);
}
.todo-item-actual.under {
  background: var(--color-success-bg);
  color: var(--color-success);
}
.todo-item-category {
  background: rgba(0, 105, 255, 0.08);
  color: var(--color-link);
  padding: 1px 6px;
  border-radius: 4px;
  font-weight: 500;
}

.todo-item-actions {
  display: flex;
  gap: 2px;
  opacity: 0;
  transition: opacity 0.15s;
}
.todo-item:hover .todo-item-actions {
  opacity: 1;
}
.todo-item-action-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 26px;
  height: 26px;
  border: none;
  border-radius: 6px;
  background: none;
  color: var(--gray-400);
  cursor: pointer;
  transition: color 0.15s, background 0.15s;
  line-height: 0;
}
.todo-item-action-btn:hover {
  background: var(--gray-200);
  color: var(--body-font-color);
}
.todo-item-action-btn.delete:hover {
  color: var(--color-danger);
  background: var(--color-danger-bg);
}

/* Subtask collapse toggle */
.todo-subtask-toggle {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 22px;
  height: 22px;
  margin-top: 1px;
  border: none;
  border-radius: 4px;
  background: none;
  color: var(--gray-400);
  cursor: pointer;
  transition: color 0.15s, background 0.15s, transform 0.2s;
  flex-shrink: 0;
  line-height: 0;
  padding: 0;
}
.todo-subtask-toggle:hover {
  background: var(--gray-200);
  color: var(--body-font-color);
}
.todo-subtask-toggle svg {
  transition: transform 0.2s;
}
.todo-subtask-toggle.collapsed svg {
  transform: rotate(-90deg);
}
.todo-subtasks-wrapper.collapsed .todo-subtasks,
.todo-subtasks-wrapper.collapsed .todo-add-subtask-row {
  display: none;
}

/* Subtasks */
.todo-subtasks {
  margin-left: 25px;
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.todo-add-subtask-row {
  display: flex;
  gap: 6px;
  align-items: center;
  margin-left: 25px;
  margin-top: 2px;
  margin-bottom: 4px;
}
.todo-add-subtask-input {
  flex: 1;
  padding: 5px 10px;
  border: 1px solid var(--gray-300);
  border-radius: 6px;
  font-size: 0.82rem;
  background: var(--body-background);
  color: var(--body-font-color);
}
.todo-add-subtask-input:focus {
  outline: none;
  border-color: var(--color-link);
}
.todo-add-subtask-estimate {
  width: 55px;
  padding: 5px 8px;
  border: 1px solid var(--gray-300);
  border-radius: 6px;
  font-size: 0.82rem;
  background: var(--body-background);
  color: var(--body-font-color);
  text-align: center;
}
.todo-add-subtask-estimate:focus {
  outline: none;
  border-color: var(--color-link);
}
.todo-add-subtask-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 28px;
  height: 28px;
  border: 1px solid var(--color-link);
  border-radius: 6px;
  background: var(--body-background);
  color: var(--color-link);
  cursor: pointer;
  transition: background 0.2s, color 0.2s;
  flex-shrink: 0;
  line-height: 0;
}
.todo-add-subtask-btn:hover {
  background: var(--color-link);
  color: #fff;
}

/* Summary bar */
.todo-summary {
  margin-top: 0.75rem;
  padding: 8px 12px;
  border-radius: 8px;
  background: var(--gray-100);
  font-size: 0.78rem;
  color: var(--gray-500);
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
}
.todo-summary-item {
  display: flex;
  align-items: center;
  gap: 4px;
}
.todo-summary-item strong {
  color: var(--body-font-color);
  font-weight: 600;
}

/* Clear all completed bar */
.todo-clear-all-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-top: 0.5rem;
  padding: 6px 4px;
  border-top: 1px solid var(--gray-200);
}
.todo-clear-all-count {
  font-size: 0.78rem;
  color: var(--gray-400);
  font-weight: 500;
  padding-left: 4px;
}
.todo-clear-all-btn {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  background: none;
  border: 1px solid transparent;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 0.75rem;
  color: var(--gray-400);
  cursor: pointer;
  transition: background 0.15s, color 0.15s, border-color 0.15s;
}
.todo-clear-all-btn:hover {
  color: var(--color-danger, #e53e3e);
  background: var(--color-danger-bg, rgba(229, 62, 62, 0.06));
  border-color: var(--color-danger, #e53e3e);
}

/* Toast notifications */
.todo-toast {
  position: absolute;
  bottom: 8px;
  left: 50%;
  transform: translateX(-50%) translateY(10px);
  padding: 8px 16px;
  border-radius: 8px;
  font-size: 0.82rem;
  font-weight: 500;
  opacity: 0;
  transition: opacity 0.3s, transform 0.3s;
  z-index: 10;
  pointer-events: none;
  white-space: nowrap;
}
.todo-toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}
.todo-toast-error {
  background: var(--color-danger-bg, #fee);
  color: var(--color-danger, #c53030);
  border: 1px solid var(--color-danger, #c53030);
}

/* Mobile responsiveness */
@media screen and (max-width: 500px) {
  .todo-add-row-main {
    flex-wrap: wrap;
  }
  .todo-add-title {
    flex: 1 1 100%;
  }
  .todo-add-estimate {
    flex: 1;
  }
  .todo-add-row-date {
    flex-wrap: wrap;
  }
  .todo-add-date {
    width: auto;
    flex: 1;
  }
  .todo-item-actions {
    opacity: 1;
  }
  .todo-day-header {
    font-size: 0.72rem;
    padding: 5px 8px;
    gap: 6px;
  }
}
</style>

<script>
(function() {
  'use strict';

  var container = document.getElementById('todo-list');
  var body = document.getElementById('todo-list-body');
  var toggleBtn = document.getElementById('todo-list-toggle');
  var headerEl = container ? container.querySelector('.todo-list-header') : null;
  var itemsEl = document.getElementById('todo-items');
  var summaryEl = document.getElementById('todo-summary');

  var addTitleInput = document.getElementById('todo-add-title');
  var addEstimateInput = document.getElementById('todo-add-estimate');
  var addDateInput = document.getElementById('todo-add-date');
  var addBtn = document.getElementById('todo-add-btn');

  if (!container || !itemsEl) return;

  // State
  var allTodos = [];

  // ─── Date helpers ───
  function getTodayStr() {
    var d = new Date();
    return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
  }

  function getDateOffset(offset) {
    var d = new Date();
    d.setDate(d.getDate() + offset);
    return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
  }

  function formatDayHeader(dateStr) {
    var today = getTodayStr();
    var tomorrow = getDateOffset(1);
    var parts = dateStr.split('-');
    var date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
    var dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    var monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    var dayName = dayNames[date.getDay()];
    var monthDay = monthNames[date.getMonth()] + ' ' + date.getDate();

    if (dateStr === today) {
      return { label: 'Today — ' + dayName + ', ' + monthDay, cssClass: 'today', badge: 'Today' };
    }
    if (dateStr === tomorrow) {
      return { label: 'Tomorrow — ' + dayName + ', ' + monthDay, cssClass: 'tomorrow', badge: 'Tomorrow' };
    }
    if (dateStr < today) {
      return { label: dayName + ', ' + monthDay, cssClass: 'overdue', badge: 'Overdue' };
    }
    return { label: dayName + ', ' + monthDay, cssClass: '', badge: '' };
  }

  // ─── Date shortcut buttons ───
  function initDateShortcuts() {
    var shortcuts = document.querySelectorAll('.todo-date-shortcut');
    shortcuts.forEach(function(btn) {
      btn.addEventListener('click', function() {
        var offset = parseInt(btn.getAttribute('data-offset'), 10);
        var dateStr = getDateOffset(offset);
        if (addDateInput.value === dateStr) {
          // Toggle off
          addDateInput.value = '';
          btn.classList.remove('active');
        } else {
          addDateInput.value = dateStr;
          // Update active states
          shortcuts.forEach(function(b) { b.classList.remove('active'); });
          btn.classList.add('active');
        }
      });
    });
    // Sync shortcut highlight when date input changes manually
    addDateInput.addEventListener('change', function() {
      shortcuts.forEach(function(btn) {
        var offset = parseInt(btn.getAttribute('data-offset'), 10);
        btn.classList.toggle('active', addDateInput.value === getDateOffset(offset));
      });
    });
    // Default to today
    addDateInput.value = getTodayStr();
    shortcuts.forEach(function(btn) {
      var offset = parseInt(btn.getAttribute('data-offset'), 10);
      if (getDateOffset(offset) === getTodayStr()) btn.classList.add('active');
    });
  }
  initDateShortcuts();

  // ─── Toast notifications ───
  function showTodoError(msg) {
    var toast = document.createElement('div');
    toast.className = 'todo-toast todo-toast-error';
    toast.textContent = msg;
    container.appendChild(toast);
    setTimeout(function() { toast.classList.add('show'); }, 10);
    setTimeout(function() {
      toast.classList.remove('show');
      setTimeout(function() { toast.remove(); }, 300);
    }, 4000);
  }

  // ─── Toggle collapse ───
  function toggleCollapse() {
    container.classList.toggle('collapsed');
    var isCollapsed = container.classList.contains('collapsed');
    if (toggleBtn) toggleBtn.setAttribute('aria-expanded', !isCollapsed);
    try {
      localStorage.setItem('dm-todo-collapsed', isCollapsed ? '1' : '0');
    } catch(e) {}
  }

  if (headerEl) headerEl.addEventListener('click', toggleCollapse);
  if (toggleBtn) toggleBtn.addEventListener('click', function(e) { e.stopPropagation(); toggleCollapse(); });

  // Restore collapse state
  try {
    if (localStorage.getItem('dm-todo-collapsed') === '1') {
      container.classList.add('collapsed');
      if (toggleBtn) toggleBtn.setAttribute('aria-expanded', 'false');
    }
  } catch(e) {}

  // ─── Render ───
  function buildTodoItemHtml(todo, isSubtask, hasChildren) {
    var doneClass = todo.done ? ' done' : '';
    var checked = todo.done ? ' checked' : '';
    var html = '<div class="todo-item' + doneClass + '" data-todo-id="' + todo.id + '">';

    // Subtask collapse toggle for parents with children
    if (!isSubtask && hasChildren) {
      var isCollapsed = false;
      try { isCollapsed = localStorage.getItem('dm-todo-subtask-collapsed-' + todo.id) === '1'; } catch(e) {}
      html += '<button type="button" class="todo-subtask-toggle' + (isCollapsed ? ' collapsed' : '') + '" data-toggle-parent="' + todo.id + '" title="Toggle subtasks" aria-label="Toggle subtasks">';
      html += '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>';
      html += '</button>';
    }

    html += '<input type="checkbox" class="todo-item-checkbox"' + checked + ' data-todo-id="' + todo.id + '" aria-label="Complete: ' + escapeHtml(todo.title) + '">';
    html += '<div class="todo-item-content">';
    html += '<div class="todo-item-title">' + escapeHtml(todo.title) + '</div>';
    html += '<div class="todo-item-meta">';

    if (todo.estimatedMin) {
      html += '<span class="todo-item-estimate">est: ' + todo.estimatedMin + 'min</span>';
    }
    if (todo.done && todo.actualMin != null) {
      var actualClass = '';
      if (todo.estimatedMin) {
        actualClass = todo.actualMin > todo.estimatedMin ? ' over' : ' under';
      }
      html += '<span class="todo-item-actual' + actualClass + '">actual: ' + todo.actualMin + 'min</span>';
    }
    if (todo.category) {
      html += '<span class="todo-item-category">' + escapeHtml(todo.category) + '</span>';
    }

    html += '</div></div>';

    // Action buttons
    html += '<div class="todo-item-actions">';
    if (!isSubtask && !todo.done) {
      html += '<button type="button" class="todo-item-action-btn add-subtask" data-parent-id="' + todo.id + '" title="Add subtask" aria-label="Add subtask">';
      html += '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>';
      html += '</button>';
    }
    html += '<button type="button" class="todo-item-action-btn delete" data-delete-id="' + todo.id + '" title="Delete task" aria-label="Delete task">';
    html += '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>';
    html += '</button>';
    html += '</div>';
    html += '</div>';
    return html;
  }

  function render() {
    container.style.display = '';

    // Separate parents and children
    var parents = [];
    var childrenMap = {}; // parentId -> [children]
    allTodos.forEach(function(t) {
      if (t.parentId) {
        if (!childrenMap[t.parentId]) childrenMap[t.parentId] = [];
        childrenMap[t.parentId].push(t);
      } else {
        parents.push(t);
      }
    });

    // Sort children by order
    Object.keys(childrenMap).forEach(function(pid) {
      childrenMap[pid].sort(function(a, b) {
        return (a.order || 0) - (b.order || 0);
      });
    });

    // Group parents by scheduledDate
    var dateGroups = {}; // dateStr -> [parents]
    var unscheduled = [];
    parents.forEach(function(p) {
      if (p.scheduledDate) {
        if (!dateGroups[p.scheduledDate]) dateGroups[p.scheduledDate] = [];
        dateGroups[p.scheduledDate].push(p);
      } else {
        unscheduled.push(p);
      }
    });

    // Sort dates
    var sortedDates = Object.keys(dateGroups).sort();

    // Sort parents within each group by order
    sortedDates.forEach(function(dateStr) {
      dateGroups[dateStr].sort(function(a, b) {
        return (a.order || 0) - (b.order || 0);
      });
    });
    unscheduled.sort(function(a, b) {
      return (a.order || 0) - (b.order || 0);
    });

    var html = '';
    var totalParents = parents.length;

    if (totalParents === 0) {
      html = '<div class="todo-empty">No tasks yet. Add one above to get started.</div>';
    }

    var today = getTodayStr();
    var tomorrow = getDateOffset(1);

    // Helper: build a day group with header, chevron, progress, collapse
    function buildDayGroup(groupKey, headerInfo, tasksInGroup) {
      // Calculate progress (count leaf tasks — parent tasks with children are excluded)
      var doneInGroup = 0;
      var totalInGroup = 0;
      tasksInGroup.forEach(function(p) {
        var ch = childrenMap[p.id] || [];
        if (ch.length > 0) {
          ch.forEach(function(c) { totalInGroup++; if (c.done) doneInGroup++; });
        } else {
          totalInGroup++;
          if (p.done) doneInGroup++;
        }
      });

      // Fix 6: overdue styling only when group has at least one incomplete task
      var cssClass = headerInfo.cssClass;
      var badge = headerInfo.badge;
      if (cssClass === 'overdue' && doneInGroup === totalInGroup) {
        cssClass = ''; // all done, no overdue accent
        badge = '';
      }

      // Fix 3: auto-collapse logic
      var storageKey = 'dm-todo-daygroup-' + groupKey;
      var stored = null;
      try { stored = localStorage.getItem(storageKey); } catch(e) {}
      var isCollapsed;
      if (stored !== null) {
        isCollapsed = stored === '1';
      } else {
        // Default: collapse future dates and unscheduled; expand today, tomorrow, overdue
        if (groupKey === '_unscheduled') {
          isCollapsed = true;
        } else {
          isCollapsed = groupKey > tomorrow;
        }
      }

      var g = '<div class="todo-day-group' + (isCollapsed ? ' collapsed' : '') + '" data-day-group="' + escapeHtml(groupKey) + '">';
      g += '<div class="todo-day-header ' + cssClass + '" data-day-toggle="' + escapeHtml(groupKey) + '">';
      g += '<span class="todo-day-chevron"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg></span>';
      if (badge) {
        g += '<span class="todo-day-badge">' + escapeHtml(badge) + '</span>';
      }
      g += '<span class="todo-day-label">' + escapeHtml(headerInfo.label) + '</span>';
      g += '<span class="todo-day-progress">' + doneInGroup + '/' + totalInGroup + '</span>';
      g += '</div>';
      g += '<div class="todo-day-group-items">';
      tasksInGroup.forEach(function(parent) {
        var children = childrenMap[parent.id] || [];
        g += buildTodoItemHtml(parent, false, children.length > 0);
        if (children.length > 0) {
          var subCollapsed = false;
          try { subCollapsed = localStorage.getItem('dm-todo-subtask-collapsed-' + parent.id) === '1'; } catch(e) {}
          g += '<div class="todo-subtasks-wrapper' + (subCollapsed ? ' collapsed' : '') + '" data-subtasks-parent="' + parent.id + '">';
          g += '<div class="todo-subtasks" data-parent-id="' + parent.id + '">';
          children.forEach(function(child) {
            g += buildTodoItemHtml(child, true, false);
          });
          g += '</div>';
          g += '</div>';
        }
      });
      g += '</div>';
      g += '</div>';
      return g;
    }

    // Render date groups
    sortedDates.forEach(function(dateStr) {
      var info = formatDayHeader(dateStr);
      html += buildDayGroup(dateStr, info, dateGroups[dateStr]);
    });

    // Render unscheduled
    if (unscheduled.length > 0) {
      html += buildDayGroup('_unscheduled', { label: 'Unscheduled', cssClass: '', badge: '' }, unscheduled);
    }

    // Clear all completed bar (shown when there are completed tasks)
    var completedCount = 0;
    allTodos.forEach(function(t) { if (t.done) completedCount++; });
    if (completedCount > 0) {
      html += '<div class="todo-clear-all-bar">';
      html += '<span class="todo-clear-all-count">' + completedCount + ' completed</span>';
      html += '<button type="button" class="todo-clear-all-btn" id="todo-clear-all" title="Permanently delete all completed tasks">';
      html += '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>';
      html += ' Clear all';
      html += '</button>';
      html += '</div>';
    }

    itemsEl.innerHTML = html;

    // Summary
    var totalEst = 0, totalActual = 0, doneCount = 0, totalCount = 0;
    allTodos.forEach(function(t) {
      // Only count leaf tasks (no children or subtasks themselves)
      var hasChildren = childrenMap[t.id] && childrenMap[t.id].length > 0;
      if (!hasChildren) {
        totalCount++;
        if (t.estimatedMin) totalEst += t.estimatedMin;
        if (t.done) {
          doneCount++;
          if (t.actualMin != null) totalActual += t.actualMin;
        }
      }
    });

    if (totalCount > 0) {
      var pomEst = (totalEst / 25).toFixed(1);
      var pomActual = (totalActual / 25).toFixed(1);
      summaryEl.innerHTML =
        '<span class="todo-summary-item"><strong>' + doneCount + '/' + totalCount + '</strong> tasks done</span>' +
        (totalEst ? '<span class="todo-summary-item">Est: <strong>' + totalEst + 'min</strong> (' + pomEst + ' pom)</span>' : '') +
        (totalActual ? '<span class="todo-summary-item">Actual: <strong>' + totalActual + 'min</strong> (' + pomActual + ' pom)</span>' : '');
      summaryEl.style.display = '';
    } else {
      summaryEl.style.display = 'none';
    }

    // Attach event listeners
    attachEventListeners();
  }

  function escapeHtml(text) {
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // ─── Event listeners ───
  function attachEventListeners() {
    // Day group collapse toggle
    itemsEl.querySelectorAll('.todo-day-header[data-day-toggle]').forEach(function(header) {
      header.addEventListener('click', function() {
        var groupKey = header.getAttribute('data-day-toggle');
        var group = itemsEl.querySelector('.todo-day-group[data-day-group="' + groupKey + '"]');
        if (!group) return;
        var isCollapsed = group.classList.toggle('collapsed');
        try { localStorage.setItem('dm-todo-daygroup-' + groupKey, isCollapsed ? '1' : '0'); } catch(e) {}
      });
    });

    // Subtask collapse toggle
    itemsEl.querySelectorAll('.todo-subtask-toggle').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        var parentId = btn.getAttribute('data-toggle-parent');
        var wrapper = itemsEl.querySelector('.todo-subtasks-wrapper[data-subtasks-parent="' + parentId + '"]');
        var isCollapsed = btn.classList.toggle('collapsed');
        if (wrapper) wrapper.classList.toggle('collapsed', isCollapsed);
        try { localStorage.setItem('dm-todo-subtask-collapsed-' + parentId, isCollapsed ? '1' : '0'); } catch(e) {}
      });
    });

    // Checkbox toggle
    itemsEl.querySelectorAll('.todo-item-checkbox').forEach(function(cb) {
      cb.addEventListener('change', function() {
        var todoId = cb.getAttribute('data-todo-id');
        var todo = allTodos.find(function(t) { return t.id === todoId; });
        if (!todo) return;

        if (cb.checked) {
          // Opening completion modal
          if (window.dmTodoComplete) {
            window.dmTodoComplete.open(todo, function(result) {
              if (!result) {
                // Cancelled — revert checkbox
                cb.checked = false;
                return;
              }
              completeTodo(todo, result.actualMin, result.category);
            });
          }
        } else {
          // Unchecking — reopen the todo
          reopenTodo(todo);
        }
      });
    });

    // Add subtask button
    itemsEl.querySelectorAll('.add-subtask').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        var parentId = btn.getAttribute('data-parent-id');
        showSubtaskInput(parentId);
      });
    });

    // Delete button
    itemsEl.querySelectorAll('[data-delete-id]').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        var todoId = btn.getAttribute('data-delete-id');
        if (confirm('Permanently delete this task?')) {
          deleteTodo(todoId);
        }
      });
    });

    // Clear all completed button
    var clearAllBtn = document.getElementById('todo-clear-all');
    if (clearAllBtn) {
      clearAllBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        var completedIds = [];
        allTodos.forEach(function(t) {
          if (t.done) completedIds.push(t.id);
        });
        if (completedIds.length === 0) return;
        if (!confirm('Permanently delete ' + completedIds.length + ' completed task' + (completedIds.length > 1 ? 's' : '') + '?')) return;
        clearAllCompleted(completedIds);
      });
    }
  }

  function showSubtaskInput(parentId) {
    // Remove any existing subtask input
    var existing = document.querySelector('.todo-add-subtask-row');
    if (existing) existing.remove();

    // Expand subtasks if collapsed
    var toggleBtn = itemsEl.querySelector('.todo-subtask-toggle[data-toggle-parent="' + parentId + '"]');
    var wrapper = itemsEl.querySelector('.todo-subtasks-wrapper[data-subtasks-parent="' + parentId + '"]');
    if (toggleBtn && toggleBtn.classList.contains('collapsed')) {
      toggleBtn.classList.remove('collapsed');
      if (wrapper) wrapper.classList.remove('collapsed');
      try { localStorage.setItem('dm-todo-subtask-collapsed-' + parentId, '0'); } catch(e) {}
    }

    // Find where to insert
    var subtasksEl = itemsEl.querySelector('.todo-subtasks[data-parent-id="' + parentId + '"]');
    var parentItem = itemsEl.querySelector('.todo-item[data-todo-id="' + parentId + '"]');
    if (!parentItem) return;

    var row = document.createElement('div');
    row.className = 'todo-add-subtask-row';
    row.innerHTML =
      '<input type="text" class="todo-add-subtask-input" placeholder="Subtask...">' +
      '<input type="number" class="todo-add-subtask-estimate" min="1" placeholder="25">' +
      '<button type="button" class="todo-add-subtask-btn" title="Add subtask" aria-label="Add subtask">' +
        '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>' +
      '</button>';

    if (subtasksEl) {
      subtasksEl.appendChild(row);
    } else if (wrapper) {
      wrapper.appendChild(row);
    } else {
      parentItem.insertAdjacentElement('afterend', row);
    }

    var subInput = row.querySelector('.todo-add-subtask-input');
    var subEstInput = row.querySelector('.todo-add-subtask-estimate');
    var subAddBtn = row.querySelector('.todo-add-subtask-btn');
    subInput.focus();

    function addSubtask() {
      var title = subInput.value.trim();
      if (!title) { subInput.focus(); return; }
      var est = parseInt(subEstInput.value, 10) || 25;
      // Subtasks inherit parent's scheduledDate
      var parent = allTodos.find(function(t) { return t.id === parentId; });
      var scheduledDate = parent ? parent.scheduledDate : null;
      createTodo(title, est, parentId, scheduledDate);
      row.remove();
    }

    subInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') { e.preventDefault(); addSubtask(); }
      if (e.key === 'Escape') { row.remove(); }
    });
    subEstInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') { e.preventDefault(); addSubtask(); }
      if (e.key === 'Escape') { row.remove(); }
    });
    subAddBtn.addEventListener('click', addSubtask);
  }

  // ─── CRUD operations ───
  function getNextOrder(parentId) {
    var siblings = allTodos.filter(function(t) {
      return parentId ? t.parentId === parentId : !t.parentId;
    });
    var maxOrder = 0;
    siblings.forEach(function(t) {
      if (t.order > maxOrder) maxOrder = t.order;
    });
    return maxOrder + 1;
  }

  function createTodo(title, estimatedMin, parentId, scheduledDate, onDone) {
    if (!window.dmDb || !window.dmAuth || !window.dmAuth.currentUser) {
      showTodoError('Not signed in — please sign in to add tasks');
      if (onDone) onDone();
      return;
    }

    var user = window.dmAuth.currentUser;
    var order = getNextOrder(parentId || null);

    var todoData = {
      userId: user.uid,
      title: title,
      estimatedMin: estimatedMin || 25,
      actualMin: null,
      category: null,
      done: false,
      parentId: parentId || null,
      order: order,
      scheduledDate: scheduledDate || null,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      completedAt: null
    };

    window.dmDb.collection('todos').add(todoData)
      .then(function(docRef) {
        var localTodo = Object.assign({}, todoData, {
          id: docRef.id,
          createdAt: Date.now(),
          updatedAt: Date.now()
        });
        allTodos.push(localTodo);
        if (window.dmSync) {
          return window.dmSync.putTodo(localTodo);
        }
      })
      .then(function() {
        if (onDone) onDone();
        render();
      })
      .catch(function(err) {
        console.error('Error creating todo:', err);
        showTodoError('Failed to add task — check console');
        if (onDone) onDone();
      });
  }

  function completeTodo(todo, actualMin, category) {
    if (!window.dmDb) return;

    var updateData = {
      done: true,
      actualMin: actualMin,
      category: category,
      completedAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    window.dmDb.collection('todos').doc(todo.id).update(updateData)
      .then(function() {
        todo.done = true;
        todo.actualMin = actualMin;
        todo.category = category;
        todo.completedAt = Date.now();
        todo.updatedAt = Date.now();
        if (window.dmSync) {
          return window.dmSync.putTodo(todo);
        }
      })
      .then(function() {
        // Check if parent should auto-complete
        checkParentAutoComplete(todo.parentId);
        render();
      })
      .catch(function(err) {
        console.error('Error completing todo:', err);
        showTodoError('Failed to complete task — check console');
        // Revert local state so UI reflects the failure
        todo.done = false;
        todo.actualMin = null;
        todo.category = null;
        todo.completedAt = null;
        render();
      });
  }

  function checkParentAutoComplete(parentId) {
    if (!parentId) return;

    var parent = allTodos.find(function(t) { return t.id === parentId; });
    if (!parent || parent.done) return;

    var children = allTodos.filter(function(t) { return t.parentId === parentId; });
    if (children.length === 0) return;

    var allDone = children.every(function(t) { return t.done; });
    if (!allDone) return;

    // Calculate parent's actual time = sum of children
    var totalActual = 0;
    var categories = [];
    children.forEach(function(c) {
      if (c.actualMin != null) totalActual += c.actualMin;
      if (c.category && categories.indexOf(c.category) === -1) {
        categories.push(c.category);
      }
    });

    var updateData = {
      done: true,
      actualMin: totalActual,
      category: categories.join(', ') || null,
      completedAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    window.dmDb.collection('todos').doc(parent.id).update(updateData)
      .then(function() {
        parent.done = true;
        parent.actualMin = totalActual;
        parent.category = categories.join(', ') || null;
        parent.completedAt = Date.now();
        parent.updatedAt = Date.now();
        if (window.dmSync) {
          return window.dmSync.putTodo(parent);
        }
      })
      .then(function() {
        render();
      })
      .catch(function(err) {
        console.error('Error auto-completing parent:', err);
        showTodoError('Failed to auto-complete parent task');
      });
  }

  function reopenTodo(todo) {
    if (!window.dmDb) return;

    var updateData = {
      done: false,
      actualMin: null,
      category: null,
      completedAt: null,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    window.dmDb.collection('todos').doc(todo.id).update(updateData)
      .then(function() {
        todo.done = false;
        todo.actualMin = null;
        todo.category = null;
        todo.completedAt = null;
        todo.updatedAt = Date.now();
        if (window.dmSync) {
          return window.dmSync.putTodo(todo);
        }
      })
      .then(function() {
        // If this is a subtask, reopen parent too
        if (todo.parentId) {
          var parent = allTodos.find(function(t) { return t.id === todo.parentId; });
          if (parent && parent.done) {
            reopenTodo(parent);
            return;
          }
        }
        render();
      })
      .catch(function(err) {
        console.error('Error reopening todo:', err);
      });
  }

  function deleteTodo(todoId) {
    if (!window.dmDb) return;

    // Also delete children
    var toDelete = [todoId];
    allTodos.forEach(function(t) {
      if (t.parentId === todoId) toDelete.push(t.id);
    });

    var chain = Promise.resolve();
    toDelete.forEach(function(id) {
      chain = chain.then(function() {
        return window.dmDb.collection('todos').doc(id).delete()
          .then(function() {
            if (window.dmSync) return window.dmSync.deleteTodo(id);
          });
      });
    });

    chain.then(function() {
      allTodos = allTodos.filter(function(t) {
        return toDelete.indexOf(t.id) === -1;
      });
      render();
    }).catch(function(err) {
      console.error('Error deleting todo:', err);
      showTodoError('Failed to delete task — check console');
    });
  }

  function clearAllCompleted(ids) {
    if (!window.dmDb || ids.length === 0) return;

    var chain = Promise.resolve();
    ids.forEach(function(id) {
      chain = chain.then(function() {
        return window.dmDb.collection('todos').doc(id).delete()
          .then(function() {
            if (window.dmSync) return window.dmSync.deleteTodo(id);
          });
      });
    });

    chain.then(function() {
      allTodos = allTodos.filter(function(t) {
        return ids.indexOf(t.id) === -1;
      });
      render();
    }).catch(function(err) {
      console.error('Error clearing completed:', err);
      showTodoError('Failed to clear completed tasks — check console');
    });
  }

  // ─── Add form ───
  function addFromForm() {
    var title = addTitleInput.value.trim();
    if (!title) { addTitleInput.focus(); return; }
    var est = parseInt(addEstimateInput.value, 10) || 25;
    var scheduledDate = addDateInput.value || null;
    addBtn.disabled = true;
    createTodo(title, est, null, scheduledDate, function() {
      addBtn.disabled = false;
    });
    addTitleInput.value = '';
    addEstimateInput.value = '';
    // Keep date input as-is so user can add multiple tasks to same day
    addTitleInput.focus();
  }

  addBtn.addEventListener('click', addFromForm);
  addTitleInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') { e.preventDefault(); addFromForm(); }
  });
  addEstimateInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') { e.preventDefault(); addFromForm(); }
  });
  addDateInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') { e.preventDefault(); addFromForm(); }
  });

  // ─── Load todos ───
  function loadTodos() {
    if (!window.dmSync) return;

    window.dmSync.getAllTodos().then(function(todos) {
      allTodos = todos;
      render();
    });
  }

  // Listen for todo updates
  window.addEventListener('dm-todos-updated', loadTodos);
  window.addEventListener('dm-sync-complete', loadTodos);

  // Initial load when auth is ready
  if (window.dmAuth) {
    window.dmAuth.onAuthStateChanged(function(user) {
      if (user) {
        loadTodos();
      } else {
        allTodos = [];
        render();
      }
    });
  }

})();
</script>
