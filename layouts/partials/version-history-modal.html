<!-- Version History Modal — included once via inject/body.html -->
<!-- Exposes: window.dmVersionHistory.open(note, options), window.dmVersionHistory.close() -->
<div class="vh-modal" id="vh-modal" style="display: none;">
  <div class="vh-backdrop" id="vh-backdrop"></div>
  <div class="vh-dialog">
    <div class="vh-header">
      <h3>Version History</h3>
      <span class="vh-note-title" id="vh-note-title"></span>
      <button type="button" class="vh-close" id="vh-close">&times;</button>
    </div>
    <div class="vh-body">
      <div class="vh-sidebar" id="vh-sidebar">
        <div class="vh-loading" id="vh-loading">Loading versions...</div>
        <div class="vh-empty" id="vh-empty" style="display: none;">No previous versions found.</div>
        <ul class="vh-list" id="vh-list"></ul>
      </div>
      <div class="vh-content" id="vh-content">
        <div class="vh-content-placeholder">Select a version to view changes</div>
      </div>
    </div>
  </div>
</div>

<style>
.vh-modal {
  position: fixed;
  inset: 0;
  z-index: 99998;
  display: flex;
  align-items: center;
  justify-content: center;
}
.vh-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.5);
}
.vh-dialog {
  position: relative;
  background: var(--body-background, #fff);
  border-radius: 10px;
  width: min(95vw, 900px);
  max-height: 80vh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 16px 48px rgba(0,0,0,0.2);
  overflow: hidden;
}
.vh-header {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem 1rem;
  border-bottom: 1px solid var(--gray-200, #e5e7eb);
  flex-shrink: 0;
}
.vh-header h3 {
  margin: 0;
  font-size: 0.9375rem;
  font-weight: 600;
  white-space: nowrap;
}
.vh-note-title {
  font-size: 0.8125rem;
  color: var(--gray-400, #9ca3af);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  flex: 1;
}
.vh-close {
  background: none;
  border: none;
  font-size: 1.25rem;
  cursor: pointer;
  color: var(--gray-400, #9ca3af);
  padding: 0.25rem;
  line-height: 1;
  flex-shrink: 0;
}
.vh-close:hover { color: var(--body-font-color, #333); }
.vh-body {
  display: flex;
  flex: 1;
  min-height: 0;
  overflow: hidden;
}
.vh-sidebar {
  width: 220px;
  flex-shrink: 0;
  border-right: 1px solid var(--gray-200, #e5e7eb);
  overflow-y: auto;
  padding: 0.5rem 0;
}
.vh-loading, .vh-empty {
  padding: 1rem;
  color: var(--gray-400, #9ca3af);
  font-size: 0.8125rem;
  text-align: center;
}
.vh-list {
  list-style: none;
  margin: 0;
  padding: 0;
}
.vh-list-item {
  padding: 0.5rem 0.75rem;
  cursor: pointer;
  border-left: 3px solid transparent;
  transition: background 0.15s;
  font-size: 0.8125rem;
}
.vh-list-item:hover {
  background: var(--gray-100, #f3f4f6);
}
.vh-list-item.vh-active {
  background: var(--color-link-bg, rgba(0,85,187,0.06));
  border-left-color: var(--color-link, #0055bb);
}
.vh-list-date {
  font-weight: 600;
  color: var(--body-font-color, #333);
}
.vh-list-time {
  color: var(--gray-400, #9ca3af);
  font-size: 0.75rem;
}
.vh-list-summary {
  color: var(--gray-400, #9ca3af);
  font-size: 0.6875rem;
  margin-top: 2px;
}
.vh-content {
  flex: 1;
  overflow-y: auto;
  padding: 1rem;
  min-width: 0;
}
.vh-content-placeholder {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: var(--gray-400, #9ca3af);
  font-size: 0.875rem;
}
.vh-toolbar {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
  flex-wrap: wrap;
}
.vh-toolbar-btn {
  background: var(--gray-100, #f3f4f6);
  border: 1px solid var(--gray-200, #e5e7eb);
  border-radius: 5px;
  padding: 0.3rem 0.65rem;
  font-size: 0.75rem;
  cursor: pointer;
  color: var(--body-font-color, #333);
  transition: background 0.15s;
}
.vh-toolbar-btn:hover {
  background: var(--gray-200, #e5e7eb);
}
.vh-toolbar-btn.vh-btn-restore {
  background: var(--color-link, #0055bb);
  color: #fff;
  border-color: var(--color-link, #0055bb);
}
.vh-toolbar-btn.vh-btn-restore:hover {
  opacity: 0.85;
}
.vh-toolbar-btn.vh-btn-delete {
  color: var(--color-danger, #ea4335);
  border-color: var(--color-danger, #ea4335);
  background: transparent;
}
.vh-toolbar-btn.vh-btn-delete:hover {
  background: var(--color-danger-bg, rgba(234,67,53,0.1));
}
.vh-view-toggle {
  margin-left: auto;
  display: flex;
  gap: 2px;
  background: var(--gray-100, #f3f4f6);
  border-radius: 5px;
  padding: 2px;
}
.vh-view-toggle button {
  background: transparent;
  border: none;
  padding: 0.25rem 0.5rem;
  font-size: 0.6875rem;
  cursor: pointer;
  border-radius: 3px;
  color: var(--gray-400, #9ca3af);
  font-weight: 500;
}
.vh-view-toggle button.vh-toggle-active {
  background: var(--body-background, #fff);
  color: var(--body-font-color, #333);
  box-shadow: 0 1px 2px rgba(0,0,0,0.08);
}

/* Diff view */
.vh-diff {
  font-family: 'SF Mono', 'Fira Code', 'Fira Mono', 'Roboto Mono', monospace;
  font-size: 0.75rem;
  line-height: 1.5;
  border: 1px solid var(--gray-200, #e5e7eb);
  border-radius: 6px;
  overflow: auto;
  max-height: 55vh;
}
.vh-diff-line {
  padding: 1px 0.75rem;
  white-space: pre-wrap;
  word-break: break-all;
}
.vh-diff-add {
  background: rgba(34,197,94,0.12);
  color: var(--color-success, #34a853);
}
.vh-diff-del {
  background: rgba(234,67,53,0.1);
  color: var(--color-danger, #ea4335);
  text-decoration: line-through;
}
.vh-diff-ctx {
  color: var(--gray-400, #9ca3af);
}
.vh-diff-hdr {
  background: var(--gray-100, #f3f4f6);
  color: var(--color-link, #0055bb);
  font-weight: 600;
  padding: 0.25rem 0.75rem;
  border-bottom: 1px solid var(--gray-200, #e5e7eb);
}

/* Full content view */
.vh-full-content {
  font-size: 0.8125rem;
  line-height: 1.6;
  border: 1px solid var(--gray-200, #e5e7eb);
  border-radius: 6px;
  padding: 1rem;
  overflow: auto;
  max-height: 55vh;
  white-space: pre-wrap;
  word-break: break-word;
}

.vh-meta {
  font-size: 0.75rem;
  color: var(--gray-400, #9ca3af);
  margin-bottom: 0.5rem;
}
.vh-meta-tags {
  display: flex;
  gap: 0.25rem;
  flex-wrap: wrap;
  margin-top: 0.25rem;
}
.vh-meta-tag {
  background: var(--gray-100, #f3f4f6);
  padding: 0.1rem 0.4rem;
  border-radius: 3px;
  font-size: 0.6875rem;
}

@media (max-width: 640px) {
  .vh-body {
    flex-direction: column;
  }
  .vh-sidebar {
    width: 100%;
    border-right: none;
    border-bottom: 1px solid var(--gray-200, #e5e7eb);
    max-height: 150px;
  }
}
</style>

<script>
(function() {
  var modal = document.getElementById('vh-modal');
  var backdrop = document.getElementById('vh-backdrop');
  var closeBtn = document.getElementById('vh-close');
  var sidebar = document.getElementById('vh-sidebar');
  var listEl = document.getElementById('vh-list');
  var contentEl = document.getElementById('vh-content');
  var loadingEl = document.getElementById('vh-loading');
  var emptyEl = document.getElementById('vh-empty');
  var noteTitleEl = document.getElementById('vh-note-title');

  var currentNote = null;
  var versions = [];
  var selectedIndex = -1;
  var viewMode = 'diff'; // 'diff' or 'full'
  var onRestoreCallback = null;

  function open(note, opts) {
    if (!note || !window.dmSync) return;
    currentNote = note;
    onRestoreCallback = (opts && opts.onRestore) || null;
    selectedIndex = -1;
    viewMode = 'diff';

    noteTitleEl.textContent = note.title || 'Untitled';
    contentEl.innerHTML = '<div class="vh-content-placeholder">Select a version to view changes</div>';
    listEl.innerHTML = '';
    loadingEl.style.display = '';
    emptyEl.style.display = 'none';

    modal.style.display = '';
    document.body.style.overflow = 'hidden';

    // Load versions
    window.dmSync.getVersionsForNote(note.id).then(function(v) {
      versions = v;
      loadingEl.style.display = 'none';

      if (versions.length === 0) {
        emptyEl.style.display = '';
        return;
      }

      renderList();
    }).catch(function(err) {
      console.error('Error loading versions:', err);
      loadingEl.style.display = 'none';
      emptyEl.style.display = '';
      emptyEl.textContent = 'Error loading versions.';
    });
  }

  function close() {
    modal.style.display = 'none';
    document.body.style.overflow = '';
    currentNote = null;
    versions = [];
    selectedIndex = -1;
    onRestoreCallback = null;
  }

  function renderList() {
    listEl.innerHTML = '';
    versions.forEach(function(v, i) {
      var li = document.createElement('li');
      li.className = 'vh-list-item' + (i === selectedIndex ? ' vh-active' : '');
      li.setAttribute('data-index', i);

      var d = new Date(v.createdAt);
      var dateStr = d.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
      var timeStr = d.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });

      // Compute a brief summary
      var contentLen = (v.content || '').length;
      var summary = contentLen + ' chars';
      if (v.title) summary = v.title.substring(0, 30) + (v.title.length > 30 ? '...' : '');

      li.innerHTML =
        '<div class="vh-list-date">' + escHtml(dateStr) + '</div>' +
        '<div class="vh-list-time">' + escHtml(timeStr) + '</div>' +
        '<div class="vh-list-summary">' + escHtml(summary) + '</div>';

      li.addEventListener('click', function() {
        selectedIndex = i;
        renderList();
        renderContent(i);
      });

      listEl.appendChild(li);
    });
  }

  function renderContent(index) {
    var version = versions[index];
    if (!version || !currentNote) return;

    var d = new Date(version.createdAt);
    var dateStr = d.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
    var timeStr = d.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit', second: '2-digit' });

    var html = '';

    // Toolbar
    html += '<div class="vh-toolbar">';
    html += '<button class="vh-toolbar-btn vh-btn-restore" data-action="restore" title="Restore this version">Restore</button>';
    html += '<button class="vh-toolbar-btn vh-btn-delete" data-action="delete" title="Delete this version">Delete</button>';
    html += '<div class="vh-view-toggle">';
    html += '<button data-view="diff" class="' + (viewMode === 'diff' ? 'vh-toggle-active' : '') + '">Diff</button>';
    html += '<button data-view="full" class="' + (viewMode === 'full' ? 'vh-toggle-active' : '') + '">Full</button>';
    html += '</div>';
    html += '</div>';

    // Meta
    html += '<div class="vh-meta">';
    html += 'Saved ' + escHtml(dateStr) + ' at ' + escHtml(timeStr);
    if (version.tags && version.tags.length) {
      html += '<div class="vh-meta-tags">';
      version.tags.forEach(function(t) {
        html += '<span class="vh-meta-tag">' + escHtml(t) + '</span>';
      });
      html += '</div>';
    }
    html += '</div>';

    // Content view
    if (viewMode === 'diff') {
      html += renderDiff(version.content || '', currentNote.content || '');
    } else {
      html += '<div class="vh-full-content">' + escHtml(version.content || '(empty)') + '</div>';
    }

    contentEl.innerHTML = html;

    // Bind toolbar actions
    contentEl.querySelectorAll('[data-action]').forEach(function(btn) {
      btn.addEventListener('click', function() {
        var action = btn.getAttribute('data-action');
        if (action === 'restore') {
          if (!confirm('Restore this version? Your current content will be replaced in the editor.')) return;
          if (onRestoreCallback) {
            onRestoreCallback(version);
          }
          close();
        } else if (action === 'delete') {
          if (!confirm('Delete this version permanently?')) return;
          btn.disabled = true;
          window.dmSync.deleteVersion(version.id).then(function() {
            versions.splice(index, 1);
            selectedIndex = -1;
            if (versions.length === 0) {
              listEl.innerHTML = '';
              emptyEl.style.display = '';
              contentEl.innerHTML = '<div class="vh-content-placeholder">No versions remaining</div>';
            } else {
              renderList();
              contentEl.innerHTML = '<div class="vh-content-placeholder">Select a version to view changes</div>';
            }
          }).catch(function(err) {
            console.error('Error deleting version:', err);
            btn.disabled = false;
          });
        }
      });
    });

    // View toggle
    contentEl.querySelectorAll('[data-view]').forEach(function(btn) {
      btn.addEventListener('click', function() {
        viewMode = btn.getAttribute('data-view');
        renderContent(index);
      });
    });
  }

  /**
   * Simple line-by-line diff between old and new content.
   * Returns HTML string.
   */
  function renderDiff(oldText, newText) {
    var oldLines = oldText.split('\n');
    var newLines = newText.split('\n');

    // Compute LCS-based diff
    var diff = computeDiff(oldLines, newLines);

    var html = '<div class="vh-diff">';
    html += '<div class="vh-diff-hdr">Version (old) vs Current</div>';

    diff.forEach(function(entry) {
      if (entry.type === 'del') {
        html += '<div class="vh-diff-line vh-diff-del">- ' + escHtml(entry.line) + '</div>';
      } else if (entry.type === 'add') {
        html += '<div class="vh-diff-line vh-diff-add">+ ' + escHtml(entry.line) + '</div>';
      } else {
        html += '<div class="vh-diff-line vh-diff-ctx">  ' + escHtml(entry.line) + '</div>';
      }
    });

    html += '</div>';
    return html;
  }

  /**
   * Compute a simple diff using longest common subsequence.
   * Returns array of { type: 'ctx'|'add'|'del', line: string }
   */
  function computeDiff(oldLines, newLines) {
    var m = oldLines.length;
    var n = newLines.length;

    // For very large files, fall back to simple comparison
    if (m * n > 500000) {
      return simpleDiff(oldLines, newLines);
    }

    // Build LCS table
    var dp = [];
    for (var i = 0; i <= m; i++) {
      dp[i] = [];
      for (var j = 0; j <= n; j++) {
        if (i === 0 || j === 0) {
          dp[i][j] = 0;
        } else if (oldLines[i-1] === newLines[j-1]) {
          dp[i][j] = dp[i-1][j-1] + 1;
        } else {
          dp[i][j] = Math.max(dp[i-1][j], dp[i][j-1]);
        }
      }
    }

    // Backtrack to produce diff
    var result = [];
    var i = m, j = n;
    while (i > 0 || j > 0) {
      if (i > 0 && j > 0 && oldLines[i-1] === newLines[j-1]) {
        result.unshift({ type: 'ctx', line: oldLines[i-1] });
        i--; j--;
      } else if (j > 0 && (i === 0 || dp[i][j-1] >= dp[i-1][j])) {
        result.unshift({ type: 'add', line: newLines[j-1] });
        j--;
      } else {
        result.unshift({ type: 'del', line: oldLines[i-1] });
        i--;
      }
    }

    return result;
  }

  /**
   * Fallback simple diff for very large files — just shows all old as removed, all new as added.
   */
  function simpleDiff(oldLines, newLines) {
    var result = [];
    oldLines.forEach(function(l) { result.push({ type: 'del', line: l }); });
    newLines.forEach(function(l) { result.push({ type: 'add', line: l }); });
    return result;
  }

  function escHtml(str) {
    var div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  // Close handlers
  backdrop.addEventListener('click', close);
  closeBtn.addEventListener('click', close);
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && modal.style.display !== 'none') {
      e.preventDefault();
      close();
    }
  });

  // Expose public API
  window.dmVersionHistory = {
    open: open,
    close: close
  };
})();
</script>
