<!-- Theme toggle button -->
<button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme" title="Toggle light/dark theme">
  <svg class="theme-icon theme-icon--sun" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="12" cy="12" r="5"></circle>
    <line x1="12" y1="1" x2="12" y2="3"></line>
    <line x1="12" y1="21" x2="12" y2="23"></line>
    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
    <line x1="1" y1="12" x2="3" y2="12"></line>
    <line x1="21" y1="12" x2="23" y2="12"></line>
    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
  </svg>
  <svg class="theme-icon theme-icon--moon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
  </svg>
</button>

<script>
(function() {
  var toggle = document.getElementById('theme-toggle');
  if (!toggle) return;

  function getEffectiveTheme() {
    var saved = localStorage.getItem('dm-theme');
    if (saved === 'light' || saved === 'dark') return saved;
    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  }

  function applyTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('dm-theme', theme);
    updateMeta(theme);
  }

  function updateMeta(theme) {
    var meta = document.querySelector('meta[name="theme-color"]');
    if (meta) meta.setAttribute('content', theme === 'dark' ? '#161921' : '#ffffff');
    var cs = document.querySelector('meta[name="color-scheme"]');
    if (cs) cs.setAttribute('content', theme);
  }

  // Set initial state
  var current = getEffectiveTheme();
  document.documentElement.setAttribute('data-theme', current);
  updateMeta(current);

  toggle.addEventListener('click', function() {
    var now = getEffectiveTheme();
    var next = now === 'dark' ? 'light' : 'dark';
    applyTheme(next);
  });

  // Listen for OS theme changes (only if user hasn't overridden)
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
    if (!localStorage.getItem('dm-theme')) {
      var theme = e.matches ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', theme);
      updateMeta(theme);
    }
  });
})();
</script>

<!-- Sidebar collapse/expand toggle -->
<script>
(function() {
  var toggle = document.getElementById('sidebar-toggle');
  if (!toggle) return;

  function isCollapsed() {
    return document.documentElement.classList.contains('sidebar-collapsed');
  }

  function setSidebar(collapsed) {
    if (collapsed) {
      document.documentElement.classList.add('sidebar-collapsed');
      toggle.setAttribute('aria-label', 'Expand sidebar');
    } else {
      document.documentElement.classList.remove('sidebar-collapsed');
      toggle.setAttribute('aria-label', 'Collapse sidebar');
    }
    try { localStorage.setItem('dm-sidebar-collapsed', collapsed ? '1' : '0'); } catch(e) {}
  }

  toggle.addEventListener('click', function() {
    setSidebar(!isCollapsed());
  });

  // Keyboard shortcut: [ to toggle sidebar
  document.addEventListener('keydown', function(e) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) return;
    if (e.key === '[' && !e.ctrlKey && !e.metaKey && !e.altKey) {
      e.preventDefault();
      setSidebar(!isCollapsed());
    }
  });
})();
</script>

<!-- Quick Capture FAB (Floating Action Button) -->
<button class="quick-capture-fab" id="quick-capture-btn" aria-label="Quick Capture (E)" title="Quick Capture">
  <svg class="fab-icon" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M12 20h9"></path>
    <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
  </svg>
  <span class="fab-tooltip">Quick Capture <kbd>E</kbd></span>
</button>

{{ partial "quick-capture-modal.html" . }}

{{ partial "search-modal.html" . }}

<!-- Quick Capture modal logic -->
<script>
(function() {
  var btn = document.getElementById('quick-capture-btn');
  var modal = document.getElementById('quick-capture-modal');
  if (!modal) return;

  var backdrop = document.getElementById('quick-capture-backdrop');
  var input = document.getElementById('quick-capture-input');
  var titleInput = document.getElementById('qc-title-input');
  var cancelBtn = document.getElementById('qc-cancel');
  var submitBtn = document.getElementById('qc-submit');
  var destButtons = document.querySelectorAll('.qc-dest-btn');
  var modeButtons = document.querySelectorAll('.qc-mode-btn');
  var langButtons = document.querySelectorAll('.qc-lang-btn');
  var destRow = document.getElementById('qc-destination-row');
  var langRow = document.getElementById('qc-language-row');
  var previewWrapper = document.getElementById('qc-preview-wrapper');
  var previewPanel = document.getElementById('qc-preview-panel');
  var dialog = modal.querySelector('.quick-capture-dialog');
  var toolbar = document.getElementById('qc-toolbar');
  var toolbarButtons = toolbar ? toolbar.querySelectorAll('.qc-toolbar-btn') : [];

  // State
  var currentMode = 'note'; // 'note' or 'code'
  var selectedLang = 'kotlin';
  var selectedDest = {
    path: 'content/docs/inbox',
    tag: 'inbox'
  };
  var previewTimer = null;

  // Slug helper: lowercase, replace non-alphanum with hyphens, collapse, trim
  function slugify(str) {
    return str.toLowerCase()
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/^-+|-+$/g, '')
      .substring(0, 60);
  }

  // =========================================================================
  // Markdown formatting toolbar helpers
  // =========================================================================

  // Wrap selected text with before/after markers (bold, italic, code)
  function wrapSelection(before, after) {
    var start = input.selectionStart;
    var end = input.selectionEnd;
    var text = input.value;
    var selected = text.slice(start, end);

    // If no selection, insert markers with cursor between them
    if (start === end) {
      var inserted = before + after;
      input.value = text.slice(0, start) + inserted + text.slice(end);
      input.selectionStart = input.selectionEnd = start + before.length;
    } else {
      input.value = text.slice(0, start) + before + selected + after + text.slice(end);
      input.selectionStart = start + before.length;
      input.selectionEnd = end + before.length;
    }
    input.focus();
  }

  // Prefix each selected line (or current line) with a string
  function prefixLines(prefix) {
    var start = input.selectionStart;
    var end = input.selectionEnd;
    var text = input.value;

    // Find the start of the first selected line
    var lineStart = text.lastIndexOf('\n', start - 1) + 1;
    // Find the end of the last selected line
    var lineEnd = text.indexOf('\n', end);
    if (lineEnd === -1) lineEnd = text.length;

    var block = text.slice(lineStart, lineEnd);
    var lines = block.split('\n');
    var prefixed = lines.map(function(line) { return prefix + line; }).join('\n');

    input.value = text.slice(0, lineStart) + prefixed + text.slice(lineEnd);

    // Place cursor at end of modified block
    var newEnd = lineStart + prefixed.length;
    input.selectionStart = lineStart;
    input.selectionEnd = newEnd;
    input.focus();
  }

  // Insert link markdown: [text](url) or [](url) if no selection
  function insertLink() {
    var start = input.selectionStart;
    var end = input.selectionEnd;
    var text = input.value;
    var selected = text.slice(start, end);

    if (selected) {
      var inserted = '[' + selected + '](url)';
      input.value = text.slice(0, start) + inserted + text.slice(end);
      // Select "url" so user can type over it
      input.selectionStart = start + selected.length + 2;
      input.selectionEnd = start + selected.length + 5;
    } else {
      input.value = text.slice(0, start) + '[](url)' + text.slice(end);
      // Place cursor inside [] for link text
      input.selectionStart = input.selectionEnd = start + 1;
    }
    input.focus();
  }

  function applyFormat(format) {
    switch (format) {
      case 'bold':    wrapSelection('**', '**'); break;
      case 'italic':  wrapSelection('*', '*'); break;
      case 'code':    wrapSelection('`', '`'); break;
      case 'heading': prefixLines('## '); break;
      case 'bullet':  prefixLines('- '); break;
      case 'todo':    prefixLines('- [ ] '); break;
      case 'link':    insertLink(); break;
    }
  }

  // Toolbar button click handlers
  toolbarButtons.forEach(function(tbtn) {
    tbtn.addEventListener('click', function(e) {
      e.preventDefault();
      var format = tbtn.getAttribute('data-format');
      applyFormat(format);
    });
  });

  // =========================================================================
  // Mini syntax highlighter â€” outputs <span> with Chroma-compatible classes
  // Covers keywords, strings, comments, numbers, and functions for our 8 langs.
  // =========================================================================
  var langKeywords = {
    kotlin: /\b(fun|val|var|class|object|interface|if|else|when|for|while|do|return|break|continue|import|package|is|as|in|null|true|false|this|super|throw|try|catch|finally|typealias|companion|data|sealed|enum|open|abstract|override|private|public|protected|internal|inline|suspend|lateinit|by|init|constructor|get|set|it)\b/g,
    bash: /\b(if|then|else|elif|fi|for|while|do|done|case|esac|function|return|in|select|until|local|export|source|alias|unalias|readonly|declare|typeset|set|unset|shift|trap|exec|eval|exit|echo|printf|read|test|true|false)\b/g,
    sql: /\b(SELECT|FROM|WHERE|INSERT|INTO|UPDATE|SET|DELETE|CREATE|DROP|ALTER|TABLE|INDEX|VIEW|JOIN|INNER|LEFT|RIGHT|OUTER|CROSS|ON|AND|OR|NOT|IN|IS|NULL|AS|ORDER|BY|GROUP|HAVING|LIMIT|OFFSET|UNION|ALL|EXISTS|BETWEEN|LIKE|DISTINCT|COUNT|SUM|AVG|MIN|MAX|CASE|WHEN|THEN|ELSE|END|VALUES|PRIMARY|KEY|FOREIGN|REFERENCES|DEFAULT|CONSTRAINT|UNIQUE|CHECK|CASCADE|TRIGGER|FUNCTION|PROCEDURE|BEGIN|COMMIT|ROLLBACK|GRANT|REVOKE|WITH|RECURSIVE|RETURNING|COALESCE|CAST|NULLIF|select|from|where|insert|into|update|set|delete|create|drop|alter|table|index|view|join|inner|left|right|outer|cross|on|and|or|not|in|is|null|as|order|by|group|having|limit|offset|union|all|exists|between|like|distinct|count|sum|avg|min|max|case|when|then|else|end|values|primary|key|foreign|references|default|constraint|unique|check|cascade|trigger|function|procedure|begin|commit|rollback|grant|revoke|with|recursive|returning|coalesce|cast|nullif)\b/g,
    ruby: /\b(def|end|class|module|if|elsif|else|unless|while|until|for|do|begin|rescue|ensure|raise|return|yield|require|include|extend|attr_accessor|attr_reader|attr_writer|puts|print|nil|true|false|self|super|then|and|or|not|in|case|when|lambda|proc|block_given)\b/g,
    python: /\b(def|class|if|elif|else|for|while|return|import|from|as|try|except|finally|raise|with|yield|lambda|pass|break|continue|and|or|not|in|is|None|True|False|self|print|async|await|global|nonlocal|assert|del)\b/g,
    go: /\b(func|package|import|var|const|type|struct|interface|map|chan|range|if|else|for|switch|case|default|select|break|continue|return|go|defer|fallthrough|nil|true|false|make|new|len|cap|append|copy|delete|close|panic|recover|error|string|int|int8|int16|int32|int64|uint|float32|float64|bool|byte|rune)\b/g,
    javascript: /\b(function|var|let|const|if|else|for|while|do|switch|case|default|break|continue|return|class|extends|new|this|super|import|export|from|as|try|catch|finally|throw|async|await|yield|typeof|instanceof|in|of|delete|void|null|undefined|true|false|console|window|document|NaN|Infinity|require|module|Promise|Map|Set|Symbol|Array|Object|RegExp)\b/g,
    yaml: /\b(true|false|null|yes|no|on|off)\b/g
  };

  var langComments = {
    kotlin:     { line: '//', block: ['/\\*', '\\*/'] },
    bash:       { line: '#', block: null },
    sql:        { line: '--', block: ['/\\*', '\\*/'] },
    ruby:       { line: '#', block: ['=begin', '=end'] },
    python:     { line: '#', block: null },
    go:         { line: '//', block: ['/\\*', '\\*/'] },
    javascript: { line: '//', block: ['/\\*', '\\*/'] },
    yaml:       { line: '#', block: null }
  };

  function escapeHtml(str) {
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  function highlightCode(code, lang) {
    if (!code) return '';

    // Tokenize: we process the string linearly to avoid overlapping matches.
    // Tokens: { start, end, cls }
    var tokens = [];
    var src = code;

    // 1) Strings (double-quoted, single-quoted, backtick for JS)
    var strPatterns = lang === 'python'
      ? [/"""[\s\S]*?"""/g, /'''[\s\S]*?'''/g, /"(?:[^"\\]|\\.)*"/g, /'(?:[^'\\]|\\.)*'/g]
      : lang === 'javascript'
      ? [/"(?:[^"\\]|\\.)*"/g, /'(?:[^'\\]|\\.)*'/g, /`(?:[^`\\]|\\.)*`/g]
      : [/"(?:[^"\\]|\\.)*"/g, /'(?:[^'\\]|\\.)*'/g];

    strPatterns.forEach(function(re) {
      var m;
      while ((m = re.exec(src)) !== null) {
        tokens.push({ start: m.index, end: m.index + m[0].length, cls: 's' });
      }
    });

    // 2) Comments
    var cmt = langComments[lang];
    if (cmt) {
      if (cmt.line) {
        var lineRe = new RegExp(cmt.line.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '.*', 'gm');
        var m;
        while ((m = lineRe.exec(src)) !== null) {
          tokens.push({ start: m.index, end: m.index + m[0].length, cls: 'c1' });
        }
      }
      if (cmt.block) {
        var blockRe = new RegExp(cmt.block[0] + '[\\s\\S]*?' + cmt.block[1], 'g');
        var m;
        while ((m = blockRe.exec(src)) !== null) {
          tokens.push({ start: m.index, end: m.index + m[0].length, cls: 'cm' });
        }
      }
    }

    // 3) Numbers
    var numRe = /\b(?:0[xX][0-9a-fA-F]+|0[bB][01]+|0[oO][0-7]+|\d+\.?\d*(?:[eE][+-]?\d+)?)\b/g;
    var m;
    while ((m = numRe.exec(src)) !== null) {
      tokens.push({ start: m.index, end: m.index + m[0].length, cls: 'mi' });
    }

    // Sort tokens by start, then by length descending (longer wins)
    tokens.sort(function(a, b) { return a.start - b.start || (b.end - b.start) - (a.end - a.start); });

    // Remove overlapping tokens (first one wins)
    var filtered = [];
    var lastEnd = 0;
    tokens.forEach(function(t) {
      if (t.start >= lastEnd) {
        filtered.push(t);
        lastEnd = t.end;
      }
    });

    // Build output: interleave plain text (with keyword highlighting) and tokens
    var out = '';
    var pos = 0;

    function highlightKeywords(text) {
      var kwRe = langKeywords[lang];
      if (!kwRe) return escapeHtml(text);
      // Reset regex
      kwRe.lastIndex = 0;
      var result = '';
      var last = 0;
      var km;
      while ((km = kwRe.exec(text)) !== null) {
        result += escapeHtml(text.slice(last, km.index));
        result += '<span class="k">' + escapeHtml(km[0]) + '</span>';
        last = km.index + km[0].length;
      }
      result += escapeHtml(text.slice(last));

      // Also highlight function calls: word followed by (
      result = result.replace(/\b([a-zA-Z_]\w*)(\()/g, function(match, name, paren) {
        // Don't re-wrap already-wrapped keywords
        if (match.indexOf('<span') !== -1) return match;
        return '<span class="nf">' + name + '</span>' + paren;
      });

      return result;
    }

    filtered.forEach(function(t) {
      if (t.start > pos) {
        out += highlightKeywords(src.slice(pos, t.start));
      }
      out += '<span class="' + t.cls + '">' + escapeHtml(src.slice(t.start, t.end)) + '</span>';
      pos = t.end;
    });
    if (pos < src.length) {
      out += highlightKeywords(src.slice(pos));
    }

    return out;
  }

  function updatePreview() {
    if (currentMode !== 'code' || !previewPanel) return;
    var code = input.value;
    if (!code.trim()) {
      previewPanel.innerHTML = '<div class="qc-preview-empty">Start typing to see highlighted preview...</div>';
      return;
    }
    var highlighted = highlightCode(code, selectedLang);
    previewPanel.innerHTML = '<pre class="chroma"><code>' + highlighted + '</code></pre>';
  }

  function schedulePreview() {
    if (previewTimer) clearTimeout(previewTimer);
    previewTimer = setTimeout(updatePreview, 150);
  }

  // Listen for input on textarea
  input.addEventListener('input', function() {
    if (currentMode === 'code') schedulePreview();
  });

  // Mode toggle
  modeButtons.forEach(function(mbtn) {
    mbtn.addEventListener('click', function() {
      var mode = mbtn.getAttribute('data-mode');
      if (mode === currentMode) return;
      currentMode = mode;
      modeButtons.forEach(function(b) { b.classList.remove('active'); });
      mbtn.classList.add('active');

      if (mode === 'code') {
        destRow.style.display = 'none';
        langRow.style.display = '';
        previewWrapper.style.display = '';
        if (toolbar) toolbar.style.display = 'none';
        input.classList.add('code-mode');
        dialog.classList.add('code-mode');
        input.placeholder = 'Paste or type your code here...';
        updatePreview();
      } else {
        destRow.style.display = '';
        langRow.style.display = 'none';
        previewWrapper.style.display = 'none';
        if (toolbar) toolbar.style.display = '';
        input.classList.remove('code-mode');
        dialog.classList.remove('code-mode');
        input.placeholder = "What's on your mind?";
      }
    });
  });

  // Destination button click handling
  destButtons.forEach(function(dbtn) {
    dbtn.addEventListener('click', function() {
      destButtons.forEach(function(b) { b.classList.remove('active'); });
      dbtn.classList.add('active');
      selectedDest.path = dbtn.getAttribute('data-path');
      selectedDest.tag = dbtn.getAttribute('data-tag');
    });
  });

  // Language button click handling
  langButtons.forEach(function(lbtn) {
    lbtn.addEventListener('click', function() {
      langButtons.forEach(function(b) { b.classList.remove('active'); });
      lbtn.classList.add('active');
      selectedLang = lbtn.getAttribute('data-lang');
      updatePreview();
    });
  });

  function openModal() {
    // Reset state
    currentMode = 'note';
    selectedLang = 'kotlin';
    modeButtons.forEach(function(b) { b.classList.remove('active'); });
    modeButtons[0].classList.add('active');
    destRow.style.display = '';
    langRow.style.display = 'none';
    previewWrapper.style.display = 'none';
    if (toolbar) toolbar.style.display = '';
    langButtons.forEach(function(b) { b.classList.remove('active'); });
    langButtons[0].classList.add('active');
    input.classList.remove('code-mode');
    dialog.classList.remove('code-mode');
    input.placeholder = "What's on your mind?";

    modal.classList.add('active');
    modal.setAttribute('aria-hidden', 'false');
    titleInput.value = '';
    input.value = '';
    if (previewPanel) previewPanel.innerHTML = '<div class="qc-preview-empty">Start typing to see highlighted preview...</div>';
    titleInput.focus();
  }

  function closeModal() {
    modal.classList.remove('active');
    modal.setAttribute('aria-hidden', 'true');
    titleInput.value = '';
    input.value = '';
  }

  function pad(n) { return n < 10 ? '0' + n : '' + n; }

  function submit() {
    var text = input.value.trim();
    if (!text) {
      input.focus();
      return;
    }

    var now = new Date();
    var y = now.getFullYear();
    var mo = pad(now.getMonth() + 1);
    var d = pad(now.getDate());
    var h = pad(now.getHours());
    var mi = pad(now.getMinutes());
    var s = pad(now.getSeconds());

    var timestamp = y + '-' + mo + '-' + d + '-' + h + mi + s;
    var isoDate = y + '-' + mo + '-' + d + 'T' + h + ':' + mi + ':' + s;
    var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    var displayDate = months[now.getMonth()] + ' ' + now.getDate() + ', ' + y;

    var userTitle = titleInput.value.trim();
    var url;

    if (currentMode === 'code') {
      // Code snippet mode
      var langLabel = selectedLang.charAt(0).toUpperCase() + selectedLang.slice(1);
      var title = userTitle || (langLabel + ' Snippet - ' + displayDate);
      var fileSlug = userTitle ? slugify(userTitle) + '-' + timestamp : 'snippet-' + timestamp;
      var filename = fileSlug + '.md';

      var content = [
        '---',
        'title: "' + title.replace(/"/g, '\\"') + '"',
        'date: ' + isoDate,
        'tags: [snippet, ' + selectedLang + ']',
        '---',
        '',
        '```' + selectedLang,
        text,
        '```',
        ''
      ].join('\n');

      url = 'https://github.com/paulocdf/digital-memory/new/main/content/docs/snippets/' + selectedLang
          + '?filename=' + encodeURIComponent(filename)
          + '&value=' + encodeURIComponent(content);
    } else {
      // Note mode (original behavior)
      var headingDate = y + '-' + mo + '-' + d + ' ' + h + ':' + mi;
      var title = userTitle || ('Quick Note - ' + displayDate);
      var fileSlug = userTitle ? slugify(userTitle) + '-' + timestamp : 'quick-note-' + timestamp;
      var filename = fileSlug + '.md';

      var content = [
        '---',
        'title: "' + title.replace(/"/g, '\\"') + '"',
        'date: ' + isoDate,
        'tags: [' + selectedDest.tag + ']',
        '---',
        '',
        '## ' + headingDate,
        '',
        text,
        ''
      ].join('\n');

      url = 'https://github.com/paulocdf/digital-memory/new/main/' + selectedDest.path
          + '?filename=' + encodeURIComponent(filename)
          + '&value=' + encodeURIComponent(content);
    }

    window.open(url, '_blank');
    closeModal();
  }

  btn.addEventListener('click', openModal);
  cancelBtn.addEventListener('click', closeModal);
  submitBtn.addEventListener('click', submit);
  backdrop.addEventListener('click', closeModal);

  document.addEventListener('keydown', function(e) {
    // Global shortcut: E to open Quick Capture (when not typing)
    if (!modal.classList.contains('active')) {
      if (e.key === 'e' && !e.ctrlKey && !e.metaKey && !e.altKey) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) return;
        e.preventDefault();
        openModal();
      }
      return;
    }

    // Modal-specific shortcuts
    if (e.key === 'Escape') {
      e.preventDefault();
      closeModal();
    }
    if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
      e.preventDefault();
      submit();
    }

    // Formatting shortcuts (Note mode only, when textarea is focused)
    if (currentMode === 'note' && e.target === input && (e.metaKey || e.ctrlKey)) {
      if (e.key === 'b') {
        e.preventDefault();
        applyFormat('bold');
      } else if (e.key === 'i') {
        e.preventDefault();
        applyFormat('italic');
      } else if (e.key === 'e') {
        e.preventDefault();
        applyFormat('code');
      } else if (e.shiftKey && (e.key === 'T' || e.key === 't')) {
        e.preventDefault();
        applyFormat('todo');
      } else if (e.shiftKey && (e.key === 'H' || e.key === 'h')) {
        e.preventDefault();
        applyFormat('heading');
      }
    }
  });
})();
</script>

<!-- ToC scroll spy, reading progress, and auto-hide -->
<script>
(function() {
  var toc = document.querySelector('.book-toc');
  if (!toc) return;

  var tocNav = toc.querySelector('nav#TableOfContents');
  var tocLinks = tocNav ? tocNav.querySelectorAll('a') : [];
  var progressBar = document.getElementById('toc-progress-bar');

  // Auto-hide ToC if fewer than 2 headings
  if (tocLinks.length < 2) {
    toc.style.display = 'none';
    return;
  }

  // Build a map of heading IDs to ToC link elements
  var headingMap = [];
  tocLinks.forEach(function(link) {
    var href = link.getAttribute('href');
    if (!href || href.charAt(0) !== '#') return;
    var id = decodeURIComponent(href.substring(1));
    var heading = document.getElementById(id);
    if (heading) {
      headingMap.push({ el: heading, link: link });
    }
  });

  if (!headingMap.length) return;

  var rafId = null;

  function update() {
    rafId = null;

    // Reading progress
    if (progressBar) {
      var scrollTop = window.scrollY || document.documentElement.scrollTop;
      var docHeight = document.documentElement.scrollHeight - window.innerHeight;
      var progress = docHeight > 0 ? Math.min(scrollTop / docHeight, 1) : 0;
      progressBar.style.setProperty('--progress', (progress * 100) + '%');
    }

    // Scroll spy: find the heading closest to the top of the viewport
    var scrollPos = window.scrollY || document.documentElement.scrollTop;
    var offset = 80;
    var activeHeading = null;

    for (var i = headingMap.length - 1; i >= 0; i--) {
      if (headingMap[i].el.offsetTop <= scrollPos + offset) {
        activeHeading = headingMap[i];
        break;
      }
    }

    // If scrolled to the very top, activate first heading
    if (!activeHeading && headingMap.length > 0) {
      activeHeading = headingMap[0];
    }

    // Update active class
    tocLinks.forEach(function(link) {
      link.classList.remove('active');
      link.parentElement.classList.remove('toc-active');
    });

    if (activeHeading) {
      activeHeading.link.classList.add('active');
      activeHeading.link.parentElement.classList.add('toc-active');
    }
  }

  function onScroll() {
    if (!rafId) {
      rafId = requestAnimationFrame(update);
    }
  }

  window.addEventListener('scroll', onScroll, { passive: true });
  update();
})();
</script>

