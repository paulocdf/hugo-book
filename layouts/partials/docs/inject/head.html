<!-- Prevent flash of wrong theme: apply saved preference before paint -->
<script>
  (function() {
    var t = localStorage.getItem('dm-theme');
    if (t === 'light' || t === 'dark') {
      document.documentElement.setAttribute('data-theme', t);
    }
    // Prevent flash of wrong sidebar state
    if (localStorage.getItem('dm-sidebar-collapsed') === '1') {
      document.documentElement.classList.add('sidebar-collapsed');
    }
  })();
</script>

<!-- Firebase initialization -->
<script>
  (function() {
    if (typeof firebase === 'undefined') return;
    // Use signInWithRedirect on localhost to avoid third-party cookie issues
    // with signInWithPopup (Chrome blocks cross-origin cookies from firebaseapp.com popup)
    var isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    firebase.initializeApp({
      apiKey: "AIzaSyC_wfs6Ev6vMEr4imhEJ22H0MxSn8AOr_k",
      authDomain: "digital-memory-0.firebaseapp.com",
      projectId: "digital-memory-0",
      storageBucket: "digital-memory-0.firebasestorage.app",
      messagingSenderId: "722285589293",
      appId: "1:722285589293:web:94a32fd0c444b422fed9a4"
    });
    window.dmAuth = firebase.auth();
    window.dmDb = firebase.firestore();
    window.dmStorage = firebase.storage();
    window.dmGoogleProvider = new firebase.auth.GoogleAuthProvider();
    window.dmIsLocalhost = isLocalhost;
    window.dmIsMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

    // Global sign-in helper.
    //
    // Localhost: always use signInWithRedirect (Chrome blocks third-party
    // cookies from the signInWithPopup cross-origin popup).
    //
    // Mobile (iPhone/Android): try signInWithPopup first.  On iOS all browsers
    // use WebKit and Safari ITP blocks cross-origin storage from the
    // firebaseapp.com auth handler, making signInWithRedirect silently fail
    // (getRedirectResult resolves null).  signInWithPopup opens a same-tab
    // popup/sheet that avoids ITP.  If the popup is blocked (rare), fall back
    // to signInWithRedirect as a last resort.
    //
    // Desktop production: signInWithPopup (standard behaviour).
    window.dmSignIn = function() {
      if (!window.dmAuth || !window.dmGoogleProvider) return;
      if (isLocalhost) {
        // Redirect is the only reliable option for localhost
        window.dmAuth.signInWithRedirect(window.dmGoogleProvider);
      } else {
        // Popup-first for both mobile and desktop
        window.dmAuth.signInWithPopup(window.dmGoogleProvider).catch(function(err) {
          // auth/popup-blocked or auth/popup-closed-by-user — fall back to redirect
          if (err.code === 'auth/popup-blocked' ||
              err.code === 'auth/popup-closed-by-user' ||
              err.code === 'auth/cancelled-popup-request') {
            console.warn('Popup blocked/closed, falling back to redirect:', err.code);
            window.dmAuth.signInWithRedirect(window.dmGoogleProvider);
          } else {
            console.error('Sign-in error:', err);
          }
        });
      }
    };

    // dmAuthReady: resolves once Firebase auth state has settled.
    // Prevents the null→user flash on page load (Firebase loads persisted
    // session from IndexedDB asynchronously, causing a brief signed-out state).
    //
    // Always call getRedirectResult() first — both localhost (which always uses
    // signInWithRedirect) and mobile (where we fall back to redirect if popup
    // is blocked) need to process the redirect result after the page reloads.
    // On desktop production this is a harmless no-op (resolves with null).
    window.dmAuthReady = window.dmAuth.getRedirectResult().catch(function(err) {
      console.error('Redirect sign-in error:', err);
    }).then(function() {
      return new Promise(function(resolve) {
        var unsub = window.dmAuth.onAuthStateChanged(function(user) {
          unsub();
          resolve(user);
        });
      });
    });
  })();
</script>
