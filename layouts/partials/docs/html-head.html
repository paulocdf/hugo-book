<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="{{ default .Summary .Description }}">
<meta name="theme-color" content="#161921">
<meta name="color-scheme" content="light dark">

{{- with .Page.Params.BookHref -}}
  <meta http-equiv="Refresh" content="0; url='{{ . }}'" />
{{- end -}}

{{- template "_internal/opengraph.html" . -}}

<title>{{ partial "docs/html-head-title" . }}</title>

{{- $manifest := resources.Get "manifest.json" | resources.ExecuteAsTemplate "manifest.json" . }}
<link rel="manifest" href="{{ $manifest.RelPermalink }}">
<link rel="icon" href="{{ "favicon.png" | relURL }}" type="image/x-icon">

{{- range .Translations }}
  <link rel="alternate" hreflang="{{ default .Language.Lang .Site.LanguageCode }}" href="{{ .Permalink }}" title="{{ partial "docs/title" . }}">
{{- end -}}

<!-- Theme stylesheet -->
{{- $styles := resources.Get "book.scss" | resources.ExecuteAsTemplate "book.scss" . | resources.ToCSS | resources.Minify | resources.Fingerprint }}
<link rel="stylesheet" href="{{ $styles.RelPermalink }}" {{ template "integrity" $styles }}>

{{- if default true .Site.Params.BookSearch -}}
  {{- $searchJSFile := printf "%s.search.js" .Language.Lang }}
  {{- $searchJS := resources.Get "search.js" | resources.ExecuteAsTemplate $searchJSFile . | resources.Minify | resources.Fingerprint }}
  <script defer src="{{ "flexsearch.min.js" | relURL }}"></script>
  <script defer src="{{ $searchJS.RelPermalink }}" {{ template "integrity" $searchJS }}></script>
{{ end -}}

{{- if .Site.Params.BookServiceWorker -}}
  {{- $swJS := resources.Get "sw-register.js" | resources.ExecuteAsTemplate "sw.js" . | resources.Minify | resources.Fingerprint }}
  <script defer src="{{ $swJS.RelPermalink }}" {{ template "integrity" $swJS }}></script>
{{ end -}}

{{- if in .RawContent "{{< graph >}}" -}}
  {{- $graphJS := resources.Get "js/graph.js" | resources.ExecuteAsTemplate "js/graph.js" . | resources.Minify | resources.Fingerprint }}
  <script defer src="{{ "js/vendor/d3.min.js" | relURL }}"></script>
  <script defer src="{{ $graphJS.RelPermalink }}" {{ template "integrity" $graphJS }}></script>
{{ end -}}

{{- template "_internal/google_analytics.html" . -}}

<!-- Firebase SDK (Auth + Firestore) -->
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

<!-- Markdown renderer + Syntax highlighting (client-side) -->
<script src="https://cdn.jsdelivr.net/npm/marked@15.0.7/marked.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.11.1/build/styles/github-dark.min.css" media="(prefers-color-scheme: dark)">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.11.1/build/styles/github.min.css" media="(prefers-color-scheme: light)">
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.11.1/build/highlight.min.js"></script>

<!-- Configure marked.js to match Hugo's heading rendering -->
<script>
(function() {
  if (typeof marked === 'undefined') return;

  var renderer = new marked.Renderer();

  // Match Hugo's render-heading.html: add id + anchor link
  renderer.heading = function(data) {
    var text = data.text || '';
    var depth = data.depth || 1;
    var slug = text.toLowerCase()
      .replace(/<[^>]+>/g, '')
      .replace(/[^\w\s-]/g, '')
      .replace(/\s+/g, '-')
      .replace(/-+/g, '-')
      .replace(/^-|-$/g, '');
    return '<h' + depth + ' id="' + slug + '">\n  ' +
      text + '\n  <a class="anchor" href="#' + slug + '">#</a>\n' +
      '</h' + depth + '>\n';
  };

  marked.setOptions({
    renderer: renderer,
    gfm: true,
    breaks: false
  });

  /**
   * Enable interactive checkboxes in rendered markdown.
   * Removes `disabled` from task list checkboxes and wires up click handlers
   * that toggle `- [ ]` / `- [x]` in the raw note content, then persist.
   *
   * @param {Element} bodyEl — container with rendered HTML
   * @param {Object}  note   — note object with .id and .content
   * @param {Function} onUpdate(updatedNote) — called after successful save
   */
  window.dmEnableCheckboxes = function(bodyEl, note, onUpdate) {
    if (!bodyEl || !note) return;
    var checkboxes = bodyEl.querySelectorAll('li > input[type="checkbox"][disabled]');
    if (!checkboxes.length) return;

    checkboxes.forEach(function(cb, idx) {
      cb.removeAttribute('disabled');
      cb.style.cursor = 'pointer';

      cb.addEventListener('change', function() {
        var raw = note.content || '';
        var cbIndex = 0;
        var newContent = raw.replace(/^([-*]\s+\[)([ xX])(\]\s+)/gm, function(match, pre, check, post) {
          if (cbIndex === idx) {
            cbIndex++;
            return pre + (check === ' ' ? 'x' : ' ') + post;
          }
          cbIndex++;
          return match;
        });

        if (newContent === raw) return; // nothing changed

        note.content = newContent;
        note.updatedAt = Date.now();

        // Persist to Firestore + IndexedDB
        if (window.dmDb && window.dmSync) {
          window.dmDb.collection('notes').doc(note.id).update({
            content: newContent,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }).then(function() {
            return window.dmSync.putNote(note);
          }).then(function() {
            if (onUpdate) onUpdate(note);
          }).catch(function(err) {
            console.error('Checkbox save error:', err);
            // Revert the checkbox visually
            cb.checked = !cb.checked;
          });
        }
      });
    });
  };
})();
</script>

<!-- RSS -->
{{- with .OutputFormats.Get "rss" -}}
  {{ printf `<link rel="%s" type="%s" href="%s" title="%s" />` .Rel .MediaType.Type .Permalink $.Site.Title | safeHTML }}
{{ end -}}

{{ "<!--" | safeHTML }}
Made with Book Theme
https://github.com/alex-shpak/hugo-book
{{ "-->" | safeHTML }}

{{- define "integrity" -}}
  {{- if (urls.Parse .Permalink).Host -}}
    integrity="{{ .Data.Integrity }}" crossorigin="anonymous"
  {{- end -}}
{{- end -}}
